<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas Pro (Demo Estable + Mejoras)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- NO incluimos Leaflet Routing Machine por ahora para simplificar y volver a la estabilidad de v2 -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin=""/> -->
    <style>
        /* --- CSS Esencial (Similar a lo que tenías en v2.0) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; flex-grow: 1; }
        h1, h2, h3 { color: #1A237E; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; box-sizing: border-box; padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:10px;}
        textarea { min-height: 80px; }

        #login-view { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        
        .app-bar { background-color: #1A237E; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap:wrap;}
        
        .btn { padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; margin: 5px; text-decoration: none; display: inline-block; text-align:center;}
        .btn-primary { background-color: #1A237E; color: white; }
        .btn-success { background-color: #4CAF50; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-warning { background-color: #FFC107; color: #333; }
        .btn-danger { background-color: #F44336; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.85em;}
        .btn-xs { padding: 3px 8px; font-size: 0.75em;}


        .item-list .item-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-content { background-color: #fff; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom:10px; border-bottom: 1px solid #eee; margin-bottom:20px; }
        .modal-header h2 { margin:0; color: #1A237E; font-size: 1.4em; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }

        #routeMap { height: 300px; width:100%; border-radius: 8px; margin-bottom: 20px; border:1px solid #ccc;}
        #stopLocationMap { height: 200px; width: 100%; border-radius: 4px; margin-bottom: 15px; border:1px solid #ccc; cursor: pointer; }
        #signature-canvas { width: 100%; height: 150px; background-color: #f8f8f8; cursor: crosshair; display: block; touch-action: none; /* Evita scroll en touch */}
        #podPhotoPreview { max-width:100px; max-height:100px; display:none; margin-top:5px; border:1px solid #eee;}
        #reportModal .modal-content {max-width: 800px;}
        #reportTextPreview { white-space: pre-wrap; background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; }
        /* Otros estilos necesarios */
    </style>
</head>
<body>
    <div id="app-root">
        <div id="login-view" class="container">
             <div class="login-box">
                <h2>INRoute Pro</h2>
                <div id="login-error" class="error-message" style="display:none;"></div>
                <div class="form-group"><label for="username">Usuario:</label><input type="text" id="username" value="demo"></div>
                <div class="form-group"><label for="password">Contraseña:</label><input type="password" id="password" value="demo"></div>
                <button onclick="auth.login()">Iniciar Sesión</button>
            </div>
        </div>
        <div id="app-view" style="display:none;">
            <div class="app-bar">
                <div class="logo">INRoute Pro</div>
                <div class="user-actions"><span id="currentUserDisplay" style="margin-right:15px;"></span><button onclick="auth.logout()">Cerrar Sesión</button></div>
            </div>
            <div class="container" id="main-content-area"></div>
        </div>
    </div>

    <!-- Modales Estáticos -->
    <div id="routeFormModal" class="modal"> /* ... (Contenido del modal como en v3.2) ... */ </div>
    <div id="stopFormModal" class="modal"> /* ... (Contenido del modal como en v3.2, con stopLocationMap) ... */ </div>
    <div id="updateStatusModal" class="modal"> /* ... (Contenido del modal como en v3.2) ... */ </div>
    <div id="podModal" class="modal"> <!-- Contenido del modal POD (incluyendo signature-canvas y podLocationStatus/Info) --> 
        <div class="modal-content">
            <div class="modal-header"><h2>Prueba de Entrega</h2><span class="close-button" onclick="ui.closeModal('podModal');pod.clearPODForm();">×</span></div>
            <p>Parada ID: <span id="podStopIdDisplay"></span></p><input type="hidden" id="podRouteId"><input type="hidden" id="podStopId">
            <div class="form-group"><label for="podSignedBy">Recibido por:</label><input type="text" id="podSignedBy"></div>
            <div class="form-group"><label for="podRut">RUT/ID Receptor:</label><input type="text" id="podRut"></div>
            <div class="form-group">
                <label for="podLocation">Ubicación Entrega:</label>
                <button class="btn btn-secondary btn-sm" onclick="pod.requestLocation()"><span class="icon-pin"></span>Detectar Ubicación</button>
                <div id="podLocationStatus">Pulsa para detectar.</div>
                <div id="podLocationInfo">Lat: N/A, Lon: N/A</div>
            </div>
            <div class="form-group">
                <label for="podPhoto">Adjuntar Foto/Archivo (max 1MB):</label>
                <input type="file" id="podPhoto" accept="image/*,application/pdf">
                <img id="podPhotoPreview" src="#">
            </div>
            <div class="form-group">
                <label>Firma Digital:</label>
                <div class="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
                <button class="btn btn-secondary btn-sm" onclick="pod.clearSignature()">Limpiar Firma</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="ui.closeModal('podModal');pod.clearPODForm();">Cancelar</button>
                <button class="btn btn-success" onclick="handlers.submitPOD()">Guardar POD</button>
            </div>
        </div>
    </div>
    <div id="viewPodModal" class="modal"> /* ... (Contenido del modal como en v3.2) ... */ </div>
    <div id="reportModal" class="modal"> /* ... (Contenido del modal como en v3.2) ... */ </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" crossorigin=""></script> -->

    <script>
    // --- CONFIGURACIÓN Y DATOS INICIALES ---
    const APP_STORAGE_KEY = 'routePlannerPro_Stable'; // Nueva key para esta versión estable
    const AUTH_STORAGE_KEY = 'routePlannerProAuth_Stable';
    const initialSampleData = { /* ... (como en la versión funcional, asegúrate que tenga los campos nuevos si son necesarios para las funciones que se añadirán) ... */
        routes: [ { id: "RUTA001", driver: "Conductor Demo", vehicle: "DEMO01", stops: [ { id: "S_R001-1", address: "Plaza Italia", subAddress: "Providencia", receiverName: "Cliente A", contactPhone:"123", lat: -33.4372, lng: -70.6346, eta: "10:00", windowStart: "09:00", windowEnd: "17:00", status: "Pendiente", pod: null } ] } ], nextRouteId: 2, nextStopIdGlobal: 2
    };

    // Rellenar el HTML de los modales que estaban abreviados (de v3.2, por ejemplo)
    // Ejemplo para routeFormModal
     document.addEventListener('DOMContentLoaded', () => { // Solo si algún modal aún no está completamente en el HTML de arriba
        const routeFormContent = document.querySelector('#routeFormModal .modal-content');
        if (routeFormContent && !routeFormContent.querySelector('.modal-header')) { // Solo llenar si está vacío
            routeFormContent.innerHTML = `<div class="modal-header"><h2 id="routeFormTitle">Crear Ruta</h2><span class="close-button" onclick="ui.closeModal('routeFormModal')">×</span></div> <input type="hidden" id="routeIdEditable"> <div class="form-group"><label for="routeFormDriver">Conductor:</label><input type="text" id="routeFormDriver"></div> <div class="form-group"><label for="routeFormVehicle">Vehículo:</label><input type="text" id="routeFormVehicle"></div> <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('routeFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveRoute()">Guardar</button></div>`;
        }
        // Repetir para OTROS modales si no están completos en el HTML estático de arriba
        // viewPodModal, reportModal, stopFormModal, updateStatusModal...
    });


    // --- LÓGICA DE DATOS (localStorage) ---
    const dataStore = { /* ... (De la v2.0 / v3.1 que funcionaba, con `load()` robusto) ... */ };
    // --- LÓGICA DE AUTENTICACIÓN ---
    const auth = { /* ... (De la v2.0 / v3.1 que funcionaba) ... */ };
    // --- LÓGICA DE UI Y RENDERIZADO ---
    const ui = {
        // ...
        initRouteMap: function(stops) { // ESTA ES LA VERSIÓN SIN RUTEO REAL, SOLO LÍNEAS Y MARCADORES
            const mapContainer = document.getElementById('routeMap');
            if (!mapContainer) return;
            if (this.mapInstance) { this.mapInstance.remove(); this.mapInstance = null; }

            let mapCenter = [-33.45694, -70.64827]; let zoomLevel = 10;
            const validStopsWithCoords = stops.filter(s => typeof s.lat === 'number' && typeof s.lng === 'number');

            if (validStopsWithCoords.length > 0) {
                const bounds = L.latLngBounds(validStopsWithCoords.map(s => [s.lat, s.lng]));
                if (bounds.isValid()) { mapCenter = bounds.getCenter(); }
            }
            this.mapInstance = L.map('routeMap').setView(mapCenter, zoomLevel);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(this.mapInstance);

            if (validStopsWithCoords.length === 0) {
                if(mapContainer) mapContainer.innerHTML = '<div style="text-align:center;padding:20px;">No hay paradas con coordenadas.</div>'; return;
            }
            const stopCoordinates = [];
            validStopsWithCoords.forEach((stop, index) => {
                L.marker([stop.lat, stop.lng]).addTo(this.mapInstance)
                    .bindPopup(`<b>${index + 1}. ${stop.address}</b>`);
                stopCoordinates.push([stop.lat, stop.lng]);
            });
            if (stopCoordinates.length > 1) {
                L.polyline(stopCoordinates, { color: 'red' }).addTo(this.mapInstance); // Línea directa
                this.mapInstance.fitBounds(stopCoordinates, {padding: [30, 30]});
            } else if (stopCoordinates.length === 1) {
                this.mapInstance.setView(stopCoordinates[0], 14);
            }
        },
        initStopLocationMap: function(lat,lng) { /* ... (Igual que v3.2, asegurando invalidateSize) ... */},
        openModal: function(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'block'; else console.error("Modal no encontrado: " + modalId);},
        closeModal: function(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'none';}
        // ... ui.renderRouteList, ui.renderRouteDetail (modificadas para no usar RoutingMachine por ahora)
    };

    // --- LÓGICA DE MANEJADORES DE EVENTOS Y ACCIONES ---
    const handlers = {
        openRouteForm: function(routeIdToEdit = null) { /* ... (lógica de v3.2) ... */ ui.openModal('routeFormModal'); },
        // ... (otros handlers de la v3.1 / v3.2) ...
        openPodModal: function(routeId, stopId) {
            pod.clearPODForm(); 
            document.getElementById('podRouteId').value = routeId; 
            document.getElementById('podStopId').value = stopId; 
            document.getElementById('podStopIdDisplay').textContent = stopId; 
            const stop = dataStore.getStopById(routeId, stopId); 
            document.getElementById('podSignedBy').value = (stop && stop.pod && stop.pod.signedBy) ? stop.pod.signedBy : (stop ? stop.receiverName || '' : '');
            
            ui.openModal('podModal'); // Primero hacer visible
            pod.initSignatureCanvas(); // LUEGO inicializar canvas
        },
        openReportModal: function(routeId) { // (Simplificado, pero asegurar listeners en botones)
            const route = dataStore.getRouteById(routeId); if (!route) return;
            document.getElementById('reportRouteIdDisplay').textContent = route.id;
            let reportText = `REPORTE RUTA: ${route.id}\n... (generar texto) ...`;
            document.getElementById('reportTextPreview').textContent = reportText;
            
            const whatsappBtn = document.getElementById('sendWhatsAppReportBtn');
            const emailBtn = document.getElementById('sendEmailReportBtn');

            // Forma simple de asegurar listeners únicos (podría mejorarse)
            const newWhatsappBtn = whatsappBtn.cloneNode(true); whatsappBtn.parentNode.replaceChild(newWhatsappBtn, whatsappBtn);
            const newEmailBtn = emailBtn.cloneNode(true); emailBtn.parentNode.replaceChild(newEmailBtn, emailBtn);
            
            newWhatsappBtn.addEventListener('click', () => window.open(`https://wa.me/?text=${encodeURIComponent(reportText)}`, '_blank'));
            newEmailBtn.addEventListener('click', () => window.location.href = `mailto:oficina@example.com?subject=${encodeURIComponent('Reporte '+route.id)}&body=${encodeURIComponent(reportText)}`);
            
            ui.openModal('reportModal');
        },
        //... más handlers
    };

    // --- LÓGICA ESPECÍFICA DE PRUEBA DE ENTREGA (POD) ---
    const pod = {
        signatureCanvas: null, signatureCtx: null, drawing: false, lastPos:{x:0, y:0}, isDirty: false,
        currentFilePreviewDataURL:null, currentFileName:null, currentFileType:null, currentGeolocation:null,
        canvasEventListenersAttached: false, // Flag para listeners

        initSignatureCanvas:function(){
            this.signatureCanvas = document.getElementById('signature-canvas');
            if(!this.signatureCanvas) { console.error("Canvas de Firma no encontrado en el DOM."); return; }

            this.signatureCtx = this.signatureCanvas.getContext('2d');
            if(!this.signatureCtx) { console.error("No se pudo obtener el contexto 2D del canvas."); return; }

            this.isDirty = false; // Se ha dibujado algo?

            // Establecer dimensiones basado en el tamaño renderizado del elemento
            const dpr = window.devicePixelRatio || 1;
            const rect = this.signatureCanvas.getBoundingClientRect();

            if (rect.width === 0 || rect.height === 0) {
                console.warn("Dimensiones del canvas son 0x0. Visible?", this.signatureCanvas.offsetParent !== null);
                // Si sigue siendo 0x0, puede que el modal no esté completamente listo. Reintentar es una opción.
                // O verificar que el CSS que lo define permita un tamaño.
                // Para esta demo, asumiremos que `getBoundingClientRect` da dimensiones válidas si el modal está display:block
                return; // Evitar error, la firma no funcionará
            }

            this.signatureCanvas.width = rect.width * dpr;
            this.signatureCanvas.height = rect.height * dpr;
            this.signatureCtx.scale(dpr, dpr);

            this.signatureCtx.lineWidth = 2.5; // Un poco más grueso
            this.signatureCtx.lineCap = 'round';
            this.signatureCtx.strokeStyle = '#222'; // Negro más oscuro
            this.clearSignature(true); // Limpiar sin marcar como dirty

            if (!this.canvasEventListenersAttached) {
                const getCoordinates = (event) => {
                    const canvasRect = this.signatureCanvas.getBoundingClientRect();
                    let clientX, clientY;
                    if (event.touches && event.touches[0]) {
                        clientX = event.touches[0].clientX;
                        clientY = event.touches[0].clientY;
                    } else {
                        clientX = event.clientX;
                        clientY = event.clientY;
                    }
                    return { x: clientX - canvasRect.left, y: clientY - canvasRect.top };
                };

                const mousedownHandler = (e) => {
                    this.drawing = true;
                    this.isDirty = true;
                    const coords = getCoordinates(e);
                    this.lastPos = { x: coords.x, y: coords.y };
                    this.signatureCtx.beginPath(); // Empezar nueva ruta
                    this.signatureCtx.moveTo(this.lastPos.x, this.lastPos.y);
                };
                const mousemoveHandler = (e) => {
                    if (!this.drawing) return;
                    const coords = getCoordinates(e);
                    this.signatureCtx.lineTo(coords.x, coords.y);
                    this.signatureCtx.stroke(); // Dibujar el segmento
                    // No es necesario beginPath/moveTo aquí si es una línea continua
                    this.lastPos = { x: coords.x, y: coords.y }; // Actualizar para el siguiente potencial lineTo
                };
                const mouseupHandler = () => {
                    if (this.drawing) {
                        this.drawing = false;
                        // Opcional: this.signatureCtx.beginPath(); para finalizar explícitamente el path actual.
                    }
                };

                // Mouse events
                this.signatureCanvas.addEventListener('mousedown', mousedownHandler);
                this.signatureCanvas.addEventListener('mousemove', mousemoveHandler);
                this.signatureCanvas.addEventListener('mouseup', mouseupHandler);
                this.signatureCanvas.addEventListener('mouseout', mouseupHandler); // Si sale del canvas, para de dibujar

                // Touch events
                this.signatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); mousedownHandler(e); }, { passive: false });
                this.signatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); mousemoveHandler(e); }, { passive: false });
                this.signatureCanvas.addEventListener('touchend', (e) => { e.preventDefault(); mouseupHandler(e); }, { passive: false });
                this.canvasEventListenersAttached = true;
            }
             // Lógica de carga de archivo igual que v3.2
            document.getElementById('podPhoto').onchange=evt=>{ /* ... */ };
        },
        clearSignature:function(initializing=false){ /* ... (igual que v3.2) ... */},
        isSignatureCanvasEmpty:function(){return !this.isDirty;},
        clearPODForm:function(){ /* ... (igual que v3.2) ... */},
        requestLocation: function() { /* ... (igual que v3.2) ... */ }
    };

    // --- INICIALIZACIÓN ---
    window.onload = () => { /* ... (igual que v3.2, con try-catch y listener para cerrar modales) ... */ };

    // Para que el snippet sea autoejecutable y las funciones se definan globalmente
    // Esto es solo para el entorno de prueba del snippet
    window.dataStore = dataStore;
    window.auth = auth;
    window.ui = ui;
    window.handlers = handlers;
    window.pod = pod;

    // Inicializar
     try { 
        dataStore.load(); 
        auth.checkSession(); 
        window.addEventListener('click', function(event) { if (event.target.classList.contains('modal')) { const modalId = event.target.id; if(modalId && typeof ui.closeModal === 'function') { ui.closeModal(modalId); if (modalId === 'podModal' && typeof pod.clearPODForm === 'function') pod.clearPODForm();}}});
    } catch (error) { 
        console.error("Error fatal durante la inicialización:", error); 
        document.body.innerHTML = `<div style="padding:20px;text-align:center;color:red;"><h1>Error Crítico</h1><p>Ocurrió un error. Intente borrar datos de navegación.</p><pre>${error.stack||error}</pre></div>`; 
    }

    </script>
</body>
</html>
