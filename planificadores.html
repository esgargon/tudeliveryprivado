<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas Pro v3.1 (Demo)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin=""/>
    <style>
        /* CSS (Mayormente igual a la v3, peque√±os ajustes si es necesario) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; flex-grow: 1; }
        h1, h2, h3 { color: #1A237E; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; box-sizing: border-box; padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:10px;}
        textarea { min-height: 80px; }

        #login-view { display: none; /* Oculto por JS hasta que se decida mostrar */ flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        .login-box h2 { text-align:center; margin-top:0; }
        .login-box button { background-color: #1A237E; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 1em; width: 100%; }
        .login-box button:hover { background-color: #283593; }
        .error-message { color: #D32F2F; font-size:0.9em; margin-bottom:10px; text-align:center;}

        .app-bar { background-color: #1A237E; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap:wrap; }
        .app-bar .logo { font-size: 1.5em; font-weight: bold; margin-bottom: 5px;}
        .app-bar .user-actions button { background-color: #FFC107; color: #333; border: none; padding: 8px 15px; border-radius: 4px; font-size:0.9em; }
        .app-bar .user-actions button:hover { background-color: #FFB300; }
        
        .btn { padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; margin: 5px; text-decoration: none; display: inline-block; text-align:center;}
        .btn-primary { background-color: #1A237E; color: white; } .btn-primary:hover { background-color: #283593; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #4CAF50; color: white; } .btn-success:hover { background-color: #45a049; }
        .btn-danger { background-color: #F44336; color: white; } .btn-danger:hover { background-color: #D32F2F; }
        .btn-warning { background-color: #FFC107; color: #333; } .btn-warning:hover { background-color: #FFB300; }
        .btn-info { background-color: #17a2b8; color: white; } .btn-info:hover { background-color: #138496; }
        .btn-sm { padding: 5px 10px; font-size: 0.85em;} .btn-xs { padding: 3px 8px; font-size: 0.75em;}

        .item-list .item-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s ease; }
        .item-list .item-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-card h3 { margin-top: 0; color: #1A237E; }
        .item-actions button, .item-actions a { margin-right: 5px; margin-bottom: 5px; }

        .route-detail-header { background-color: #1A237E; color: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap;}
        .stops-list { list-style: none; padding: 0; background-color: white; border: 1px solid #ddd; border-top: none; margin-top:0; border-radius: 0 0 8px 8px; }
        .stop-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; align-items: flex-start; }
        .stop-item:last-child { border-bottom: none; }
        .stop-number { font-weight: bold; color: #1A237E; margin-right: 15px; font-size: 1.2em; width:30px; line-height:1.2; }
        .stop-info { flex-grow: 1; min-width:250px; margin-bottom:10px;}
        .stop-address { font-weight: bold; font-size: 1.1em; }
        .stop-sub-address, .stop-contact-info { color: #555; font-size: 0.9em; margin-top: 3px;}
        .stop-actions-main { margin-top:8px; } .stop-actions-main .btn { margin-right:5px;}
        .stop-eta-window { text-align: right; min-width: 120px; flex-basis:120px; margin-left:auto;}
        .pod-thumbnail { max-width: 60px; max-height: 60px; border:1px solid #ccc; margin-top:5px; cursor:pointer; vertical-align: middle; }
        .stop-status-display { font-size:0.85em; color: #555; margin-top:5px; } /* Cambio de ID a clase */
        .pod-display-label { font-size:0.85em; color: #555;}

        #routeMapContainer { position: relative; margin-bottom: 20px; }
        #routeMap { height: 350px; width:100%; border-radius: 8px; border:1px solid #ccc;}
        .map-placeholder-text { text-align:center; padding:20px; color:#777; font-style:italic;}
        .leaflet-routing-container { background-color: rgba(255,255,255,0.9); border-radius: 5px; padding: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 1px 5px rgba(0,0,0,0.65);}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-content { background-color: #fff; margin: 2% auto; /* Aumentado margen superior/inferior */ padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom:10px; border-bottom: 1px solid #eee; margin-bottom:20px; }
        .modal-header h2 { margin:0; color: #1A237E; font-size: 1.4em; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; } .close-button:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-row { display:flex; gap:15px; flex-wrap:wrap;}
        .form-row .form-group { flex:1; min-width: calc(50% - 8px); }
        .modal-actions { margin-top: 20px; text-align: right; } .modal-actions .btn { margin-left:10px; }
        #stopLocationMap { height: 200px; width: 100%; border-radius: 4px; margin-bottom: 15px; border:1px solid #ccc; cursor: pointer; }
        .map-instructions { font-size:0.85em; color: #777; margin-top: -10px; margin-bottom:10px; }
        #podLocationStatus { font-size:0.9em; margin-top:5px; color:#555; }
        #podLocationInfo { font-size:0.8em; color: #777;}
        .signature-pad-container { border: 1px dashed #ccc; margin-bottom: 10px; position: relative; }
        #signature-canvas { width: 100%; height: 150px; background-color: #f8f8f8; cursor: crosshair; display: block; touch-action: none;}
        #podPhotoPreview { max-width:100px; max-height:100px; display:none; margin-top:5px; border:1px solid #eee;}
        .icon-truck::before { content: "üöö"; margin-right: 5px;}
        .icon-pin::before { content: "üìç"; margin-right: 3px;}
        #reportModal .modal-content {max-width: 800px;}
        #reportTextPreview { white-space: pre-wrap; background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; }
        @media (max-width: 768px) { .form-row .form-group { min-width: 100%; } .stop-item { flex-direction: column; align-items: stretch; } .stop-eta-window { text-align: left; margin-top:10px; margin-left:0; } .app-bar { flex-direction: column; gap:10px;} }
        @media (max-width: 600px) { .container { padding: 0 10px;} .modal-content { width: 95%; margin-top: 10px; margin-bottom: 10px; padding:15px; } .modal-header h2 { font-size: 1.2em; } }
    </style>
</head>
<body>
    <div id="app-root">
        <div id="login-view" class="container"> <!-- Contenido llenado por JS --> </div>
        <div id="app-view" style="display:none;"> <!-- Siempre display:none inicial -->
            <div class="app-bar"> <!-- Contenido llenado por JS --> </div>
            <div class="container" id="main-content-area"> <!-- Contenido din√°mico aqu√≠ --> </div>
        </div>
    </div>

    <!-- --- MODALES --- -->
    <div id="routeFormModal" class="modal"><div class="modal-content"></div></div>
    <div id="stopFormModal" class="modal"><div class="modal-content"></div></div>
    <div id="updateStatusModal" class="modal"><div class="modal-content"></div></div>
    <div id="podModal" class="modal"><div class="modal-content"></div></div>
    <div id="viewPodModal" class="modal"><div class="modal-content"></div></div>
    <div id="reportModal" class="modal"><div class="modal-content"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" crossorigin=""></script>

    <script>
    const APP_STORAGE_KEY = 'routePlannerProData_v3_1'; // Nueva clave para forzar reset si es necesario
    const AUTH_STORAGE_KEY = 'routePlannerProAuth_v3_1';
    const initialSampleData = {
        routes: [ /* ... (igual que v3) ... */ ],
        nextRouteId: 2, nextStopIdGlobal: 3
    };
     initialSampleData.routes = [
            {
                id: "RUTA001", driver: "Conductor Demo", vehicle: "DEMO01",
                stops: [
                    { id: "S_R001-1", address: "Plaza Baquedano", subAddress: "Santiago Centro", receiverName: "Juan Ejemplo", contactPhone: "987654321", lat: -33.4372, lng: -70.6346, eta: "09:00", windowStart: "09:00", windowEnd: "12:00", status: "Pendiente", statusComment: null, pod: null },
                    { id: "S_R001-2", address: "Costanera Center", subAddress: "Providencia", receiverName: "Ana Muestra", contactPhone: "912345678", lat: -33.4175, lng: -70.6064, eta: "10:30", windowStart: "10:00", windowEnd: "14:00", status: "Pendiente", statusComment: null, pod: null },
                ]
            }
        ];


    // --- Llenado de HTML Est√°tico de Modales y Vistas Base ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-view').innerHTML = `
            <div class="login-box">
                <h2><span class="icon-truck"></span> INRoute Pro</h2>
                <div id="login-error" class="error-message" style="display:none;"></div>
                <div class="form-group"><label for="username">Usuario:</label><input type="text" id="username" value="demo"></div>
                <div class="form-group"><label for="password">Contrase√±a:</label><input type="password" id="password" value="demo"></div>
                <button onclick="auth.login()">Iniciar Sesi√≥n</button>
            </div>`;
        document.querySelector('#app-view .app-bar').innerHTML = `
            <div class="logo"><span class="icon-truck"></span> INRoute Pro</div>
            <div class="user-actions"><span id="currentUserDisplay" style="margin-right:15px;"></span><button onclick="auth.logout()">Cerrar Sesi√≥n</button></div>`;
        
        // Contenido de Modales
        document.querySelector('#routeFormModal .modal-content').innerHTML = `
            <div class="modal-header"><h2 id="routeFormTitle">Crear Ruta</h2><span class="close-button" onclick="ui.closeModal('routeFormModal')">√ó</span></div>
            <input type="hidden" id="routeIdEditable"><div class="form-group"><label for="routeFormDriver">Conductor:</label><input type="text" id="routeFormDriver"></div>
            <div class="form-group"><label for="routeFormVehicle">Veh√≠culo:</label><input type="text" id="routeFormVehicle"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('routeFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveRoute()">Guardar</button></div>`;

        document.querySelector('#stopFormModal .modal-content').innerHTML = `
            <div class="modal-header"><h2 id="stopFormTitle">A√±adir Parada</h2><span class="close-button" onclick="ui.closeModal('stopFormModal')">√ó</span></div>
            <input type="hidden" id="stopFormRouteId"><input type="hidden" id="stopIdEditable">
            <div class="form-group"><label for="stopFormAddress">Direcci√≥n Principal:</label><input type="text" id="stopFormAddress"></div>
            <div class="form-group"><label for="stopFormSubAddress">Detalles Adicionales:</label><input type="text" id="stopFormSubAddress"></div>
            <div class="form-row"><div class="form-group"><label for="stopFormReceiverName">Nombre Receptor:</label><input type="text" id="stopFormReceiverName"></div><div class="form-group"><label for="stopFormContactPhone">Tel√©fono Contacto:</label><input type="tel" id="stopFormContactPhone"></div></div>
            <div class="form-group"><label><span class="icon-pin"></span>Ubicaci√≥n en Mapa:</label><div id="stopLocationMap"></div><p class="map-instructions">Clic/Arrastrar para ubicar.</p><div class="form-row"><div class="form-group"><label for="stopFormLat">Latitud:</label><input type="number" step="any" id="stopFormLat"></div><div class="form-group"><label for="stopFormLng">Longitud:</label><input type="number" step="any" id="stopFormLng"></div></div></div>
            <div class="form-row"><div class="form-group"><label for="stopFormETA">ETA:</label><input type="time" id="stopFormETA"></div><div class="form-group"><label for="stopFormWindowStart">Desde:</label><input type="time" id="stopFormWindowStart"></div><div class="form-group"><label for="stopFormWindowEnd">Hasta:</label><input type="time" id="stopFormWindowEnd"></div></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('stopFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveStop()">Guardar</button></div>`;
            
        document.querySelector('#updateStatusModal .modal-content').innerHTML = `
            <div class="modal-header"><h2>Actualizar Estado</h2><span class="close-button" onclick="ui.closeModal('updateStatusModal')">√ó</span></div>
            <p>Parada ID: <span id="statusStopIdDisplay"></span></p><input type="hidden" id="statusUpdateRouteId"><input type="hidden" id="statusUpdateStopId">
            <div class="status-options"><label><input type="radio" name="statusOption" value="Pendiente"> Pendiente</label><label><input type="radio" name="statusOption" value="Entregado"> Entregado</label><label><input type="radio" name="statusOption" value="No Entregado"> No Entregado</label><label><input type="radio" name="statusOption" value="Parcial"> Parcial</label></div>
            <textarea id="statusReason" placeholder="Raz√≥n/Comentario"></textarea>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('updateStatusModal')">Cancelar</button><button class="btn btn-success" onclick="handlers.submitStatusUpdate()">Aceptar</button></div>`;

        document.querySelector('#podModal .modal-content').innerHTML = `
            <div class="modal-header"><h2>Prueba de Entrega</h2><span class="close-button" onclick="ui.closeModal('podModal');pod.clearPODForm();">√ó</span></div>
            <p>Parada ID: <span id="podStopIdDisplay"></span></p><input type="hidden" id="podRouteId"><input type="hidden" id="podStopId">
            <div class="form-group"><label for="podSignedBy">Recibido por:</label><input type="text" id="podSignedBy"></div>
            <div class="form-group"><label for="podRut">RUT/ID Receptor:</label><input type="text" id="podRut"></div>
            <div class="form-group"><label for="podLocation">Ubicaci√≥n Entrega:</label><button class="btn btn-secondary btn-sm" onclick="pod.requestLocation()"><span class="icon-pin"></span>Detectar Ubicaci√≥n</button><div id="podLocationStatus"></div><div id="podLocationInfo">Lat: N/A, Lon: N/A</div></div>
            <div class="form-group"><label for="podPhoto">Adjuntar Foto/Archivo:</label><input type="file" id="podPhoto" accept="image/*,application/pdf"><img id="podPhotoPreview" src="#"></div>
            <div class="form-group"><label>Firma Digital:</label><div class="signature-pad-container"><canvas id="signature-canvas"></canvas></div><button class="btn btn-secondary btn-sm" onclick="pod.clearSignature(false)">Limpiar</button></div>
            <div class="modal-actions"><button class="btn btn-danger" onclick="ui.closeModal('podModal');pod.clearPODForm();">Cancelar</button><button class="btn btn-success" onclick="handlers.submitPOD()">Guardar POD</button></div>`;

        document.querySelector('#viewPodModal .modal-content').innerHTML = `
            <div class="modal-header"><h2>Detalle POD</h2><span class="close-button" onclick="ui.closeModal('viewPodModal')">√ó</span></div>
            <p>Parada ID: <span id="viewPodStopIdDisplay"></span></p><div id="viewPodContent"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('viewPodModal')">Cerrar</button></div>`;

        document.querySelector('#reportModal .modal-content').innerHTML = `
             <div class="modal-header"><h2>Reporte Ruta Finalizada</h2><span class="close-button" onclick="ui.closeModal('reportModal')">√ó</span></div>
             <h4>Ruta: <span id="reportRouteIdDisplay"></span></h4><p>Resumen de la ruta para enviar.</p>
             <div id="reportTextPreview" style="margin-bottom:15px;"></div>
             <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('reportModal')">Cancelar</button><button id="sendWhatsAppReportBtn" class="btn btn-success">WhatsApp</button><button id="sendEmailReportBtn" class="btn btn-info">Correo</button></div>`;
    });


    // --- L√ìGICA DE DATOS (localStorage) ---
    const dataStore = {
        _data: null,
        load: function() {
            try {
                const storedData = localStorage.getItem(APP_STORAGE_KEY);
                if (storedData) {
                    this._data = JSON.parse(storedData);
                    // Migraci√≥n/Asegurar campos para datos de versiones anteriores (si es necesario)
                    if (this._data && this._data.routes) { // Verificar que la estructura base exista
                        this._data.routes.forEach(route => {
                           if(route.stops){ // Verificar que stops exista
                             route.stops.forEach(stop => {
                                if (stop.receiverName === undefined) stop.receiverName = '';
                                if (stop.contactPhone === undefined) stop.contactPhone = '';
                                if (stop.pod && stop.pod.geolocation === undefined) stop.pod.geolocation = null;
                                else if (stop.pod === undefined) stop.pod = null; // Asegurar que pod exista o sea null
                                if (stop.statusComment === undefined) stop.statusComment = null;
                             });
                           } else { route.stops = []; } // Inicializar stops si no existe
                        });
                    } else { // Si la estructura es muy diferente, reiniciar
                         throw new Error("Datos incompatibles encontrados.");
                    }
                } else {
                    this._data = JSON.parse(JSON.stringify(initialSampleData)); // Deep copy
                    this.save();
                }
            } catch (error) {
                console.warn("Error al cargar datos de localStorage, reiniciando con datos de ejemplo:", error);
                localStorage.removeItem(APP_STORAGE_KEY); // Limpiar datos corruptos
                this._data = JSON.parse(JSON.stringify(initialSampleData));
                this.save();
            }
        },
        save: function() { /* ... igual que v3 ... */ localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(this._data)); },
        getRoutes: function() { return this._data.routes; },
        getRouteById: function(routeId) { return this._data.routes.find(r => r.id === routeId); },
        addRoute: function(driver, vehicle) { /* ... igual que v3 ... */  const newRouteIdNumeric = this._data.nextRouteId++; const newRoute = { id: `RUTA${String(newRouteIdNumeric).padStart(3, '0')}`, driver, vehicle, stops: [] }; this._data.routes.push(newRoute); this.save(); return newRoute; },
        updateRoute: function(routeId, driver, vehicle) { /* ... igual que v3 ... */ const route = this.getRouteById(routeId); if (route) { route.driver = driver; route.vehicle = vehicle; this.save(); } },
        deleteRoute: function(routeId) { /* ... igual que v3 ... */ this._data.routes = this._data.routes.filter(r => r.id !== routeId); this.save(); },
        addStopToRoute: function(routeId, stopData) { /* ... igual que v3 ... */  const route = this.getRouteById(routeId); if (route) { const newStopIdNumeric = this._data.nextStopIdGlobal++; const routePrefix = routeId.replace('RUTA','_R'); const newStop = { id: `S${routePrefix}-${newStopIdNumeric}`, ...stopData, status: "Pendiente", statusComment: null, pod: null }; route.stops.push(newStop); this.save(); return newStop; } },
        updateStop: function(routeId, stopId, stopUpdates) { /* ... igual que v3 ... */ const route = this.getRouteById(routeId); if (route) { const stop = route.stops.find(s => s.id === stopId); if (stop) { Object.assign(stop, stopUpdates); this.save(); } } },
        deleteStopFromRoute: function(routeId, stopId) { /* ... igual que v3 ... */ const route = this.getRouteById(routeId); if (route) { route.stops = route.stops.filter(s => s.id !== stopId); this.save(); } },
        getStopById: function(routeId, stopId) { /* ... igual que v3 ... */ const route = this.getRouteById(routeId); return route ? route.stops.find(s => s.id === stopId) : null; }
    };

    // --- L√ìGICA DE AUTENTICACI√ìN ---
    const auth = {
        currentUser: null,
        login: function() { /* ... igual que v3 ... */ const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorDiv = document.getElementById('login-error'); errorDiv.style.display = 'none'; if (username === 'demo' && password === 'demo') { this.currentUser = username; localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ username: this.currentUser })); this.showAppView(); } else { errorDiv.textContent = 'Usuario o contrase√±a incorrectos.'; errorDiv.style.display = 'block'; } },
        logout: function() { /* ... igual que v3 ... */ this.currentUser = null; localStorage.removeItem(AUTH_STORAGE_KEY); this.showLoginView(); },
        checkSession: function() { /* ... igual que v3 ... */ const session = localStorage.getItem(AUTH_STORAGE_KEY); if (session) { try { this.currentUser = JSON.parse(session).username; this.showAppView(); } catch(e){ localStorage.removeItem(AUTH_STORAGE_KEY); this.showLoginView(); /* Sesi√≥n corrupta */ } } else { this.showLoginView(); } },
        showLoginView: function() { document.getElementById('login-view').style.display = 'flex'; document.getElementById('app-view').style.display = 'none';},
        showAppView: function() { document.getElementById('login-view').style.display = 'none'; document.getElementById('app-view').style.display = 'block'; document.getElementById('currentUserDisplay').textContent = `Usuario: ${this.currentUser}`; ui.renderRouteList(); }
    };

    // --- L√ìGICA DE UI Y RENDERIZADO ---
    const ui = { /* ... (currentRouteId, mapInstance, etc. igual) ... */
        renderRouteList: function() { /* ... (mayormente igual que v3) ... */ const routes = dataStore.getRoutes(); let content = `...`; mainContentArea = document.getElementById('main-content-area'); content = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Mis Rutas</h2><button class="btn btn-primary" onclick="handlers.openRouteForm()">+ Nueva Ruta</button></div><div class="item-list">`; if (routes.length === 0) { content += '<p>No hay rutas creadas.</p>'; } else { routes.forEach(route => { content += `<div class="item-card"><h3>${route.id}</h3><p><span class="icon-truck"></span> Conductor: ${route.driver || 'N/A'} | Veh√≠culo: ${route.vehicle || 'N/A'}</p><p>Paradas: ${route.stops.length}</p><div class="item-actions"><button class="btn btn-primary btn-sm" onclick="ui.renderRouteDetail('${route.id}')">Ver Detalles</button><button class="btn btn-warning btn-sm" onclick="handlers.openRouteForm('${route.id}')">Editar</button><button class="btn btn-danger btn-sm" onclick="handlers.deleteRoute('${route.id}')">Eliminar</button></div></div>`;}); } content += '</div>'; mainContentArea.innerHTML = content; },
        renderRouteDetail: function(routeId) {
            this.currentRouteId = routeId; const route = dataStore.getRouteById(routeId);
            if (!route) { this.renderRouteList(); return; }
            
            let stopsHtml = '';
            if (route.stops.length === 0) { stopsHtml = '<li class="stop-item" style="justify-content:center; padding:20px;">No hay paradas.</li>'; }
            else {
                 route.stops.forEach((stop, index) => {
                    const podIcon = stop.pod ? `<img src="${(stop.pod.signature || (stop.pod.fileType && stop.pod.fileType.startsWith('image/') ? stop.pod.fileDataURL : null) || 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==')}" alt="POD" class="pod-thumbnail" onclick="handlers.openViewPodModal('${route.id}', '${stop.id}')">` : 'No'; // Placeholder si no hay imagen/firma
                    stopsHtml += `
                    <li class="stop-item">
                        <span class="stop-number">${index + 1}</span>
                        <div class="stop-info">
                            <div class="stop-address">${stop.address} ${stop.lat && stop.lng ? `(${stop.lat.toFixed(4)}, ${stop.lng.toFixed(4)})` : ''}</div>
                            <div class="stop-sub-address">${stop.subAddress || ''}</div>
                            <div class="stop-contact-info">Para: ${stop.receiverName || 'N/A'} / Tel: ${stop.contactPhone || 'N/A'}</div>
                            <div class="stop-status-display"> Estado: ${stop.status || 'Pendiente'} ${stop.statusComment ? '('+stop.statusComment+')': ''}</div>
                            <div class="pod-display-label">POD: ${podIcon}</div>
                            <div class="stop-actions-main">
                                <button onclick="handlers.openUpdateStatusModal('${route.id}','${stop.id}')" class="btn btn-warning btn-xs">Estado</button>
                                <button onclick="handlers.openPodModal('${route.id}','${stop.id}')" class="btn btn-success btn-xs">POD</button>
                                <button onclick="handlers.openStopForm('${route.id}', '${stop.id}')" class="btn btn-secondary btn-xs">Editar</button>
                                <button onclick="handlers.deleteStop('${route.id}', '${stop.id}')" class="btn btn-danger btn-xs">Borrar</button>
                            </div>
                        </div>
                        <div class="stop-eta-window">
                            ${stop.eta ? `<span class="stop-eta">ETA ${stop.eta}</span>` : ''}
                            ${stop.windowStart && stop.windowEnd ? `<span class="stop-window">${stop.windowStart} - ${stop.windowEnd}</span>` : ''}
                        </div>
                    </li>`;
                });
            }
            const isAnyStopPending = route.stops.some(stop => stop.status === "Pendiente");
            const mainContentArea = document.getElementById('main-content-area');
            mainContentArea.innerHTML = `
                <div style="margin-bottom:15px;"><button class="btn btn-secondary btn-sm" onclick="ui.renderRouteList()">‚Üê Volver a Rutas</button></div>
                <div id="routeMapContainer"><div id="routeMap"></div></div>
                <div class="route-detail-card">
                   <div class="route-detail-header">
                        <div class="driver-info">${route.driver} (${route.id})</div>
                        <div class="vehicle-info"> ${route.vehicle} </div>
                   </div>
                    <ul class="stops-list">${stopsHtml}</ul>
                    <div style="padding: 15px; background-color:white; border: 1px solid #ddd; border-top:none; border-radius:0 0 8px 8px; text-align:center; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                       <button class="btn btn-success" onclick="handlers.openStopForm('${route.id}')">+ A√±adir Parada</button>
                       <button class="btn btn-info" onclick="handlers.openReportModal('${route.id}')" ${isAnyStopPending ? 'disabled title="Complete todas las paradas para reportar"' : ''}>Finalizar y Reportar Ruta</button>
                    </div>
                </div>`;
            this.initRouteMapWithRouting(route.stops);
        },
        initRouteMapWithRouting: function(stops) { /* ... igual que v3 ... */ const mapContainer = document.getElementById('routeMap'); if (!mapContainer || !L.Routing) { /*...*/ return; } if (this.mapInstance) this.mapInstance.remove(); let mapCenter = [-33.45694, -70.64827]; let zoomLevel = 10; const validStopsWithCoords = stops.filter(s => typeof s.lat === 'number' && typeof s.lng === 'number'); if (validStopsWithCoords.length > 0) { const bounds = L.latLngBounds(validStopsWithCoords.map(s => [s.lat, s.lng])); if (bounds.isValid()) mapCenter = bounds.getCenter(); } this.mapInstance = L.map('routeMap').setView(mapCenter, zoomLevel); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'}).addTo(this.mapInstance); if (validStopsWithCoords.length < 2) { /* ... */ return; } const waypoints = validStopsWithCoords.map(stop => L.latLng(stop.lat, stop.lng)); this.routingControl = L.Routing.control({waypoints, routeWhileDragging: false, showAlternatives: false, lineOptions: { styles: [{color: 'blue', opacity: 0.8, weight: 5}] }, createMarker: (i, wp, n) => L.marker(wp.latLng, {title: `${i+1}. ${validStopsWithCoords[i].address}`}).bindPopup(`<b>${i+1}. ${validStopsWithCoords[i].address}</b>`), router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}), fitSelectedRoutes: 'smart'}).addTo(this.mapInstance); this.routingControl.on('routingerror', e => { console.error("Error ruteo:", e.error); mapContainer.innerHTML += '<p style="color:red;">Error calculando ruta.</p>'; });},
        initStopLocationMap: function(lat, lng) { /* ... igual que v3, asegurarse de invalidateSize ... */ const mapDiv = document.getElementById('stopLocationMap'); if (!mapDiv) return; if (this.stopLocationMapInstance) this.stopLocationMapInstance.remove(); const initialCoords = (lat != null && lng != null) ? [lat, lng] : [-33.45694, -70.64827]; const initialZoom = (lat != null && lng != null) ? 15 : 10; this.stopLocationMapInstance = L.map(mapDiv).setView(initialCoords, initialZoom); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.stopLocationMapInstance); if (this.stopLocationMarker) this.stopLocationMarker.remove(); this.stopLocationMarker = L.marker(initialCoords, { draggable: true }).addTo(this.stopLocationMapInstance); this.stopLocationMarker.on('dragend', e => { const pos = e.target.getLatLng(); document.getElementById('stopFormLat').value = pos.lat.toFixed(6); document.getElementById('stopFormLng').value = pos.lng.toFixed(6);}); this.stopLocationMapInstance.on('click', e => { this.stopLocationMarker.setLatLng(e.latlng); document.getElementById('stopFormLat').value = e.latlng.lat.toFixed(6); document.getElementById('stopFormLng').value = e.latlng.lng.toFixed(6);}); setTimeout(() => { if(this.stopLocationMapInstance) this.stopLocationMapInstance.invalidateSize();}, 250); },
        openModal: function(modalId) { document.getElementById(modalId).style.display = 'block'; },
        closeModal: function(modalId) { document.getElementById(modalId).style.display = 'none'; }
    };

    // --- L√ìGICA DE MANEJADORES DE EVENTOS Y ACCIONES ---
    const handlers = { /* ... (saveRoute, deleteRoute, saveStop, etc. igual que v3) ... */
        openRouteForm: function(routeIdToEdit = null) { /* ... */ document.getElementById('routeFormModal').style.display = 'block'; },
        saveRoute: function() { /* ... */ ui.renderRouteList(); },
        deleteRoute: function(routeId) { if(confirm(`Eliminar ruta ${routeId}?`)) {dataStore.deleteRoute(routeId); ui.renderRouteList();} },
        openStopForm: function(routeId, stopIdToEdit = null) { const latInput = document.getElementById('stopFormLat'); const lngInput = document.getElementById('stopFormLng'); const title = document.getElementById('stopFormTitle'); const addr = document.getElementById('stopFormAddress'), subAddr = document.getElementById('stopFormSubAddress'), recName = document.getElementById('stopFormReceiverName'), conPhone = document.getElementById('stopFormContactPhone'), eta = document.getElementById('stopFormETA'), ws = document.getElementById('stopFormWindowStart'), we = document.getElementById('stopFormWindowEnd'); document.getElementById('stopFormRouteId').value = routeId; document.getElementById('stopIdEditable').value = stopIdToEdit || ''; if (stopIdToEdit) { const stop = dataStore.getStopById(routeId, stopIdToEdit); title.textContent = `Editar Parada ${stop.id}`; addr.value=stop.address; subAddr.value=stop.subAddress||''; recName.value=stop.receiverName||''; conPhone.value=stop.contactPhone||''; latInput.value=stop.lat||''; lngInput.value=stop.lng||''; eta.value=stop.eta||''; ws.value=stop.windowStart||''; we.value=stop.windowEnd||''; ui.initStopLocationMap(stop.lat, stop.lng); } else { title.textContent=`A√±adir Parada a ${routeId}`; addr.value=''; subAddr.value=''; recName.value=''; conPhone.value=''; latInput.value=''; lngInput.value=''; eta.value=''; ws.value=''; we.value=''; ui.initStopLocationMap(null, null); } ui.openModal('stopFormModal'); setTimeout(() => { if(ui.stopLocationMapInstance) ui.stopLocationMapInstance.invalidateSize();}, 50); },
        saveStop: function() { const routeId = document.getElementById('stopFormRouteId').value, stopId = document.getElementById('stopIdEditable').value; const stopData = {address:document.getElementById('stopFormAddress').value, subAddress:document.getElementById('stopFormSubAddress').value, receiverName:document.getElementById('stopFormReceiverName').value, contactPhone:document.getElementById('stopFormContactPhone').value, lat:parseFloat(document.getElementById('stopFormLat').value)||null, lng:parseFloat(document.getElementById('stopFormLng').value)||null, eta:document.getElementById('stopFormETA').value, windowStart:document.getElementById('stopFormWindowStart').value, windowEnd:document.getElementById('stopFormWindowEnd').value }; if(!stopData.address.trim()){alert("Direcci√≥n obligatoria.");return;} if(stopId)dataStore.updateStop(routeId, stopId, stopData);else dataStore.addStopToRoute(routeId,stopData); ui.closeModal('stopFormModal');ui.renderRouteDetail(routeId);},
        deleteStop: function(routeId, stopId) { if(confirm(`Eliminar parada ${stopId}?`)){dataStore.deleteStopFromRoute(routeId,stopId); ui.renderRouteDetail(routeId);} },
        openUpdateStatusModal: function(routeId, stopId) { /* ... igual que v3 ... */ const stop=dataStore.getStopById(routeId,stopId); document.getElementById('statusUpdateRouteId').value=routeId; document.getElementById('statusUpdateStopId').value=stopId; document.getElementById('statusStopIdDisplay').textContent=stopId; if(stop && stop.status) document.querySelector(`#updateStatusModal input[name="statusOption"][value="${stop.status}"]`).checked=true; else document.querySelector(`#updateStatusModal input[name="statusOption"][value="Pendiente"]`).checked=true; document.getElementById('statusReason').value=stop?stop.statusComment||'':''; ui.openModal('updateStatusModal');},
        submitStatusUpdate: function() { /* ... igual que v3 ... */ const routeId=document.getElementById('statusUpdateRouteId').value, stopId=document.getElementById('statusUpdateStopId').value; const radio=document.querySelector('#updateStatusModal input[name="statusOption"]:checked'); const reason=document.getElementById('statusReason').value.trim(); if(radio){dataStore.updateStop(routeId,stopId,{status:radio.value, statusComment:reason});ui.closeModal('updateStatusModal');ui.renderRouteDetail(routeId);}else alert("Selecciona estado");},
        openPodModal: function(routeId, stopId) { /* ... igual que v3 ... */ pod.clearPODForm(); document.getElementById('podRouteId').value=routeId; document.getElementById('podStopId').value=stopId; document.getElementById('podStopIdDisplay').textContent=stopId; const stop=dataStore.getStopById(routeId,stopId); document.getElementById('podSignedBy').value = (stop && stop.pod && stop.pod.signedBy) ? stop.pod.signedBy : (stop ? stop.receiverName || '' : ''); pod.initSignatureCanvas(); ui.openModal('podModal'); },
        submitPOD: function() { /* ... igual que v3, ya inclu√≠a pod.currentGeolocation ... */ const routeId=document.getElementById('podRouteId').value, stopId=document.getElementById('podStopId').value; const podData={signedBy:document.getElementById('podSignedBy').value.trim(), rut:document.getElementById('podRut').value.trim(), signature:pod.isSignatureCanvasEmpty()?null:pod.signatureCanvas.toDataURL('image/png'), fileDataURL:pod.currentFilePreviewDataURL,fileName:pod.currentFileName,fileType:pod.currentFileType, geolocation:pod.currentGeolocation }; if(!podData.signedBy && !podData.signature && !podData.fileDataURL){alert("Complete al menos un campo POD.");return;} dataStore.updateStop(routeId,stopId,{pod:podData,status:"Entregado (POD)"});ui.closeModal('podModal');pod.clearPODForm();ui.renderRouteDetail(routeId);},
        openViewPodModal: function(routeId, stopId) { /* ... igual que v3 ... */ const stop=dataStore.getStopById(routeId,stopId); document.getElementById('viewPodStopIdDisplay').textContent=stopId; const contentDiv=document.getElementById('viewPodContent'); contentDiv.innerHTML = ''; if(stop && stop.pod){ let podHtml=`<p><strong>Recibido por:</strong> ${stop.pod.signedBy||'N/A'}</p><p><strong>RUT/ID:</strong> ${stop.pod.rut||'N/A'}</p>`; if(stop.pod.geolocation)podHtml+=`<p><strong>Ubic. POD:</strong> Lat ${stop.pod.geolocation.lat.toFixed(5)}, Lon ${stop.pod.geolocation.lng.toFixed(5)} (Precisi√≥n: ${stop.pod.geolocation.accuracy}m)</p>`; if(stop.pod.signature)podHtml+=`<h4>Firma:</h4><img src="${stop.pod.signature}" style="max-width:100%; border:1px solid #ccc;">`; if(stop.pod.fileDataURL){if(stop.pod.fileType.startsWith('image/'))podHtml+=`<h4>Adjunto:</h4><img src="${stop.pod.fileDataURL}" style="max-width:100%; border:1px solid #ccc;">`; else podHtml+=`<h4>Adjunto:</h4><p><a href="${stop.pod.fileDataURL}" download="${stop.pod.fileName||'archivo'}">Descargar ${stop.pod.fileName||'archivo'}</a></p>`;} contentDiv.innerHTML=podHtml; } else contentDiv.innerHTML="<p>No hay POD.</p>"; ui.openModal('viewPodModal');},
        openReportModal: function(routeId) { /* ... igual que v3 ... */ const route = dataStore.getRouteById(routeId);if (!route) return; document.getElementById('reportRouteIdDisplay').textContent = route.id; let reportText = `*** REPORTE RUTA ${route.id} ***\nConductor: ${route.driver}\nVeh√≠culo: ${route.vehicle}\nFecha: ${new Date().toLocaleString()}\n\n--- PARADAS ---\n`; route.stops.forEach((stop, index) => {reportText += `\n${index+1}. ${stop.address}\n  Receptor: ${stop.receiverName||'N/A'}, Tel: ${stop.contactPhone||'N/A'}\n  Estado: ${stop.status||'N/A'}${stop.statusComment?' ('+stop.statusComment+')':''}\n`; if(stop.pod){reportText += `  POD: S√≠\n`; if(stop.pod.signedBy)reportText+=`    Recibido por: ${stop.pod.signedBy}\n`; if(stop.pod.geolocation)reportText+=`    Ubic: Lat ${stop.pod.geolocation.lat.toFixed(4)}, Lon ${stop.pod.geolocation.lng.toFixed(4)}\n`;}else reportText += `  POD: No\n`;}); document.getElementById('reportTextPreview').textContent = reportText; document.getElementById('sendWhatsAppReportBtn').onclick = () => window.open(`https://wa.me/?text=${encodeURIComponent(reportText)}`, '_blank'); document.getElementById('sendEmailReportBtn').onclick = () => window.location.href = `mailto:?subject=${encodeURIComponent('Reporte Ruta '+route.id)}&body=${encodeURIComponent(reportText)}`; ui.openModal('reportModal'); }
    };

    // --- L√ìGICA ESPEC√çFICA DE PRUEBA DE ENTREGA (POD) ---
    const pod = { /* ... (firma y geoloc igual que v3 con correcciones de inicializaci√≥n y eventos) ... */
        signatureCanvas:null, signatureCtx:null, drawing:false, lastPos:{x:0,y:0}, isDirty:false, currentFilePreviewDataURL:null,currentFileName:null,currentFileType:null, currentGeolocation:null,
        initSignatureCanvas:function(){this.signatureCanvas=document.getElementById('signature-canvas');if(!this.signatureCanvas)return; this.signatureCtx=this.signatureCanvas.getContext('2d'); this.isDirty=false; this.signatureCanvas.style.width='100%';this.signatureCanvas.style.height='150px'; const dpr=window.devicePixelRatio||1; this.signatureCanvas.width=this.signatureCanvas.offsetWidth*dpr; this.signatureCanvas.height=this.signatureCanvas.offsetHeight*dpr; this.signatureCtx.scale(dpr,dpr); this.signatureCtx.lineWidth=2;this.signatureCtx.lineCap='round';this.signatureCtx.strokeStyle='#000'; this.clearSignature(true); const newCanvas=this.signatureCanvas.cloneNode(true);this.signatureCanvas.parentNode.replaceChild(newCanvas,this.signatureCanvas);this.signatureCanvas=newCanvas;this.signatureCtx=this.signatureCanvas.getContext('2d');this.signatureCtx.scale(dpr,dpr);this.signatureCtx.lineWidth=2;this.signatureCtx.lineCap='round';this.signatureCtx.strokeStyle='#000'; const mousedown=(e)=>this.startDrawing(e); const mousemove=(e)=>this.draw(e); const mouseup=()=>this.stopDrawing(); const touchstart=(e)=>{e.preventDefault();this.startDrawing(this.getTouchPos(e));}; const touchmove=(e)=>{e.preventDefault();this.draw(this.getTouchPos(e));}; const touchend=(e)=>{e.preventDefault();this.stopDrawing();}; this.signatureCanvas.addEventListener('mousedown',mousedown);this.signatureCanvas.addEventListener('mousemove',mousemove);this.signatureCanvas.addEventListener('mouseup',mouseup);this.signatureCanvas.addEventListener('mouseout',mouseup);this.signatureCanvas.addEventListener('touchstart',touchstart,{passive:false});this.signatureCanvas.addEventListener('touchmove',touchmove,{passive:false});this.signatureCanvas.addEventListener('touchend',touchend,{passive:false}); document.getElementById('podPhoto').onchange=evt=>{const[file]=evt.target.files;if(file){if(file.size>1*1024*1024){alert("Max 1MB.");evt.target.value="";return;}const reader=new FileReader();reader.onload=e=>{this.currentFilePreviewDataURL=e.target.result;this.currentFileName=file.name;this.currentFileType=file.type;const preview=document.getElementById('podPhotoPreview');if(file.type.startsWith('image/')){preview.src=this.currentFilePreviewDataURL;preview.style.display='block';}else{preview.style.display='none';alert(`${file.name} seleccionado.`);}};reader.readAsDataURL(file);}else{document.getElementById('podPhotoPreview').style.display='none';this.currentFilePreviewDataURL=null;}};},
        getTouchPos:function(touchEvent){const rect=this.signatureCanvas.getBoundingClientRect();return{offsetX:touchEvent.touches[0].clientX-rect.left,offsetY:touchEvent.touches[0].clientY-rect.top};},
        startDrawing:function(e){this.drawing=true;this.isDirty=true;this.lastPos={x:e.offsetX,y:e.offsetY};this.signatureCtx.beginPath();this.signatureCtx.moveTo(this.lastPos.x,this.lastPos.y);},
        stopDrawing:function(){this.drawing=false;this.signatureCtx.beginPath();},
        draw:function(e){if(!this.drawing)return;this.signatureCtx.lineTo(e.offsetX,e.offsetY);this.signatureCtx.stroke();this.signatureCtx.beginPath();this.signatureCtx.moveTo(e.offsetX,e.offsetY);},
        clearSignature:function(initializing=false){if(this.signatureCtx&&this.signatureCanvas){const dpr=window.devicePixelRatio||1;this.signatureCtx.clearRect(0,0,this.signatureCanvas.width/dpr,this.signatureCanvas.height/dpr);}if(!initializing)this.isDirty=false;},
        isSignatureCanvasEmpty:function(){return!this.isDirty;},
        clearPODForm:function(){document.getElementById('podSignedBy').value='';document.getElementById('podRut').value='';document.getElementById('podPhoto').value='';const preview=document.getElementById('podPhotoPreview');preview.style.display='none';preview.src='#';this.currentFilePreviewDataURL=null;this.currentFileName=null;this.currentFileType=null;if(this.signatureCanvas)this.clearSignature(false);this.currentGeolocation=null;document.getElementById('podLocationStatus').textContent='Pulsa el bot√≥n para detectar.';document.getElementById('podLocationInfo').textContent='Lat: N/A, Lon: N/A';},
        requestLocation: function() { /* ... (igual que v3 con bot√≥n reintentar) ... */ const statusDiv=document.getElementById('podLocationStatus'),infoDiv=document.getElementById('podLocationInfo');statusDiv.textContent='Obteniendo ubicaci√≥n...';infoDiv.textContent='Lat:...,Lon:...';this.currentGeolocation=null;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{this.currentGeolocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy,timestamp:pos.timestamp};statusDiv.textContent='Ubicaci√≥n obtenida.';infoDiv.textContent=`Lat: ${this.currentGeolocation.lat.toFixed(5)}, Lon: ${this.currentGeolocation.lng.toFixed(5)} (Precisi√≥n: ${this.currentGeolocation.accuracy.toFixed(0)}m)`;},err=>{let msg='';switch(err.code){case err.PERMISSION_DENIED:msg="Permiso denegado.";break;case err.POSITION_UNAVAILABLE:msg="Ubic. no disponible.";break;case err.TIMEOUT:msg="Timeout.";break;default:msg="Error desconocido.";}statusDiv.innerHTML=`Error: ${msg} <button class="btn btn-warning btn-xs" onclick="pod.requestLocation()">Reintentar</button>`;infoDiv.textContent='Lat: Error, Lon: Error';this.currentGeolocation={error:msg};},{enableHighAccuracy:true,timeout:15000,maximumAge:60000});}else{statusDiv.textContent='Geoloc. no soportada.';this.currentGeolocation={error:"Not supported"};}}
    };
    // --- INICIALIZACI√ìN ---
    window.onload = () => {
        try {
            dataStore.load();
            auth.checkSession(); // Esto decidir√° si muestra login o app
            
            // Listener global para cerrar modales (revisado)
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    // Cerrar solo el modal clickeado, no todos los que puedan estar abiertos (aunque no deber√≠a pasar)
                    const modalId = event.target.id;
                    if(modalId) { // Asegurar que el modal tiene un ID
                       ui.closeModal(modalId);
                       if (modalId === 'podModal') pod.clearPODForm();
                    }
                }
            });

        } catch (error) {
            console.error("Error fatal durante la inicializaci√≥n:", error);
            document.body.innerHTML = `<div style="padding:20px; text-align:center; color:red;"><h1>Error Cr√≠tico</h1><p>Ha ocurrido un error al cargar la aplicaci√≥n. Por favor, intente borrar los datos de navegaci√≥n (cach√© y localStorage) para este sitio y recargue la p√°gina.</p><pre>${error.stack || error}</pre></div>`;
        }
    };
    </script>
</body>
</html>
