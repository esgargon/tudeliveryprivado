<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas Pro v3 (Demo)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin=""/>

    <style>
        /* CSS (Reusado y con peque√±os ajustes si son necesarios para los nuevos elementos) */
        /* ... (Mayormente igual a la v2) ... */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; flex-grow: 1; }
        h1, h2, h3 { color: #1A237E; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; box-sizing: border-box; padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:10px;}
        textarea { min-height: 80px; }

        #login-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        .login-box h2 { text-align:center; margin-top:0; }
        .login-box button { background-color: #1A237E; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 1em; width: 100%; }
        .login-box button:hover { background-color: #283593; }
        .error-message { color: #D32F2F; font-size:0.9em; margin-bottom:10px; text-align:center;}

        .app-bar { background-color: #1A237E; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .app-bar .logo { font-size: 1.5em; font-weight: bold; }
        .app-bar .user-actions button { background-color: #FFC107; color: #333; border: none; padding: 8px 15px; border-radius: 4px; font-size:0.9em; }
        .app-bar .user-actions button:hover { background-color: #FFB300; }
        
        .btn { padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; margin: 5px; text-decoration: none; display: inline-block; text-align:center;}
        .btn-primary { background-color: #1A237E; color: white; } .btn-primary:hover { background-color: #283593; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #4CAF50; color: white; } .btn-success:hover { background-color: #45a049; }
        .btn-danger { background-color: #F44336; color: white; } .btn-danger:hover { background-color: #D32F2F; }
        .btn-warning { background-color: #FFC107; color: #333; } .btn-warning:hover { background-color: #FFB300; }
        .btn-info { background-color: #17a2b8; color: white; } .btn-info:hover { background-color: #138496; }
        .btn-sm { padding: 5px 10px; font-size: 0.85em;}
        .btn-xs { padding: 3px 8px; font-size: 0.75em;}

        .item-list .item-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s ease; }
        .item-list .item-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-card h3 { margin-top: 0; color: #1A237E; }
        .item-actions button, .item-actions a { margin-right: 5px; margin-bottom: 5px; }

        .route-detail-header { background-color: #1A237E; color: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap;}
        .stops-list { list-style: none; padding: 0; background-color: white; border: 1px solid #ddd; border-top: none; margin-top:0; border-radius: 0 0 8px 8px; }
        .stop-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; align-items: flex-start; }
        .stop-item:last-child { border-bottom: none; }
        .stop-number { font-weight: bold; color: #1A237E; margin-right: 15px; font-size: 1.2em; width:30px; line-height:1.2; }
        .stop-info { flex-grow: 1; min-width:250px; margin-bottom:10px;}
        .stop-address { font-weight: bold; font-size: 1.1em; }
        .stop-sub-address, .stop-contact-info { color: #555; font-size: 0.9em; margin-top: 3px;}
        .stop-actions-main { margin-top:8px; } .stop-actions-main .btn { margin-right:5px;}
        .stop-eta-window { text-align: right; min-width: 120px; flex-basis:120px; margin-left:auto;}
        .pod-thumbnail { max-width: 60px; max-height: 60px; border:1px solid #ccc; margin-top:5px; cursor:pointer; vertical-align: middle; }
        #stop-status-display { font-size:0.85em; color: #555; margin-top:5px; }
        .pod-display-label { font-size:0.85em; color: #555;}

        #routeMapContainer { position: relative; margin-bottom: 20px; }
        #routeMap { height: 350px; width:100%; border-radius: 8px; border:1px solid #ccc;}
        .map-placeholder-text { text-align:center; padding:20px; color:#777; font-style:italic;}
        .leaflet-routing-container { background-color: rgba(255,255,255,0.8); border-radius: 5px; padding: 5px; max-height: 300px; overflow-y: auto;}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-content { background-color: #fff; margin: 1% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom:10px; border-bottom: 1px solid #eee; margin-bottom:20px; }
        .modal-header h2 { margin:0; color: #1A237E; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; } .close-button:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-row { display:flex; gap:15px; flex-wrap:wrap;}
        .form-row .form-group { flex:1; min-width: calc(50% - 8px); }
        .modal-actions { margin-top: 20px; text-align: right; } .modal-actions .btn { margin-left:10px; }
        #stopLocationMap { height: 200px; width: 100%; border-radius: 4px; margin-bottom: 15px; border:1px solid #ccc; cursor: pointer; }
        .map-instructions { font-size:0.85em; color: #777; margin-top: -10px; margin-bottom:10px; }
        #podLocationStatus { font-size:0.9em; margin-top:5px; color:#555; }
        #podLocationInfo { font-size:0.8em; color: #777;}
        .signature-pad-container { border: 1px dashed #ccc; margin-bottom: 10px; position: relative; }
        #signature-canvas { width: 100%; height: 150px; background-color: #f8f8f8; cursor: crosshair; display: block; touch-action: none; /* Crucial for touch events on canvas */}
        #podPhotoPreview { max-width:100px; max-height:100px; display:none; margin-top:5px; border:1px solid #eee;}
        .icon-truck::before { content: "üöö"; margin-right: 5px;}
        .icon-pin::before { content: "üìç"; margin-right: 3px;}

        /* Report Modal */
        #reportModal .modal-content {max-width: 800px;}
        #reportTextPreview {
            white-space: pre-wrap; /* Mantener saltos de l√≠nea */
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        @media (max-width: 768px) { /* ... (igual) ... */ }
        @media (max-width: 600px) { /* ... (igual) ... */ }

    </style>
</head>
<body>
    <div id="app-root"> <!-- ... Contenido de Login y App-View igual que v2 ... --> </div>

    <!-- --- MODALES --- -->
    <!-- Modal: Crear/Editar Ruta (Reusado) -->
    <div id="routeFormModal" class="modal"> <div class="modal-content"> <!-- HTML interno igual --> </div> </div>
    <!-- Modal: A√±adir/Editar Parada (Reusado con MiniMapa) -->
    <div id="stopFormModal" class="modal"> <div class="modal-content"> <!-- HTML interno igual --> </div> </div>
    <!-- Modal: Actualizar Estado de Parada (Reusado) -->
    <div id="updateStatusModal" class="modal"> <div class="modal-content"> <!-- HTML interno igual --> </div> </div>
    <!-- Modal: Prueba de Entrega (POD) (Reusado) -->
    <div id="podModal" class="modal"> <div class="modal-content"> <!-- HTML interno igual --> </div> </div>
    <!-- Modal: Ver Prueba de Entrega (POD) (Reusado) -->
    <div id="viewPodModal" class="modal"> <div class="modal-content"> <!-- HTML interno igual --> </div> </div>

    <!-- NUEVO Modal: Generar Reporte de Ruta -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reporte de Ruta Finalizada</h2>
                <span class="close-button" onclick="ui.closeModal('reportModal')">√ó</span>
            </div>
            <h4>Ruta: <span id="reportRouteIdDisplay"></span></h4>
            <p>A continuaci√≥n se muestra el resumen de la ruta. Puedes enviarlo por WhatsApp o Correo.</p>
            <div id="reportTextPreview" style="margin-bottom:15px;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="ui.closeModal('reportModal')">Cancelar</button>
                <button id="sendWhatsAppReportBtn" class="btn btn-success">Enviar por WhatsApp</button>
                <button id="sendEmailReportBtn" class="btn btn-info">Enviar por Correo</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS y Leaflet Routing Machine JS (igual) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" crossorigin=""></script>

    <script>
    // --- CONFIGURACI√ìN Y DATOS INICIALES (igual que v2) ---
    const APP_STORAGE_KEY = 'routePlannerProData_v3';
    const AUTH_STORAGE_KEY = 'routePlannerProAuth_v3';
    const initialSampleData = { /* ... igual que v2 ... */ };
    
    // Rellenar modales abreviados (igual que v2)
    document.addEventListener('DOMContentLoaded', () => { /* ... igual que v2 ... */});

    // --- L√ìGICA DE DATOS (localStorage) (sin cambios respecto a v2) ---
    const dataStore = { /* ... igual que v2 ... */ };

    // --- L√ìGICA DE AUTENTICACI√ìN (sin cambios respecto a v2) ---
    const auth = { /* ... igual que v2 ... */ };

    // --- L√ìGICA DE UI Y RENDERIZADO (actualizada) ---
    const ui = {
        // ... (currentRouteId, mapInstance, routingControl, stopLocationMapInstance, stopLocationMarker igual) ...
        renderRouteList: function() { /* ... igual que v2 ... */ },

        renderRouteDetail: function(routeId) {
            // ... (L√≥gica para construir `stopsHtml` igual que v2) ...
            // A√±adir el bot√≥n de "Finalizar y Reportar" al final del detalle de ruta
            const route = dataStore.getRouteById(routeId);
            const isAnyStopPending = route.stops.some(stop => stop.status === "Pendiente"); // Para habilitar/deshabilitar bot√≥n

            const content = `
                <!-- ... HTML del encabezado de detalle y mapa como en v2 ... -->
                <div style="padding: 15px; background-color:white; border: 1px solid #ddd; border-top:none; border-radius:0 0 8px 8px; text-align:center; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                   <button class="btn btn-success" onclick="handlers.openStopForm('${routeId}')">+ A√±adir Parada</button>
                   <button class="btn btn-info" onclick="handlers.openReportModal('${routeId}')" ${isAnyStopPending ? 'disabled title="Complete todas las paradas para reportar"' : ''}>Finalizar y Reportar Ruta</button>
                </div>
            `; // HTML completo con .route-detail-card etc.
             // Llenar el contenido HTML de las secciones de app-view y los modales como antes.
             // Este ejemplo solo se enfoca en los cambios a la funci√≥n renderRouteDetail.
            let mainContentArea = document.getElementById('main-content-area'); //Asumiendo que esto existe.
            if (mainContentArea) { // Aqu√≠ ir√≠a el renderizado completo de la vista de detalle
                // Esto es un placeholder. Debes integrar el `content` completo.
                 mainContentArea.innerHTML = `
                    <div style="margin-bottom:15px;">
                        <button class="btn btn-secondary btn-sm" onclick="ui.renderRouteList()">‚Üê Volver a Rutas</button>
                    </div>
                    <div id="routeMapContainer"><div id="routeMap"></div></div>
                    <div class="route-detail-card">
                       <div class="route-detail-header">
                            <div class="driver-info">${route.driver}</div>
                            <div class="vehicle-info"> ${route.vehicle} </div>
                       </div>
                        <ul class="stops-list">${/*stopsHtml debe ser generado aqu√≠*/}</ul>
                        ${content} <!-- El div con los botones de A√±adir Parada y Reportar -->
                    </div>`;
            }

            this.initRouteMapWithRouting(route.stops);
        },
        initRouteMapWithRouting: function(stops) { /* ... igual que v2 ... */ },
        initStopLocationMap: function(lat, lng) { /* ... igual que v2 ... */ },
        openModal: function(modalId) { /* ... igual que v2 ... */ },
        closeModal: function(modalId) { /* ... igual que v2 ... */ }
    };

    // --- L√ìGICA DE MANEJADORES DE EVENTOS Y ACCIONES (actualizada) ---
    const handlers = {
        // ... (openRouteForm, saveRoute, deleteRoute, openStopForm, saveStop, deleteStop sin cambios importantes de v2) ...
        // ... (openUpdateStatusModal, submitStatusUpdate, openViewPodModal sin cambios importantes de v2) ...
        // ... (openPodModal, submitPOD necesitar√°n que `pod.currentGeolocation` se guarde)

        openReportModal: function(routeId) {
            const route = dataStore.getRouteById(routeId);
            if (!route) return;

            document.getElementById('reportRouteIdDisplay').textContent = route.id;
            
            let reportText = `*** REPORTE DE RUTA FINALIZADA ***\n`;
            reportText += `Ruta ID: ${route.id}\n`;
            reportText += `Conductor: ${route.driver}\n`;
            reportText += `Veh√≠culo: ${route.vehicle}\n`;
            reportText += `Fecha: ${new Date().toLocaleString()}\n\n`;
            reportText += `--- DETALLE DE PARADAS ---\n`;

            route.stops.forEach((stop, index) => {
                reportText += `\nParada ${index + 1}: ${stop.address}\n`;
                if(stop.subAddress) reportText += `  Detalles: ${stop.subAddress}\n`;
                if(stop.receiverName) reportText += `  Receptor: ${stop.receiverName}\n`;
                if(stop.contactPhone) reportText += `  Tel√©fono: ${stop.contactPhone}\n`;
                reportText += `  Estado: ${stop.status || 'N/A'}`;
                if(stop.statusComment) reportText += ` (${stop.statusComment})\n`; else reportText += `\n`;

                if (stop.pod) {
                    reportText += `  POD Registrado: S√≠\n`;
                    if (stop.pod.signedBy) reportText += `    Recibido por: ${stop.pod.signedBy}\n`;
                    if (stop.pod.signature) reportText += `    Firma: Adjunta/Registrada\n`;
                    if (stop.pod.fileDataURL) reportText += `    Archivo: Adjunto (${stop.pod.fileName || 'Archivo'})\n`;
                    if (stop.pod.geolocation) {
                        reportText += `    Ubic. POD: Lat ${stop.pod.geolocation.lat.toFixed(5)}, Lon ${stop.pod.geolocation.lng.toFixed(5)}\n`;
                    }
                } else {
                    reportText += `  POD Registrado: No\n`;
                }
            });
            reportText += `\n--- FIN DEL REPORTE ---`;

            document.getElementById('reportTextPreview').textContent = reportText;

            const whatsappBtn = document.getElementById('sendWhatsAppReportBtn');
            const emailBtn = document.getElementById('sendEmailReportBtn');
            
            // Limpiar listeners anteriores para evitar m√∫ltiples env√≠os
            whatsappBtn.onclick = null;
            emailBtn.onclick = null;

            whatsappBtn.onclick = () => {
                const whatsappLink = `https://wa.me/?text=${encodeURIComponent(reportText)}`;
                window.open(whatsappLink, '_blank');
            };

            emailBtn.onclick = () => {
                const subject = `Reporte Ruta Finalizada: ${route.id}`;
                const mailtoLink = `mailto:oficina@example.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(reportText)}`;
                // window.open(mailtoLink); // Usar window.open puede ser bloqueado, mejor href
                window.location.href = mailtoLink;
            };
            ui.openModal('reportModal');
        }
    };

    // --- L√ìGICA ESPEC√çFICA DE PRUEBA DE ENTREGA (POD) (actualizada firma y geoloc) ---
    const pod = {
        // ... (currentFilePreviewDataURL, currentFileName, currentFileType, currentGeolocation) ...
        signatureCanvas: null, signatureCtx: null, drawing: false, lastPos: {x:0, y:0}, // Inicializar lastPos
        isDirty: false, // Para saber si se ha dibujado algo

        initSignatureCanvas: function() {
            this.signatureCanvas = document.getElementById('signature-canvas');
            if (!this.signatureCanvas) return;
            this.signatureCtx = this.signatureCanvas.getContext('2d');
            this.isDirty = false;

            // Set display size (css pixels).
            const style = getComputedStyle(this.signatureCanvas.parentElement); // Usar el contenedor para el ancho inicial
            this.signatureCanvas.style.width = '100%'; // Que ocupe el 100% de su contenedor
            this.signatureCanvas.style.height = '150px'; // Altura fija

            // Set actual size in memory (scaled to account for HDPI screens).
            const dpr = window.devicePixelRatio || 1;
            // Importante: establecer el width/height del canvas despu√©s de que el estilo CSS lo haya definido
            this.signatureCanvas.width = this.signatureCanvas.offsetWidth * dpr;
            this.signatureCanvas.height = this.signatureCanvas.offsetHeight * dpr;
            this.signatureCtx.scale(dpr, dpr);

            this.signatureCtx.lineWidth = 2;
            this.signatureCtx.lineCap = 'round';
            this.signatureCtx.strokeStyle = '#000'; // Color negro para m√°s visibilidad
            this.clearSignature(true); // Limpiar al inicializar, 'true' para no marcar como dirty

            // Remover listeners antiguos si existieran (m√°s robusto si el modal se abre varias veces)
            const newCanvas = this.signatureCanvas.cloneNode(true); // Clonar para quitar listeners de forma segura
            this.signatureCanvas.parentNode.replaceChild(newCanvas, this.signatureCanvas);
            this.signatureCanvas = newCanvas;
            this.signatureCtx = this.signatureCanvas.getContext('2d'); // Reobtener contexto del clon
            // Reaplicar propiedades tras clonar
            this.signatureCtx.scale(dpr, dpr);
            this.signatureCtx.lineWidth = 2; this.signatureCtx.lineCap = 'round'; this.signatureCtx.strokeStyle = '#000';

            this.signatureCanvas.addEventListener('mousedown', (e) => this.startDrawing(e));
            this.signatureCanvas.addEventListener('mouseup', () => this.stopDrawing());
            this.signatureCanvas.addEventListener('mouseout', () => this.stopDrawing());
            this.signatureCanvas.addEventListener('mousemove', (e) => this.draw(e));

            this.signatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.startDrawing(this.getTouchPos(e));}, { passive: false });
            this.signatureCanvas.addEventListener('touchend', (e) => { e.preventDefault(); this.stopDrawing();}, { passive: false });
            this.signatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(this.getTouchPos(e));}, { passive: false });

            const photoInput = document.getElementById('podPhoto'); /* ... (manejador de foto igual) ... */
        },
        
        getTouchPos: function(touchEvent) { /* ... igual que v2 ... */
             const rect = this.signatureCanvas.getBoundingClientRect();
             return { offsetX: touchEvent.touches[0].clientX - rect.left, offsetY: touchEvent.touches[0].clientY - rect.top };
        },

        startDrawing: function(e) { /* ... (a√±adir isDirty) ... */
            this.drawing = true;
            this.isDirty = true; // Se ha empezado a dibujar
            this.lastPos = { x: e.offsetX, y: e.offsetY };
            this.signatureCtx.beginPath(); // Comenzar una nueva ruta aqu√≠
            this.signatureCtx.moveTo(this.lastPos.x, this.lastPos.y);
        },
        stopDrawing: function() { this.drawing = false; this.signatureCtx.beginPath(); }, // Reset path
        draw: function(e) {
            if (!this.drawing) return;
            this.signatureCtx.lineTo(e.offsetX, e.offsetY);
            this.signatureCtx.stroke();
            // No necesitas beginPath() aqu√≠ si es una l√≠nea continua desde el moveTo en startDrawing
            // pero s√≠ es bueno actualizar el lastPos
             this.signatureCtx.beginPath(); // Prepara para el siguiente segmento si se levanta el l√°piz moment√°neamente
             this.signatureCtx.moveTo(e.offsetX, e.offsetY); // La posici√≥n actual se convierte en el inicio del siguiente trazo si contin√∫a
            this.lastPos = { x: e.offsetX, y: e.offsetY }; // Actualizar para el siguiente `lineTo` si sigue `mousemove` sin `mouseup`
        },
        clearSignature: function(initializing = false) {
            if (this.signatureCtx && this.signatureCanvas) {
                 // El tama√±o a limpiar debe ser el no escalado por DPR, ya que el scale lo maneja el canvas
                 this.signatureCtx.clearRect(0, 0, this.signatureCanvas.width / (window.devicePixelRatio||1), this.signatureCanvas.height / (window.devicePixelRatio||1));
            }
            if (!initializing) this.isDirty = false; // Marcar como limpio si no es inicializaci√≥n
        },
        isSignatureCanvasEmpty: function() { return !this.isDirty; },

        clearPODForm: function() { /* ... (limpiar tambi√©n currentGeolocation) ... */
            // Resto igual a v2
            this.currentGeolocation = null;
            document.getElementById('podLocationStatus').textContent = 'Pulsa el bot√≥n para detectar.';
            document.getElementById('podLocationInfo').textContent = 'Lat: N/A, Lon: N/A';
        },

        requestLocation: function() {
            const statusDiv = document.getElementById('podLocationStatus');
            const infoDiv = document.getElementById('podLocationInfo');
            statusDiv.textContent = 'Intentando obtener ubicaci√≥n...';
            infoDiv.textContent = 'Lat: ..., Lon: ... (Por favor, espera)';
            this.currentGeolocation = null; 

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        this.currentGeolocation = {
                            lat: position.coords.latitude, lng: position.coords.longitude,
                            accuracy: position.coords.accuracy, timestamp: position.timestamp
                        };
                        statusDiv.textContent = 'Ubicaci√≥n obtenida exitosamente.';
                        infoDiv.textContent = `Lat: ${this.currentGeolocation.lat.toFixed(5)}, Lon: ${this.currentGeolocation.lng.toFixed(5)} (Precisi√≥n: ${this.currentGeolocation.accuracy.toFixed(0)}m)`;
                    },
                    (error) => {
                        let errorMsg = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMsg = "Permiso de ubicaci√≥n denegado."; break;
                            case error.POSITION_UNAVAILABLE: errorMsg = "Informaci√≥n de ubicaci√≥n no disponible."; break;
                            case error.TIMEOUT: errorMsg = "Timeout al obtener ubicaci√≥n."; break;
                            default: errorMsg = "Error desconocido al obtener ubicaci√≥n."; break;
                        }
                        statusDiv.innerHTML = `Error: ${errorMsg} <button class="btn btn-warning btn-xs" onclick="pod.requestLocation()">Reintentar</button>`;
                        infoDiv.textContent = 'Lat: Error, Lon: Error';
                        console.error("Error de Geolocalizaci√≥n:", error.code, error.message);
                        this.currentGeolocation = { error: errorMsg };
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 } // Timeout m√°s largo, cache por 1min
                );
            } else {
                statusDiv.textContent = 'Geolocalizaci√≥n no es soportada por este navegador.';
                this.currentGeolocation = { error: "Not supported" };
            }
        }
    };

    // --- INICIALIZACI√ìN (sin cambios) ---
    window.onload = () => { /* ... igual que v2 ... */ };
    </script>
</body>
</html>
