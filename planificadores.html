<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas Pro v2.1 (Demo Mejorada)</title> <!-- Nombre actualizado -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin=""/>
    <style>
        /* CSS (Base de tu v2, con adiciones para el modal de reporte) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; flex-grow: 1; }
        h1, h2, h3 { color: #1A237E; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; box-sizing: border-box; padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:10px;}
        textarea { min-height: 80px; }
        #login-view { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        .login-box h2 { text-align:center; margin-top:0; }
        .login-box button { background-color: #1A237E; color: white; padding: 12px; border: none; border-radius: 4px; font-size: 1em; width: 100%; }
        .login-box button:hover { background-color: #283593; }
        .error-message { color: #D32F2F; font-size:0.9em; margin-bottom:10px; text-align:center;}
        .app-bar { background-color: #1A237E; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-wrap:wrap;}
        .app-bar .logo { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; }
        .app-bar .user-actions button { background-color: #FFC107; color: #333; border: none; padding: 8px 15px; border-radius: 4px; font-size:0.9em; }
        .app-bar .user-actions button:hover { background-color: #FFB300; }
        .btn { padding: 10px 15px; border-radius: 5px; border: none; font-weight: bold; margin: 5px; text-decoration: none; display: inline-block; text-align:center;}
        .btn-primary { background-color: #1A237E; color: white; } .btn-primary:hover { background-color: #283593; }
        .btn-secondary { background-color: #6c757d; color: white; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #4CAF50; color: white; } .btn-success:hover { background-color: #45a049; }
        .btn-danger { background-color: #F44336; color: white; } .btn-danger:hover { background-color: #D32F2F; }
        .btn-warning { background-color: #FFC107; color: #333; } .btn-warning:hover { background-color: #FFB300; }
        /* --- NUEVO ---: Estilo para el bot√≥n de Info/Reporte */
        .btn-info { background-color: #17a2b8; color: white; } .btn-info:hover { background-color: #138496; }
        .btn-sm { padding: 5px 10px; font-size: 0.85em;} .btn-xs { padding: 3px 8px; font-size: 0.75em;}
        .item-list .item-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.3s ease; }
        .item-list .item-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-card h3 { margin-top: 0; color: #1A237E; }
        .item-actions button, .item-actions a { margin-right: 5px; margin-bottom: 5px; }
        .route-detail-header { background-color: #1A237E; color: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;flex-wrap:wrap; }
        .route-detail-header .driver-info { font-size: 1.2em; font-weight: bold; }
        .route-detail-header .vehicle-info svg { margin-right: 5px; fill: white; } /* Si usas SVG */
        .stops-list { list-style: none; padding: 0; background-color: white; border: 1px solid #ddd; border-top: none; margin-top:0; border-radius: 0 0 8px 8px; }
        .stop-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-wrap: wrap; align-items: flex-start; }
        .stop-item:last-child { border-bottom: none; }
        .stop-number { font-weight: bold; color: #1A237E; margin-right: 15px; font-size: 1.2em; width:30px; line-height:1.2; }
        .stop-info { flex-grow: 1; min-width:250px; margin-bottom:10px;}
        .stop-address { font-weight: bold; font-size: 1.1em; }
        .stop-sub-address, .stop-contact-info { color: #555; font-size: 0.9em; margin-top: 3px;}
        .stop-actions-main { margin-top:8px; } .stop-actions-main .btn { margin-right:5px;}
        .stop-eta-window { text-align: right; min-width: 120px; flex-basis:120px; margin-left:auto;}
        .pod-thumbnail { max-width: 60px; max-height: 60px; border:1px solid #ccc; margin-top:5px; cursor:pointer; vertical-align: middle; }
        .stop-status-display { font-size:0.85em; color: #555; margin-top:5px; } /* Cambiado de ID a clase */
        .pod-display-label { font-size:0.85em; color: #555;}
        #routeMapContainer { position: relative; margin-bottom: 20px; }
        #routeMap { height: 350px; width:100%; border-radius: 8px; border:1px solid #ccc;}
        .map-placeholder-text { text-align:center; padding:20px; color:#777; font-style:italic;}
        .leaflet-routing-container { background-color: rgba(255,255,255,0.9); border-radius: 5px; padding: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 1px 5px rgba(0,0,0,0.65); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-content { background-color: #fff; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom:10px; border-bottom: 1px solid #eee; margin-bottom:20px; }
        .modal-header h2 { margin:0; color: #1A237E; font-size: 1.4em;}
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; } .close-button:hover { color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-row { display:flex; gap:15px; flex-wrap:wrap;}
        .form-row .form-group { flex:1; min-width: calc(50% - 8px); }
        .modal-actions { margin-top: 20px; text-align: right; } .modal-actions .btn { margin-left:10px; }
        #stopLocationMap { height: 200px; width: 100%; border-radius: 4px; margin-bottom: 15px; border:1px solid #ccc; cursor: pointer; }
        .map-instructions { font-size:0.85em; color: #777; margin-top: -10px; margin-bottom:10px; }
        #podLocationStatus { font-size:0.9em; margin-top:5px; color:#555; }
        #podLocationInfo { font-size:0.8em; color: #777;}
        .signature-pad-container { border: 1px dashed #ccc; margin-bottom: 10px; position: relative; }
        #signature-canvas { width: 100%; height: 150px; background-color: #f8f8f8; cursor: crosshair; display: block; touch-action: none;} /* touch-action:none es importante */
        #podPhotoPreview { max-width:100px; max-height:100px; display:none; margin-top:5px; border:1px solid #eee;}
        .icon-truck::before { content: "üöö"; margin-right: 5px;}
        .icon-pin::before { content: "üìç"; margin-right: 3px;}
        /* --- NUEVO ---: Estilos para Modal de Reporte */
        #reportModal .modal-content {max-width: 800px;}
        #reportTextPreview { white-space: pre-wrap; background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;}
        @media (max-width: 768px) { .form-row .form-group { min-width: 100%; } .stop-item { flex-direction: column; align-items: stretch; } .stop-eta-window { text-align: left; margin-top:10px; margin-left:0; } .app-bar { flex-direction: column; gap:10px;} }
        @media (max-width: 600px) { .container { padding: 0 10px;} .modal-content { width: 95%; margin-top: 10px; margin-bottom: 10px; padding:15px; } .modal-header h2 { font-size: 1.2em; } }
    </style>
</head>
<body>
    <div id="app-root">
        <div id="login-view" class="container"></div>
        <div id="app-view" style="display:none;">
            <div class="app-bar"></div>
            <div class="container" id="main-content-area"></div>
        </div>
    </div>

    <!-- --- MODALES --- -->
    <div id="routeFormModal" class="modal"><div class="modal-content"></div></div>
    <div id="stopFormModal" class="modal"><div class="modal-content"></div></div>
    <div id="updateStatusModal" class="modal"><div class="modal-content"></div></div>
    <div id="podModal" class="modal"><div class="modal-content"></div></div>
    <div id="viewPodModal" class="modal"><div class="modal-content"></div></div>

    <!-- --- NUEVO ---: Modal de Reporte -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reporte de Ruta Finalizada</h2>
                <span class="close-button" onclick="ui.closeModal('reportModal')">√ó</span>
            </div>
            <h4>Ruta: <span id="reportRouteIdDisplay"></span></h4>
            <p>A continuaci√≥n se muestra el resumen de la ruta. Puedes enviarlo por WhatsApp o Correo.</p>
            <div id="reportTextPreview" style="margin-bottom:15px;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="ui.closeModal('reportModal')">Cancelar</button>
                <button id="sendWhatsAppReportBtn" class="btn btn-success">Enviar por WhatsApp</button>
                <button id="sendEmailReportBtn" class="btn btn-info">Enviar por Correo</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" crossorigin=""></script>
    <script>
    // --- CONFIGURACI√ìN Y DATOS INICIALES (igual que v2) ---
    const APP_STORAGE_KEY = 'routePlannerProData_v2_1'; // Actualizar para evitar conflictos
    const AUTH_STORAGE_KEY = 'routePlannerProAuth_v2_1';
    const initialSampleData = { routes: [ { id: "RUTA001", driver: "Conductor Demo", vehicle: "DEMO01", stops: [ { id: "S_R001-1", address: "Plaza Baquedano", subAddress: "Santiago Centro", receiverName: "Juan Ejemplo", contactPhone: "987654321", lat: -33.4372, lng: -70.6346, eta: "09:00", windowStart: "09:00", windowEnd: "12:00", status: "Pendiente", statusComment: null, pod: null }, { id: "S_R001-2", address: "Costanera Center", subAddress: "Providencia", receiverName: "Ana Muestra", contactPhone: "912345678", lat: -33.4175, lng: -70.6064, eta: "10:30", windowStart: "10:00", windowEnd: "14:00", status: "Pendiente", statusComment: null, pod: null }, ] } ], nextRouteId: 2, nextStopIdGlobal: 3 };

    // --- Llenado HTML de modales y vistas base (como en tu v2, con modal de reporte a√±adido) ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-view').innerHTML = `<div class="login-box"><h2><span class="icon-truck"></span> INRoute Pro</h2><div id="login-error" class="error-message" style="display:none;"></div><div class="form-group"><label for="username">Usuario:</label><input type="text" id="username" value="demo"></div><div class="form-group"><label for="password">Contrase√±a:</label><input type="password" id="password" value="demo"></div><button onclick="auth.login()">Iniciar Sesi√≥n</button></div>`;
        document.querySelector('#app-view .app-bar').innerHTML = `<div class="logo"><span class="icon-truck"></span> INRoute Pro</div><div class="user-actions"><span id="currentUserDisplay" style="margin-right:15px;"></span><button onclick="auth.logout()">Cerrar Sesi√≥n</button></div>`;
        document.querySelector('#routeFormModal .modal-content').innerHTML = `<div class="modal-header"><h2 id="routeFormTitle">Crear Ruta</h2><span class="close-button" onclick="ui.closeModal('routeFormModal')">√ó</span></div><input type="hidden" id="routeIdEditable"><div class="form-group"><label for="routeFormDriver">Conductor:</label><input type="text" id="routeFormDriver"></div><div class="form-group"><label for="routeFormVehicle">Veh√≠culo:</label><input type="text" id="routeFormVehicle"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('routeFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveRoute()">Guardar</button></div>`;
        document.querySelector('#stopFormModal .modal-content').innerHTML = `<div class="modal-header"><h2 id="stopFormTitle">A√±adir Parada</h2><span class="close-button" onclick="ui.closeModal('stopFormModal')">√ó</span></div><input type="hidden" id="stopFormRouteId"><input type="hidden" id="stopIdEditable"><div class="form-group"><label for="stopFormAddress">Direcci√≥n:</label><input type="text" id="stopFormAddress"></div><div class="form-group"><label for="stopFormSubAddress">Detalles:</label><input type="text" id="stopFormSubAddress"></div><div class="form-row"><div class="form-group"><label for="stopFormReceiverName">Receptor:</label><input type="text" id="stopFormReceiverName"></div><div class="form-group"><label for="stopFormContactPhone">Tel√©fono:</label><input type="tel" id="stopFormContactPhone"></div></div><div class="form-group"><label><span class="icon-pin"></span>Ubicaci√≥n:</label><div id="stopLocationMap"></div><p class="map-instructions">Clic/Arrastrar para ubicar.</p><div class="form-row"><div class="form-group"><label for="stopFormLat">Lat:</label><input type="number" step="any" id="stopFormLat"></div><div class="form-group"><label for="stopFormLng">Lon:</label><input type="number" step="any" id="stopFormLng"></div></div></div><div class="form-row"><div class="form-group"><label for="stopFormETA">ETA:</label><input type="time" id="stopFormETA"></div><div class="form-group"><label for="stopFormWindowStart">Desde:</label><input type="time" id="stopFormWindowStart"></div><div class="form-group"><label for="stopFormWindowEnd">Hasta:</label><input type="time" id="stopFormWindowEnd"></div></div><div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('stopFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveStop()">Guardar</button></div>`;
        document.querySelector('#updateStatusModal .modal-content').innerHTML = `<div class="modal-header"><h2>Actualizar Estado</h2><span class="close-button" onclick="ui.closeModal('updateStatusModal')">√ó</span></div><p>Parada ID: <span id="statusStopIdDisplay"></span></p><input type="hidden" id="statusUpdateRouteId"><input type="hidden" id="statusUpdateStopId"><div class="status-options"><label><input type="radio" name="statusOption" value="Pendiente"> Pendiente</label><label><input type="radio" name="statusOption" value="Entregado"> Entregado</label><label><input type="radio" name="statusOption" value="No Entregado"> No Entregado</label><label><input type="radio" name="statusOption" value="Parcial"> Parcial</label></div><textarea id="statusReason" placeholder="Raz√≥n/Comentario"></textarea><div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('updateStatusModal')">Cancelar</button><button class="btn btn-success" onclick="handlers.submitStatusUpdate()">Aceptar</button></div>`;
        document.querySelector('#podModal .modal-content').innerHTML = `<div class="modal-header"><h2>Prueba de Entrega</h2><span class="close-button" onclick="ui.closeModal('podModal');pod.clearPODForm();">√ó</span></div><p>Parada ID: <span id="podStopIdDisplay"></span></p><input type="hidden" id="podRouteId"><input type="hidden" id="podStopId"><div class="form-group"><label for="podSignedBy">Recibido por:</label><input type="text" id="podSignedBy"></div><div class="form-group"><label for="podRut">RUT/ID Receptor:</label><input type="text" id="podRut"></div><div class="form-group"><label>Ubicaci√≥n Entrega:</label><button class="btn btn-secondary btn-sm" onclick="pod.requestLocation()"><span class="icon-pin"></span>Detectar</button><div id="podLocationStatus" style="margin-top:5px;"></div><div id="podLocationInfo">Lat: N/A, Lon: N/A</div></div><div class="form-group"><label for="podPhoto">Adjuntar Foto/Archivo:</label><input type="file" id="podPhoto" accept="image/*,application/pdf"><img id="podPhotoPreview" src="#" alt="preview"></div><div class="form-group"><label>Firma Digital:</label><div class="signature-pad-container"><canvas id="signature-canvas"></canvas></div><button class="btn btn-secondary btn-sm" onclick="pod.clearSignature(false)">Limpiar</button></div><div class="modal-actions"><button class="btn btn-danger" onclick="ui.closeModal('podModal');pod.clearPODForm();">Cancelar</button><button class="btn btn-success" onclick="handlers.submitPOD()">Guardar POD</button></div>`;
        document.querySelector('#viewPodModal .modal-content').innerHTML = `<div class="modal-header"><h2>Detalle POD</h2><span class="close-button" onclick="ui.closeModal('viewPodModal')">√ó</span></div><p>Parada ID: <span id="viewPodStopIdDisplay"></span></p><div id="viewPodContent"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('viewPodModal')">Cerrar</button></div>`;
        // El modal de reporte se a√±ade vac√≠o ya que su HTML ya est√° en el body.
    });

    // --- L√ìGICA DE DATOS (localStorage) (Igual a tu v2) ---
    const dataStore = {
        _data: null,
        load: function() { try { const storedData = localStorage.getItem(APP_STORAGE_KEY); if (storedData) { this._data = JSON.parse(storedData); if (this._data && this._data.routes) { this._data.routes.forEach(r => r.stops.forEach(s => { if(s.receiverName===undefined)s.receiverName=''; if(s.contactPhone===undefined)s.contactPhone=''; if(s.pod && s.pod.geolocation===undefined)s.pod.geolocation=null; if(s.pod===undefined)s.pod=null; if(s.statusComment===undefined)s.statusComment=null;}));}} else { this._data = JSON.parse(JSON.stringify(initialSampleData)); this.save();}} catch (e) { console.warn("Error localStorage, reiniciando:",e); localStorage.removeItem(APP_STORAGE_KEY); this._data = JSON.parse(JSON.stringify(initialSampleData)); this.save(); } },
        save: function() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(this._data)); },
        getRoutes: function() { return this._data.routes; }, getRouteById: function(id) { return this._data.routes.find(r => r.id === id); },
        addRoute: function(d, v) { const nR = {id:`RUTA${String(this._data.nextRouteId++).padStart(3,'0')}`, driver:d, vehicle:v, stops:[]}; this._data.routes.push(nR); this.save(); return nR; },
        updateRoute: function(id,d,v){const r=this.getRouteById(id);if(r){r.driver=d;r.vehicle=v;this.save();}},
        deleteRoute:function(id){this._data.routes=this._data.routes.filter(r=>r.id!==id);this.save();},
        addStopToRoute:function(rId,sD){const r=this.getRouteById(rId);if(r){const nS={id:`S${rId.replace('RUTA','_R')}-${this._data.nextStopIdGlobal++}`,...sD,status:"Pendiente",statusComment:null,pod:null};r.stops.push(nS);this.save();return nS;}},
        updateStop:function(rId,sId,sU){const r=this.getRouteById(rId);if(r){const s=r.stops.find(i=>i.id===sId);if(s){Object.assign(s,sU);this.save();}}},
        deleteStopFromRoute:function(rId,sId){const r=this.getRouteById(rId);if(r){r.stops=r.stops.filter(i=>i.id!==sId);this.save();}},
        getStopById:function(rId,sId){const r=this.getRouteById(rId);return r?r.stops.find(i=>i.id===sId):null;}
    };

    // --- L√ìGICA DE AUTENTICACI√ìN (Igual a tu v2) ---
    const auth = { currentUser: null, login: function() {const u=document.getElementById('username').value,p=document.getElementById('password').value,eD=document.getElementById('login-error');eD.style.display='none';if(u==='demo'&&p==='demo'){this.currentUser=u;localStorage.setItem(AUTH_STORAGE_KEY,JSON.stringify({username:this.currentUser}));this.showAppView();}else{eD.textContent='Credenciales incorrectas.';eD.style.display='block';}}, logout: function() {this.currentUser=null;localStorage.removeItem(AUTH_STORAGE_KEY);this.showLoginView();}, checkSession: function() {const s=localStorage.getItem(AUTH_STORAGE_KEY);if(s){try{this.currentUser=JSON.parse(s).username;this.showAppView();}catch(e){localStorage.removeItem(AUTH_STORAGE_KEY);this.showLoginView();}}else{this.showLoginView();}}, showLoginView: function() {document.getElementById('login-view').style.display = 'flex';document.getElementById('app-view').style.display = 'none';}, showAppView: function() {document.getElementById('login-view').style.display = 'none';document.getElementById('app-view').style.display = 'block';document.getElementById('currentUserDisplay').textContent=`Usuario: ${this.currentUser}`;ui.renderRouteList();} };

    // --- L√ìGICA DE UI (Base de tu v2, con adiciones/modificaciones) ---
    const ui = {
        currentRouteId: null, mapInstance: null, routingControl: null, stopLocationMapInstance: null, stopLocationMarker: null,
        renderRouteList: function() { const rS=dataStore.getRoutes();let c=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h2>Mis Rutas</h2><button class="btn btn-primary" onclick="handlers.openRouteForm()">+ Nueva Ruta</button></div><div class="item-list">`;if(rS.length===0){c+='<p>No hay rutas.</p>';}else{rS.forEach(r=>{c+=`<div class="item-card"><h3>${r.id}</h3><p><span class="icon-truck"></span> ${r.driver||'N/A'} | ${r.vehicle||'N/A'}</p><p>Paradas: ${r.stops.length}</p><div class="item-actions"><button class="btn btn-primary btn-sm" onclick="ui.renderRouteDetail('${r.id}')">Ver</button><button class="btn btn-warning btn-sm" onclick="handlers.openRouteForm('${r.id}')">Editar</button><button class="btn btn-danger btn-sm" onclick="handlers.deleteRoute('${r.id}')">Borrar</button></div></div>`;});}c+='</div>';document.getElementById('main-content-area').innerHTML=c; },
        // --- MODIFICADO ---: ui.renderRouteDetail para incluir el bot√≥n de reporte
        renderRouteDetail: function(routeId) {
            this.currentRouteId = routeId; const route = dataStore.getRouteById(routeId); if (!route) { this.renderRouteList(); return; }
            let stopsHtml = ''; if (route.stops.length === 0) { stopsHtml = '<li class="stop-item" style="justify-content:center;padding:20px;">No hay paradas.</li>'; } else { route.stops.forEach((stop, index) => { const podIcon = stop.pod ? `<img src="${(stop.pod.signature || (stop.pod.fileType && stop.pod.fileType.startsWith('image/') ? stop.pod.fileDataURL : null) || 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==')}" alt="POD" class="pod-thumbnail" onclick="handlers.openViewPodModal('${route.id}', '${stop.id}')">` : 'No'; stopsHtml += `<li class="stop-item"><span class="stop-number">${index+1}</span><div class="stop-info"><div class="stop-address">${stop.address} ${stop.lat&&stop.lng?'('+stop.lat.toFixed(4)+','+stop.lng.toFixed(4)+')':''}</div><div class="stop-sub-address">${stop.subAddress||''}</div><div class="stop-contact-info">Para: ${stop.receiverName||'N/A'} / Tel: ${stop.contactPhone||'N/A'}</div><div class="stop-status-display">Estado: ${stop.status||'Pendiente'} ${stop.statusComment?'('+stop.statusComment+')':''}</div><div class="pod-display-label">POD: ${podIcon}</div><div class="stop-actions-main"><button onclick="handlers.openUpdateStatusModal('${route.id}','${stop.id}')" class="btn btn-warning btn-xs">Estado</button><button onclick="handlers.openPodModal('${route.id}','${stop.id}')" class="btn btn-success btn-xs">POD</button><button onclick="handlers.openStopForm('${route.id}','${stop.id}')" class="btn btn-secondary btn-xs">Editar</button><button onclick="handlers.deleteStop('${route.id}','${stop.id}')" class="btn btn-danger btn-xs">Borrar</button></div></div><div class="stop-eta-window">${stop.eta?'<span class="stop-eta">ETA '+stop.eta+'</span>':''}${stop.windowStart&&stop.windowEnd?'<span class="stop-window">'+stop.windowStart+' - '+stop.windowEnd+'</span>':''}</div></li>`; }); }
            const isAnyStopPending = route.stops.some(s => s.status === "Pendiente");
            document.getElementById('main-content-area').innerHTML = `<div style="margin-bottom:15px;"><button class="btn btn-secondary btn-sm" onclick="ui.renderRouteList()">‚Üê Volver</button></div><div id="routeMapContainer"><div id="routeMap"></div></div><div class="route-detail-card"><div class="route-detail-header"><div class="driver-info">${route.driver} (${route.id})</div><div class="vehicle-info"> ${route.vehicle}</div></div><ul class="stops-list">${stopsHtml}</ul><div style="padding:15px;background-color:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;text-align:center;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;"><button class="btn btn-success" onclick="handlers.openStopForm('${route.id}')">+ Parada</button><button class="btn btn-info" onclick="handlers.openReportModal('${route.id}')" ${isAnyStopPending?'disabled title="Complete todas las paradas"':''}>Finalizar y Reportar</button></div></div>`;
            this.initRouteMapWithRouting(route.stops);
        },
        initRouteMapWithRouting: function(stops) { const mC=document.getElementById('routeMap');if(!mC||!L.Routing)return;if(this.mapInstance)this.mapInstance.remove();let mCe=[-33.45694,-70.64827],zL=10;const vS=stops.filter(s=>typeof s.lat==='number'&&typeof s.lng==='number');if(vS.length>0){const b=L.latLngBounds(vS.map(s=>[s.lat,s.lng]));if(b.isValid())mCe=b.getCenter();}this.mapInstance=L.map('routeMap').setView(mCe,zL);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(this.mapInstance);if(vS.length<2){mC.innerHTML='<div class="map-placeholder-text">Min. 2 paradas con coords.</div>';if(vS.length===1){L.marker([vS[0].lat,vS[0].lng]).addTo(this.mapInstance).bindPopup(`<b>${vS[0].address}</b>`);this.mapInstance.setView([vS[0].lat,vS[0].lng],14);}return;}const wP=vS.map(s=>L.latLng(s.lat,s.lng));this.routingControl=L.Routing.control({waypoints:wP,routeWhileDragging:false,showAlternatives:false,lineOptions:{styles:[{color:'blue',opacity:0.8,weight:5}]},createMarker:(i,w,n)=>L.marker(w.latLng,{title:`${i+1}. ${vS[i].address}`}).bindPopup(`<b>${i+1}. ${vS[i].address}</b>`),router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),fitSelectedRoutes:'smart'}).addTo(this.mapInstance);this.routingControl.on('routingerror',e=>{console.error("Ruteo Error:",e.error);mC.innerHTML+='<p style="color:red;text-align:center;">Error calculando ruta.</p>';});},
        initStopLocationMap: function(lat,lng){const mD=document.getElementById('stopLocationMap');if(!mD)return;if(this.stopLocationMapInstance)this.stopLocationMapInstance.remove();const iC=(lat!=null&&lng!=null)?[lat,lng]:[-33.45694,-70.64827],iZ=(lat!=null&&lng!=null)?15:10;this.stopLocationMapInstance=L.map(mD).setView(iC,iZ);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.stopLocationMapInstance);if(this.stopLocationMarker)this.stopLocationMarker.remove();this.stopLocationMarker=L.marker(iC,{draggable:true}).addTo(this.stopLocationMapInstance);this.stopLocationMarker.on('dragend',e=>{const p=e.target.getLatLng();document.getElementById('stopFormLat').value=p.lat.toFixed(6);document.getElementById('stopFormLng').value=p.lng.toFixed(6);});this.stopLocationMapInstance.on('click',e=>{this.stopLocationMarker.setLatLng(e.latlng);document.getElementById('stopFormLat').value=e.latlng.lat.toFixed(6);document.getElementById('stopFormLng').value=e.latlng.lng.toFixed(6);});setTimeout(()=>{if(this.stopLocationMapInstance)this.stopLocationMapInstance.invalidateSize();},250);},
        openModal:function(id){document.getElementById(id).style.display='block';},closeModal:function(id){document.getElementById(id).style.display='none';}
    };

    // --- L√ìGICA DE MANEJADORES (Base de tu v2, con adiciones/modificaciones) ---
    const handlers = {
        openRouteForm:function(id=null){const dI=document.getElementById('routeFormDriver'),vI=document.getElementById('routeFormVehicle'),idI=document.getElementById('routeIdEditable'),t=document.getElementById('routeFormTitle');if(id){const r=dataStore.getRouteById(id);t.textContent=`Editar Ruta ${r.id}`;dI.value=r.driver;vI.value=r.vehicle;idI.value=r.id;}else{t.textContent='Crear Ruta';dI.value='';vI.value='';idI.value='';}ui.openModal('routeFormModal');},
        saveRoute:function(){const d=document.getElementById('routeFormDriver').value,v=document.getElementById('routeFormVehicle').value,id=document.getElementById('routeIdEditable').value;if(!d.trim()||!v.trim()){alert("Conductor y veh√≠culo requeridos.");return;}if(id)dataStore.updateRoute(id,d,v);else dataStore.addRoute(d,v);ui.closeModal('routeFormModal');ui.renderRouteList();},
        deleteRoute:function(id){if(confirm(`Eliminar ruta ${id}?`)){dataStore.deleteRoute(id);ui.renderRouteList();}},
        openStopForm:function(rId,sId=null){const rNI=document.getElementById('stopFormReceiverName'),cPI=document.getElementById('stopFormContactPhone'),latI=document.getElementById('stopFormLat'),lngI=document.getElementById('stopFormLng'),t=document.getElementById('stopFormTitle'),aI=document.getElementById('stopFormAddress'),sAI=document.getElementById('stopFormSubAddress'),eI=document.getElementById('stopFormETA'),wsI=document.getElementById('stopFormWindowStart'),weI=document.getElementById('stopFormWindowEnd');document.getElementById('stopFormRouteId').value=rId;document.getElementById('stopIdEditable').value=sId||'';if(sId){const s=dataStore.getStopById(rId,sId);t.textContent=`Editar Parada ${s.id}`;aI.value=s.address;sAI.value=s.subAddress||'';rNI.value=s.receiverName||'';cPI.value=s.contactPhone||'';latI.value=s.lat||'';lngI.value=s.lng||'';eI.value=s.eta||'';wsI.value=s.windowStart||'';weI.value=s.windowEnd||'';ui.initStopLocationMap(s.lat,s.lng);}else{t.textContent=`A√±adir Parada a ${rId}`;aI.value='';sAI.value='';rNI.value='';cPI.value='';latI.value='';lngI.value='';eI.value='';wsI.value='';weI.value='';ui.initStopLocationMap(null,null);}ui.openModal('stopFormModal');setTimeout(()=>{if(ui.stopLocationMapInstance)ui.stopLocationMapInstance.invalidateSize();},50);},
        saveStop:function(){const rId=document.getElementById('stopFormRouteId').value,sId=document.getElementById('stopIdEditable').value;const sD={address:document.getElementById('stopFormAddress').value,subAddress:document.getElementById('stopFormSubAddress').value,receiverName:document.getElementById('stopFormReceiverName').value,contactPhone:document.getElementById('stopFormContactPhone').value,lat:parseFloat(document.getElementById('stopFormLat').value)||null,lng:parseFloat(document.getElementById('stopFormLng').value)||null,eta:document.getElementById('stopFormETA').value,windowStart:document.getElementById('stopFormWindowStart').value,windowEnd:document.getElementById('stopFormWindowEnd').value};if(!sD.address.trim()){alert("Direcci√≥n obligatoria.");return;}if(sId)dataStore.updateStop(rId,sId,sD);else dataStore.addStopToRoute(rId,sD);ui.closeModal('stopFormModal');ui.renderRouteDetail(rId);},
        deleteStop:function(rId,sId){if(confirm(`Eliminar parada ${sId}?`)){dataStore.deleteStopFromRoute(rId,sId);ui.renderRouteDetail(rId);}},
        openUpdateStatusModal:function(rId,sId){const s=dataStore.getStopById(rId,sId);document.getElementById('statusUpdateRouteId').value=rId;document.getElementById('statusUpdateStopId').value=sId;document.getElementById('statusStopIdDisplay').textContent=sId;if(s&&s.status)document.querySelector(`#updateStatusModal input[name="statusOption"][value="${s.status}"]`).checked=true;else document.querySelector(`#updateStatusModal input[name="statusOption"][value="Pendiente"]`).checked=true;document.getElementById('statusReason').value=s?s.statusComment||'':'';ui.openModal('updateStatusModal');},
        submitStatusUpdate:function(){const rId=document.getElementById('statusUpdateRouteId').value,sId=document.getElementById('statusUpdateStopId').value,rd=document.querySelector('#updateStatusModal input[name="statusOption"]:checked'),rs=document.getElementById('statusReason').value.trim();if(rd){dataStore.updateStop(rId,sId,{status:rd.value,statusComment:rs});ui.closeModal('updateStatusModal');ui.renderRouteDetail(rId);}else alert("Seleccione estado.");},
        openPodModal:function(rId,sId){pod.clearPODForm();document.getElementById('podRouteId').value=rId;document.getElementById('podStopId').value=sId;document.getElementById('podStopIdDisplay').textContent=sId;const s=dataStore.getStopById(rId,sId);document.getElementById('podSignedBy').value=(s&&s.pod&&s.pod.signedBy)?s.pod.signedBy:(s?s.receiverName||'':'');pod.initSignatureCanvas();ui.openModal('podModal');},
        submitPOD:function(){const rId=document.getElementById('podRouteId').value,sId=document.getElementById('podStopId').value;const pD={signedBy:document.getElementById('podSignedBy').value.trim(),rut:document.getElementById('podRut').value.trim(),signature:pod.isSignatureCanvasEmpty()?null:pod.signatureCanvas.toDataURL('image/png'),fileDataURL:pod.currentFilePreviewDataURL,fileName:pod.currentFileName,fileType:pod.currentFileType,geolocation:pod.currentGeolocation};if(!pD.signedBy&&!pD.signature&&!pD.fileDataURL){alert("Complete al menos un campo POD.");return;}dataStore.updateStop(rId,sId,{pod:pD,status:"Entregado (POD)"});ui.closeModal('podModal');pod.clearPODForm();ui.renderRouteDetail(rId);},
        openViewPodModal:function(rId,sId){const s=dataStore.getStopById(rId,sId);document.getElementById('viewPodStopIdDisplay').textContent=sId;const cD=document.getElementById('viewPodContent');cD.innerHTML='';if(s&&s.pod){let pH=`<p><strong>Recibido por:</strong> ${s.pod.signedBy||'N/A'}</p><p><strong>RUT/ID:</strong> ${s.pod.rut||'N/A'}</p>`;if(s.pod.geolocation)pH+=`<p><strong>Ubic. POD:</strong> Lat ${s.pod.geolocation.lat.toFixed(5)}, Lon ${s.pod.geolocation.lng.toFixed(5)} (Precisi√≥n: ${s.pod.geolocation.accuracy}m)</p>`;if(s.pod.signature)pH+=`<h4>Firma:</h4><img src="${s.pod.signature}" style="max-width:100%;border:1px solid #ccc;">`;if(s.pod.fileDataURL){if(s.pod.fileType&&s.pod.fileType.startsWith('image/'))pH+=`<h4>Adjunto:</h4><img src="${s.pod.fileDataURL}" style="max-width:100%;border:1px solid #ccc;">`;else pH+=`<h4>Adjunto:</h4><p><a href="${s.pod.fileDataURL}" download="${s.pod.fileName||'archivo'}">Descargar ${s.pod.fileName||'archivo'}</a></p>`;}cD.innerHTML=pH;}else cD.innerHTML="<p>No hay POD.</p>";ui.openModal('viewPodModal');},
        // --- NUEVO ---: Manejador para abrir el modal de reporte
        openReportModal: function(routeId) {
            const route = dataStore.getRouteById(routeId); if (!route) return;
            document.getElementById('reportRouteIdDisplay').textContent = route.id;
            let reportText = `*** REPORTE RUTA FINALIZADA: ${route.id} ***\nConductor: ${route.driver}\nVeh√≠culo: ${route.vehicle}\nFecha: ${new Date().toLocaleString()}\n\n--- DETALLE DE PARADAS ---\n`;
            route.stops.forEach((stop, index) => { reportText += `\nParada ${index+1}: ${stop.address}\n  Receptor: ${stop.receiverName||'N/A'}, Tel: ${stop.contactPhone||'N/A'}\n  Estado: ${stop.status||'N/A'}${stop.statusComment?' ('+stop.statusComment+')':''}\n`; if(stop.pod){reportText+=`  POD: S√≠\n`;if(stop.pod.signedBy)reportText+=`    Recibido por: ${stop.pod.signedBy}\n`;if(stop.pod.signature)reportText+=`    Firma: Registrada\n`;if(stop.pod.fileDataURL)reportText+=`    Archivo: ${stop.pod.fileName||'Adjunto'}\n`;if(stop.pod.geolocation)reportText+=`    Ubic. POD: Lat ${stop.pod.geolocation.lat.toFixed(4)}, Lon ${stop.pod.geolocation.lng.toFixed(4)}\n`;}else{reportText+=`  POD: No\n`;}});
            reportText += `\n--- FIN DEL REPORTE ---`;
            document.getElementById('reportTextPreview').textContent = reportText;
            const whatsappBtn=document.getElementById('sendWhatsAppReportBtn'), emailBtn=document.getElementById('sendEmailReportBtn');
            whatsappBtn.onclick=()=>{window.open(`https://wa.me/?text=${encodeURIComponent(reportText)}`,'_blank');};
            emailBtn.onclick=()=>{window.location.href=`mailto:oficinacentral@example.com?subject=${encodeURIComponent('Reporte Ruta: '+route.id)}&body=${encodeURIComponent(reportText)}`;}; // Cambia oficina@example.com
            ui.openModal('reportModal');
        }
    };

    // --- L√ìGICA ESPEC√çFICA DE PRUEBA DE ENTREGA (POD) (Con correcciones para firma y geo) ---
    const pod = {
        signatureCanvas:null,signatureCtx:null,drawing:false,lastPos:{x:0,y:0},isDirty:false,
        currentFilePreviewDataURL:null,currentFileName:null,currentFileType:null,currentGeolocation:null,
        // --- MODIFICADO ---: initSignatureCanvas para robustez
        initSignatureCanvas: function() {
            this.signatureCanvas = document.getElementById('signature-canvas');
            if (!this.signatureCanvas) { console.error("Canvas de firma no encontrado"); return; }
            this.isDirty = false;
            // Asegurar que el canvas tiene un tama√±o antes de obtener el contexto
            this.signatureCanvas.style.width = '100%'; this.signatureCanvas.style.height = '150px';

            const dpr = window.devicePixelRatio || 1;
            // Establecer el tama√±o del buffer del canvas despu√©s de que los estilos CSS hayan definido su tama√±o visual
            this.signatureCanvas.width = this.signatureCanvas.offsetWidth * dpr;
            this.signatureCanvas.height = this.signatureCanvas.offsetHeight * dpr;

            this.signatureCtx = this.signatureCanvas.getContext('2d'); // Obtener contexto DESPU√âS de setear width/height
            this.signatureCtx.scale(dpr, dpr); // Escalar el contexto para HDPI
            this.signatureCtx.lineWidth = 2; this.signatureCtx.lineCap = 'round'; this.signatureCtx.strokeStyle = '#000';
            this.clearSignature(true); // Limpiar al inicializar

            // Limpiar listeners anteriores clonando y reemplazando
            const oldCanvas = this.signatureCanvas;
            const newCanvas = oldCanvas.cloneNode(true);
            oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);
            this.signatureCanvas = newCanvas;
            this.signatureCtx = this.signatureCanvas.getContext('2d');
            this.signatureCtx.scale(dpr, dpr); this.signatureCtx.lineWidth = 2; this.signatureCtx.lineCap = 'round'; this.signatureCtx.strokeStyle = '#000';


            const mousedownHandler = (e) => this.startDrawing(this.getMousePos(e));
            const mousemoveHandler = (e) => this.draw(this.getMousePos(e));
            const mouseupHandler = () => this.stopDrawing();
            const touchstartHandler = (e) => { e.preventDefault(); this.startDrawing(this.getTouchPos(e.touches[0])); };
            const touchmoveHandler = (e) => { e.preventDefault(); this.draw(this.getTouchPos(e.touches[0])); };
            const touchendHandler = (e) => { e.preventDefault(); this.stopDrawing(); };

            this.signatureCanvas.addEventListener('mousedown', mousedownHandler);
            this.signatureCanvas.addEventListener('mousemove', mousemoveHandler);
            this.signatureCanvas.addEventListener('mouseup', mouseupHandler);
            this.signatureCanvas.addEventListener('mouseout', mouseupHandler); // Stop drawing if mouse leaves canvas
            this.signatureCanvas.addEventListener('touchstart', touchstartHandler, { passive: false });
            this.signatureCanvas.addEventListener('touchmove', touchmoveHandler, { passive: false });
            this.signatureCanvas.addEventListener('touchend', touchendHandler, { passive: false });
            
            document.getElementById('podPhoto').onchange=evt=>{const[file]=evt.target.files;if(file){if(file.size>1*1024*1024){alert("Max 1MB.");evt.target.value="";return;}const reader=new FileReader();reader.onload=e=>{this.currentFilePreviewDataURL=e.target.result;this.currentFileName=file.name;this.currentFileType=file.type;const preview=document.getElementById('podPhotoPreview');if(file.type.startsWith('image/')){preview.src=this.currentFilePreviewDataURL;preview.style.display='block';}else{preview.style.display='none';alert(`${file.name} seleccionado.`);}};reader.readAsDataURL(file);}else{document.getElementById('podPhotoPreview').style.display='none';this.currentFilePreviewDataURL=null;}};
        },
        getMousePos: function(mouseEvent) { const rect = this.signatureCanvas.getBoundingClientRect(); return { x: mouseEvent.clientX - rect.left, y: mouseEvent.clientY - rect.top }; },
        getTouchPos: function(touch) { const rect = this.signatureCanvas.getBoundingClientRect(); return { x: touch.clientX - rect.left, y: touch.clientY - rect.top }; },
        startDrawing:function(pos){ this.drawing = true; this.isDirty = true; this.signatureCtx.beginPath(); this.signatureCtx.moveTo(pos.x, pos.y); this.lastPos = pos;},
        draw: function(pos){ if (!this.drawing) return; this.signatureCtx.lineTo(pos.x, pos.y); this.signatureCtx.stroke(); this.lastPos = pos;},
        stopDrawing: function(){ if(this.drawing) {this.signatureCtx.closePath(); this.drawing = false;}}, // Close path
        clearSignature:function(init=false){if(this.signatureCtx&&this.signatureCanvas){const dpr=window.devicePixelRatio||1;this.signatureCtx.clearRect(0,0,this.signatureCanvas.width/dpr,this.signatureCanvas.height/dpr);}if(!init)this.isDirty=false;},
        isSignatureCanvasEmpty: function() { return !this.isDirty; },
        clearPODForm: function() {document.getElementById('podSignedBy').value='';document.getElementById('podRut').value='';document.getElementById('podPhoto').value='';const p=document.getElementById('podPhotoPreview');p.style.display='none';p.src='#';this.currentFilePreviewDataURL=null;this.currentFileName=null;this.currentFileType=null;if(this.signatureCanvas)this.clearSignature(false);this.currentGeolocation=null;document.getElementById('podLocationStatus').innerHTML='Pulsa el bot√≥n para detectar.';document.getElementById('podLocationInfo').textContent='Lat: N/A, Lon: N/A';},
        // --- MODIFICADO ---: requestLocation para robustez
        requestLocation: function() { const sD=document.getElementById('podLocationStatus'),iD=document.getElementById('podLocationInfo');sD.textContent='Obteniendo ubicaci√≥n...';iD.textContent='Lat:...,Lon:...';this.currentGeolocation=null;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{this.currentGeolocation={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy,timestamp:p.timestamp};sD.textContent='Ubicaci√≥n obtenida.';iD.textContent=`Lat:${this.currentGeolocation.lat.toFixed(5)},Lon:${this.currentGeolocation.lng.toFixed(5)}(Precisi√≥n:${this.currentGeolocation.accuracy.toFixed(0)}m)`;},e=>{let m;switch(e.code){case e.PERMISSION_DENIED:m="Permiso denegado.";break;case e.POSITION_UNAVAILABLE:m="Ubicaci√≥n no disponible.";break;case e.TIMEOUT:m="Timeout.";break;default:m="Error desconocido.";}sD.innerHTML=`Error:${m} <button class="btn btn-warning btn-xs" onclick="pod.requestLocation()">Reintentar</button>`;iD.textContent='Lat:Error,Lon:Error';this.currentGeolocation={error:m};console.error("Geoloc Error:",e);},{enableHighAccuracy:true,timeout:15000,maximumAge:0});}else{sD.textContent='Geoloc. no soportada.';this.currentGeolocation={error:"Not supported"};}}
    };
    // --- INICIALIZACI√ìN (Igual a tu v2) ---
    window.onload = () => { dataStore.load(); auth.checkSession(); window.addEventListener('click',function(e){if(e.target.classList.contains('modal')){ui.closeModal(e.target.id);if(e.target.id==='podModal')pod.clearPODForm();}}); };
    </script>
</body>
</html>
