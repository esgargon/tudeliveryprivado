<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Rutas Pro v3.2 (Demo)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin=""/>
    <style>
        /* CSS (Asegurar que el CSS para los modales ocultos por defecto esté presente: .modal { display: none; ... }) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 0 15px; flex-grow: 1; }
        h1, h2, h3 { color: #1A237E; }
        button { cursor: pointer; font-family: inherit; }
        input, textarea, select { font-family: inherit; box-sizing: border-box; padding:10px; border:1px solid #ccc; border-radius:4px; width:100%; margin-bottom:10px;}
        textarea { min-height: 80px; }

        #login-view { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px; }
        .login-box { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        /* ... más CSS ... */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 20px; padding-bottom: 20px;}
        .modal-content { background-color: #fff; margin: 2% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        #signature-canvas { width: 100%; height: 150px; background-color: #f8f8f8; cursor: crosshair; display: block; touch-action: none;} /* touch-action es clave */
        #stopLocationMap { height: 200px; width: 100%; border-radius: 4px; margin-bottom: 15px; border:1px solid #ccc; cursor: pointer; }


    </style>
</head>
<body>
    <div id="app-root">
        <div id="login-view" class="container">
             <div class="login-box">
                <h2><span class="icon-truck"></span> INRoute Pro</h2>
                <div id="login-error" class="error-message" style="display:none;"></div>
                <div class="form-group"><label for="username">Usuario:</label><input type="text" id="username" value="demo"></div>
                <div class="form-group"><label for="password">Contraseña:</label><input type="password" id="password" value="demo"></div>
                <button onclick="auth.login()">Iniciar Sesión</button>
            </div>
        </div>
        <div id="app-view" style="display:none;">
            <div class="app-bar">
                <div class="logo"><span class="icon-truck"></span> INRoute Pro</div>
                <div class="user-actions"><span id="currentUserDisplay" style="margin-right:15px;"></span><button onclick="auth.logout()">Cerrar Sesión</button></div>
            </div>
            <div class="container" id="main-content-area"> <!-- Contenido dinámico (lista de rutas, etc.) --> </div>
        </div>
    </div>

    <!-- --- MODALES HTML ESTATICOS --- -->
    <div id="routeFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="routeFormTitle">Crear Ruta</h2><span class="close-button" onclick="ui.closeModal('routeFormModal')">×</span></div>
            <input type="hidden" id="routeIdEditable">
            <div class="form-group"><label for="routeFormDriver">Conductor:</label><input type="text" id="routeFormDriver" placeholder="Ej: Conductor 01"></div>
            <div class="form-group"><label for="routeFormVehicle">Vehículo:</label><input type="text" id="routeFormVehicle" placeholder="Ej: VEH01"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="ui.closeModal('routeFormModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="handlers.saveRoute()">Guardar Ruta</button>
            </div>
        </div>
    </div>

    <div id="stopFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="stopFormTitle">Añadir Parada</h2><span class="close-button" onclick="ui.closeModal('stopFormModal')">×</span></div>
            <input type="hidden" id="stopFormRouteId"><input type="hidden" id="stopIdEditable">
            <div class="form-group"><label for="stopFormAddress">Dirección Principal:</label><input type="text" id="stopFormAddress"></div>
            <div class="form-group"><label for="stopFormSubAddress">Detalles Adicionales:</label><input type="text" id="stopFormSubAddress"></div>
            <div class="form-row"><div class="form-group"><label for="stopFormReceiverName">Nombre Receptor:</label><input type="text" id="stopFormReceiverName"></div><div class="form-group"><label for="stopFormContactPhone">Teléfono Contacto:</label><input type="tel" id="stopFormContactPhone"></div></div>
            <div class="form-group"><label><span class="icon-pin"></span>Ubicación en Mapa:</label><div id="stopLocationMap"></div><p class="map-instructions">Clic/Arrastrar para ubicar.</p><div class="form-row"><div class="form-group"><label for="stopFormLat">Latitud:</label><input type="number" step="any" id="stopFormLat"></div><div class="form-group"><label for="stopFormLng">Longitud:</label><input type="number" step="any" id="stopFormLng"></div></div></div>
            <div class="form-row"><div class="form-group"><label for="stopFormETA">ETA:</label><input type="time" id="stopFormETA"></div><div class="form-group"><label for="stopFormWindowStart">Desde:</label><input type="time" id="stopFormWindowStart"></div><div class="form-group"><label for="stopFormWindowEnd">Hasta:</label><input type="time" id="stopFormWindowEnd"></div></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('stopFormModal')">Cancelar</button><button class="btn btn-primary" onclick="handlers.saveStop()">Guardar Parada</button></div>
        </div>
    </div>
            
    <div id="updateStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Actualizar Estado</h2><span class="close-button" onclick="ui.closeModal('updateStatusModal')">×</span></div>
            <p>Parada ID: <span id="statusStopIdDisplay"></span></p><input type="hidden" id="statusUpdateRouteId"><input type="hidden" id="statusUpdateStopId">
            <div class="status-options">
                <label><input type="radio" name="statusOption" value="Pendiente" checked> Pendiente</label>
                <label><input type="radio" name="statusOption" value="Entregado"> Entregado</label>
                <label><input type="radio" name="statusOption" value="No Entregado"> No Entregado</label>
                <label><input type="radio" name="statusOption" value="Parcial"> Parcial</label>
            </div>
            <textarea id="statusReason" placeholder="Razón/Comentario"></textarea>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('updateStatusModal')">Cancelar</button><button class="btn btn-success" onclick="handlers.submitStatusUpdate()">Aceptar</button></div>
        </div>
    </div>

    <div id="podModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Prueba de Entrega</h2><span class="close-button" onclick="ui.closeModal('podModal');pod.clearPODForm();">×</span></div>
            <p>Parada ID: <span id="podStopIdDisplay"></span></p><input type="hidden" id="podRouteId"><input type="hidden" id="podStopId">
            <div class="form-group"><label for="podSignedBy">Recibido por:</label><input type="text" id="podSignedBy"></div>
            <div class="form-group"><label for="podRut">RUT/ID Receptor:</label><input type="text" id="podRut"></div>
            <div class="form-group"><label for="podLocation">Ubicación Entrega:</label><button class="btn btn-secondary btn-sm" onclick="pod.requestLocation()"><span class="icon-pin"></span>Detectar Ubicación</button><div id="podLocationStatus">Pulsa para detectar.</div><div id="podLocationInfo">Lat: N/A, Lon: N/A</div></div>
            <div class="form-group"><label for="podPhoto">Adjuntar Foto/Archivo (max 1MB):</label><input type="file" id="podPhoto" accept="image/*,application/pdf"><img id="podPhotoPreview" src="#"></div>
            <div class="form-group"><label>Firma Digital:</label><div class="signature-pad-container"><canvas id="signature-canvas"></canvas></div><button class="btn btn-secondary btn-sm" onclick="pod.clearSignature(false)">Limpiar Firma</button></div>
            <div class="modal-actions"><button class="btn btn-danger" onclick="ui.closeModal('podModal');pod.clearPODForm();">Cancelar</button><button class="btn btn-success" onclick="handlers.submitPOD()">Guardar POD</button></div>
        </div>
    </div>

    <div id="viewPodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Detalle POD</h2><span class="close-button" onclick="ui.closeModal('viewPodModal')">×</span></div>
            <p>Parada ID: <span id="viewPodStopIdDisplay"></span></p><div id="viewPodContent"></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="ui.closeModal('viewPodModal')">Cerrar</button></div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
             <div class="modal-header"><h2>Reporte Ruta Finalizada</h2><span class="close-button" onclick="ui.closeModal('reportModal')">×</span></div>
             <h4>Ruta: <span id="reportRouteIdDisplay"></span></h4><p>Resumen de la ruta para enviar.</p>
             <div id="reportTextPreview"></div>
             <div class="modal-actions">
                 <button class="btn btn-secondary" onclick="ui.closeModal('reportModal')">Cancelar</button>
                 <button id="sendWhatsAppReportBtn" class="btn btn-success">WhatsApp</button>
                 <button id="sendEmailReportBtn" class="btn btn-info">Correo</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js" crossorigin=""></script>

    <script>
    // --- CONFIGURACIÓN Y DATOS INICIALES ---
    const APP_STORAGE_KEY = 'routePlannerProData_v3_2'; // Mantenemos la versión por ahora
    const AUTH_STORAGE_KEY = 'routePlannerProAuth_v3_2';
    const initialSampleData = { /* ... (igual que v3.1) ... */ 
         routes: [ { id: "RUTA001", driver: "Conductor Demo", vehicle: "DEMO01", stops: [ { id: "S_R001-1", address: "Plaza Baquedano", subAddress: "Santiago Centro", receiverName: "Juan Ejemplo", contactPhone: "987654321", lat: -33.4372, lng: -70.6346, eta: "09:00", windowStart: "09:00", windowEnd: "12:00", status: "Pendiente", statusComment: null, pod: null }, { id: "S_R001-2", address: "Costanera Center", subAddress: "Providencia", receiverName: "Ana Muestra", contactPhone: "912345678", lat: -33.4175, lng: -70.6064, eta: "10:30", windowStart: "10:00", windowEnd: "14:00", status: "Pendiente", statusComment: null, pod: null }, ] } ], nextRouteId: 2, nextStopIdGlobal: 3
    };

    // --- LÓGICA DE DATOS (localStorage) ---
    const dataStore = { /* ... (igual que v3.1, el load() robusto es clave) ... */ 
         _data: null, load: function() { try { const storedData = localStorage.getItem(APP_STORAGE_KEY); if (storedData) { this._data = JSON.parse(storedData); if (!this._data || !this._data.routes || !this._data.hasOwnProperty('nextRouteId') || !this._data.hasOwnProperty('nextStopIdGlobal')) { throw new Error("Estructura de datos principal faltante o corrupta."); } this._data.routes.forEach(route => { route.stops = route.stops || []; route.stops.forEach(stop => { if (stop.receiverName === undefined) stop.receiverName = ''; if (stop.contactPhone === undefined) stop.contactPhone = ''; stop.pod = stop.pod || null; if (stop.pod && stop.pod.geolocation === undefined) stop.pod.geolocation = null; stop.statusComment = stop.statusComment || null; }); }); } else { this._data = JSON.parse(JSON.stringify(initialSampleData)); this.save(); } } catch (error) { console.warn("Error cargando localStorage, reiniciando:", error); localStorage.removeItem(APP_STORAGE_KEY); this._data = JSON.parse(JSON.stringify(initialSampleData)); this.save(); } }, save: function() { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(this._data)); }, getRoutes: function() { return this._data.routes; }, getRouteById: function(routeId) { return this._data.routes.find(r => r.id === routeId); }, addRoute: function(driver, vehicle) {  const newRouteIdNumeric = this._data.nextRouteId++; const newRoute = { id: `RUTA${String(newRouteIdNumeric).padStart(3, '0')}`, driver, vehicle, stops: [] }; this._data.routes.push(newRoute); this.save(); return newRoute; }, updateRoute: function(routeId, driver, vehicle) { const route = this.getRouteById(routeId); if (route) { route.driver = driver; route.vehicle = vehicle; this.save(); } }, deleteRoute: function(routeId) { this._data.routes = this._data.routes.filter(r => r.id !== routeId); this.save(); }, addStopToRoute: function(routeId, stopData) {  const route = this.getRouteById(routeId); if (route) { const newStopIdNumeric = this._data.nextStopIdGlobal++; const routePrefix = routeId.replace('RUTA','_R'); const newStop = { id: `S${routePrefix}-${newStopIdNumeric}`, ...stopData, status: "Pendiente", statusComment: null, pod: null }; route.stops.push(newStop); this.save(); return newStop; } }, updateStop: function(routeId, stopId, stopUpdates) { const route = this.getRouteById(routeId); if (route) { const stop = route.stops.find(s => s.id === stopId); if (stop) { Object.assign(stop, stopUpdates); this.save(); } } }, deleteStopFromRoute: function(routeId, stopId) { const route = this.getRouteById(routeId); if (route) { route.stops = route.stops.filter(s => s.id !== stopId); this.save(); } }, getStopById: function(routeId, stopId) { const route = this.getRouteById(routeId); return route ? route.stops.find(s => s.id === stopId) : null; }
    };

    // --- LÓGICA DE AUTENTICACIÓN ---
    const auth = { /* ... (igual que v3.1) ... */ 
        currentUser: null, login: function() { const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorDiv = document.getElementById('login-error'); errorDiv.style.display = 'none'; if (username === 'demo' && password === 'demo') { this.currentUser = username; localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ username: this.currentUser })); this.showAppView(); } else { errorDiv.textContent = 'Usuario o contraseña incorrectos.'; errorDiv.style.display = 'block'; } }, logout: function() { this.currentUser = null; localStorage.removeItem(AUTH_STORAGE_KEY); this.showLoginView(); }, checkSession: function() { const session = localStorage.getItem(AUTH_STORAGE_KEY); if (session) { try { this.currentUser = JSON.parse(session).username; this.showAppView(); } catch(e){ console.warn("Sesión corrupta, limpiando."); localStorage.removeItem(AUTH_STORAGE_KEY); this.showLoginView(); } } else { this.showLoginView(); } }, showLoginView: function() { document.getElementById('login-view').style.display = 'flex'; document.getElementById('app-view').style.display = 'none';}, showAppView: function() { document.getElementById('login-view').style.display = 'none'; document.getElementById('app-view').style.display = 'block'; document.getElementById('currentUserDisplay').textContent = `Usuario: ${this.currentUser}`; ui.renderRouteList(); }
    };

    // --- LÓGICA DE UI Y RENDERIZADO ---
    const ui = {
        currentRouteId: null, mapInstance: null, routingControl: null, stopLocationMapInstance: null, stopLocationMarker: null,
        renderRouteList: function() { /* ... (igual que v3.1) ... */ 
            const routes = dataStore.getRoutes(); let content = ''; const mainContentArea = document.getElementById('main-content-area');
            content = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h2>Mis Rutas</h2><button class="btn btn-primary" onclick="handlers.openRouteForm()">+ Nueva Ruta</button></div><div class="item-list">`;
            if (routes.length === 0) { content += '<p>No hay rutas creadas.</p>'; }
            else { routes.forEach(route => { content += `<div class="item-card"><h3>${route.id}</h3><p><span class="icon-truck"></span> C: ${route.driver || 'N/A'} | V: ${route.vehicle || 'N/A'}</p><p>Paradas: ${route.stops.length}</p><div class="item-actions"><button class="btn btn-primary btn-sm" onclick="ui.renderRouteDetail('${route.id}')">Ver</button><button class="btn btn-warning btn-sm" onclick="handlers.openRouteForm('${route.id}')">Editar</button><button class="btn btn-danger btn-sm" onclick="handlers.deleteRoute('${route.id}')">X</button></div></div>`;}); }
            content += '</div>'; mainContentArea.innerHTML = content;
        },
        renderRouteDetail: function(routeId) { /* ... (igual que v3.1) ... */
             this.currentRouteId = routeId; const route = dataStore.getRouteById(routeId); if (!route) { this.renderRouteList(); return; } let stopsHtml = ''; if (route.stops.length === 0) { stopsHtml = '<li class="stop-item" style="justify-content:center; padding:20px;">No hay paradas.</li>'; } else { route.stops.forEach((stop, index) => { const podIcon = stop.pod ? `<img src="${(stop.pod.signature || (stop.pod.fileType && stop.pod.fileType.startsWith('image/') ? stop.pod.fileDataURL : null) || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=')}" alt="POD" class="pod-thumbnail" onclick="handlers.openViewPodModal('${route.id}', '${stop.id}')">` : 'No'; stopsHtml += `<li class="stop-item"><span class="stop-number">${index + 1}</span><div class="stop-info"><div class="stop-address">${stop.address} ${stop.lat && stop.lng ? `(${stop.lat.toFixed(4)},${stop.lng.toFixed(4)})` : ''}</div><div class="stop-sub-address">${stop.subAddress||''}</div><div class="stop-contact-info">Para: ${stop.receiverName||'N/A'} / Tel: ${stop.contactPhone||'N/A'}</div><div class="stop-status-display">Estado: ${stop.status||'Pendiente'} ${stop.statusComment?'('+stop.statusComment+')':''}</div><div class="pod-display-label">POD: ${podIcon}</div><div class="stop-actions-main"><button onclick="handlers.openUpdateStatusModal('${route.id}','${stop.id}')" class="btn btn-warning btn-xs">Estado</button><button onclick="handlers.openPodModal('${route.id}','${stop.id}')" class="btn btn-success btn-xs">POD</button><button onclick="handlers.openStopForm('${route.id}','${stop.id}')" class="btn btn-secondary btn-xs">Editar</button><button onclick="handlers.deleteStop('${route.id}','${stop.id}')" class="btn btn-danger btn-xs">X</button></div></div><div class="stop-eta-window">${stop.eta?`<span class="stop-eta">ETA ${stop.eta}</span>`:''} ${stop.windowStart&&stop.windowEnd?`<span class="stop-window">${stop.windowStart} - ${stop.windowEnd}</span>`:''}</div></li>`;});} const isAnyStopPending = route.stops.some(stop => stop.status === "Pendiente"); const mainContentArea = document.getElementById('main-content-area'); mainContentArea.innerHTML = `<div style="margin-bottom:15px;"><button class="btn btn-secondary btn-sm" onclick="ui.renderRouteList()">← Rutas</button></div><div id="routeMapContainer"><div id="routeMap"></div></div><div class="route-detail-card"><div class="route-detail-header"><div class="driver-info">${route.driver} (${route.id})</div><div class="vehicle-info"> ${route.vehicle} </div></div><ul class="stops-list">${stopsHtml}</ul><div style="padding:15px;background-color:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;text-align:center;display:flex;justify-content:center;gap:10px;flex-wrap:wrap;"><button class="btn btn-success" onclick="handlers.openStopForm('${route.id}')">+ Parada</button><button class="btn btn-info" onclick="handlers.openReportModal('${route.id}')" ${isAnyStopPending?'disabled title="Complete todas las paradas para reportar"':''}>Reportar Ruta</button></div></div>`; this.initRouteMapWithRouting(route.stops);
        },
        initRouteMapWithRouting: function(stops) { /* ... (igual que v3.1) ... */ 
             const mapContainer = document.getElementById('routeMap'); if (!mapContainer || !L.Routing) { console.error("Mapa o ruteo no disponible"); if(mapContainer) mapContainer.innerHTML = '<p>Error componentes mapa.</p>'; return; } if (this.mapInstance) this.mapInstance.remove(); this.routingControl = null; let mapCenter = [-33.45694, -70.64827]; let zoomLevel = 10; const validStopsWithCoords = stops.filter(s => typeof s.lat === 'number' && typeof s.lng === 'number'); if (validStopsWithCoords.length > 0) { const bounds = L.latLngBounds(validStopsWithCoords.map(s => [s.lat, s.lng])); if (bounds.isValid()) mapCenter = bounds.getCenter(); } this.mapInstance = L.map('routeMap').setView(mapCenter, zoomLevel); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OSM'}).addTo(this.mapInstance); if (validStopsWithCoords.length < 2) { if (mapContainer) mapContainer.innerHTML = '<div class="map-placeholder-text">Se necesitan al menos 2 paradas con coordenadas.</div>'; if(validStopsWithCoords.length === 1) {L.marker([validStopsWithCoords[0].lat, validStopsWithCoords[0].lng]).addTo(this.mapInstance).bindPopup(`<b>${validStopsWithCoords[0].address}</b>`); this.mapInstance.setView([validStopsWithCoords[0].lat, validStopsWithCoords[0].lng], 14); } return; } const waypoints = validStopsWithCoords.map(stop => L.latLng(stop.lat, stop.lng)); this.routingControl = L.Routing.control({waypoints, routeWhileDragging: false, showAlternatives: false, lineOptions: { styles: [{color: 'blue', opacity: 0.8, weight: 5}] }, createMarker: (i, wp, n) => L.marker(wp.latLng, {title: `${i+1}. ${validStopsWithCoords[i].address}`}).bindPopup(`<b>${i+1}. ${validStopsWithCoords[i].address}</b>`), router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}), fitSelectedRoutes: 'smart'}).addTo(this.mapInstance); this.routingControl.on('routingerror', e => { console.error("Error ruteo:", e.error); if(mapContainer) mapContainer.innerHTML += '<p style="color:red;text-align:center;">Error al calcular la ruta. Intente con otras ubicaciones.</p>'; });
        },
        initStopLocationMap: function(lat, lng) { /* ... (igual que v3.1, importante invalidateSize) ... */
             const mapDiv = document.getElementById('stopLocationMap'); if (!mapDiv) return; if (this.stopLocationMapInstance) { this.stopLocationMapInstance.remove(); this.stopLocationMapInstance=null;} const initialCoords = (lat != null && lng != null) ? [lat, lng] : [-33.45694, -70.64827]; const initialZoom = (lat != null && lng != null) ? 15 : 10; this.stopLocationMapInstance = L.map(mapDiv).setView(initialCoords, initialZoom); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.stopLocationMapInstance); if (this.stopLocationMarker) {this.stopLocationMarker.remove(); this.stopLocationMarker = null;} this.stopLocationMarker = L.marker(initialCoords, { draggable: true }).addTo(this.stopLocationMapInstance); this.stopLocationMarker.on('dragend', e => { const pos = e.target.getLatLng(); document.getElementById('stopFormLat').value = pos.lat.toFixed(6); document.getElementById('stopFormLng').value = pos.lng.toFixed(6);}); this.stopLocationMapInstance.on('click', e => { this.stopLocationMarker.setLatLng(e.latlng); document.getElementById('stopFormLat').value = e.latlng.lat.toFixed(6); document.getElementById('stopFormLng').value = e.latlng.lng.toFixed(6);}); setTimeout(() => { if(this.stopLocationMapInstance) this.stopLocationMapInstance.invalidateSize();}, 200); // Aumentar un poco el timeout
        },
        openModal: function(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'block'; else console.error(`Modal con ID ${modalId} no encontrado.`);},
        closeModal: function(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'none'; }
    };

    // --- LÓGICA DE MANEJADORES DE EVENTOS Y ACCIONES ---
    const handlers = {
        openRouteForm: function(routeIdToEdit = null) { /* ... (igual que v3.1) ... */
             const driverInput = document.getElementById('routeFormDriver'); const vehicleInput = document.getElementById('routeFormVehicle'); const idInput = document.getElementById('routeIdEditable'); const title = document.getElementById('routeFormTitle'); if (routeIdToEdit) { const route = dataStore.getRouteById(routeIdToEdit); if(!route){ui.renderRouteList(); return;} title.textContent=`Editar Ruta ${route.id}`; driverInput.value=route.driver; vehicleInput.value=route.vehicle; idInput.value=route.id;} else { title.textContent='Crear Nueva Ruta'; driverInput.value=''; vehicleInput.value=''; idInput.value='';} ui.openModal('routeFormModal');
        },
        saveRoute: function() { /* ... (igual que v3.1) ... */ 
            const driver = document.getElementById('routeFormDriver').value; const vehicle = document.getElementById('routeFormVehicle').value; const routeId = document.getElementById('routeIdEditable').value; if (!driver.trim() || !vehicle.trim()) { alert("Conductor y vehículo son obligatorios."); return; } if (routeId) dataStore.updateRoute(routeId, driver, vehicle); else dataStore.addRoute(driver, vehicle); ui.closeModal('routeFormModal'); ui.renderRouteList();
        },
        deleteRoute: function(routeId) { if(confirm(`¿Eliminar ruta ${routeId} y todas sus paradas?`)) {dataStore.deleteRoute(routeId); ui.renderRouteList();} },
        openStopForm: function(routeId, stopIdToEdit = null) { /* ... (igual que v3.1, llamar initStopLocationMap al final) ... */
             document.getElementById('stopFormRouteId').value = routeId; document.getElementById('stopIdEditable').value = stopIdToEdit || ''; const title = document.getElementById('stopFormTitle'); const addr = document.getElementById('stopFormAddress'), subAddr = document.getElementById('stopFormSubAddress'), recName = document.getElementById('stopFormReceiverName'), conPhone = document.getElementById('stopFormContactPhone'), latInput = document.getElementById('stopFormLat'), lngInput = document.getElementById('stopFormLng'), eta = document.getElementById('stopFormETA'), ws = document.getElementById('stopFormWindowStart'), we = document.getElementById('stopFormWindowEnd'); let stopLat = null, stopLng = null; if (stopIdToEdit) { const stop = dataStore.getStopById(routeId, stopIdToEdit); if(!stop){ui.renderRouteDetail(routeId);return;} title.textContent = `Editar Parada ${stop.id}`; addr.value=stop.address; subAddr.value=stop.subAddress||''; recName.value=stop.receiverName||''; conPhone.value=stop.contactPhone||''; latInput.value=stop.lat||''; lngInput.value=stop.lng||''; eta.value=stop.eta||''; ws.value=stop.windowStart||''; we.value=stop.windowEnd||''; stopLat = stop.lat; stopLng = stop.lng; } else { title.textContent=`Añadir Parada a ${routeId}`; addr.value=''; subAddr.value=''; recName.value=''; conPhone.value=''; latInput.value=''; lngInput.value=''; eta.value=''; ws.value=''; we.value=''; } ui.openModal('stopFormModal'); ui.initStopLocationMap(stopLat, stopLng); // Importante llamar aquí
        },
        saveStop: function() { /* ... (igual que v3.1) ... */ const routeId = document.getElementById('stopFormRouteId').value, stopId = document.getElementById('stopIdEditable').value; const stopData = {address:document.getElementById('stopFormAddress').value, subAddress:document.getElementById('stopFormSubAddress').value, receiverName:document.getElementById('stopFormReceiverName').value, contactPhone:document.getElementById('stopFormContactPhone').value, lat:parseFloat(document.getElementById('stopFormLat').value)||null, lng:parseFloat(document.getElementById('stopFormLng').value)||null, eta:document.getElementById('stopFormETA').value, windowStart:document.getElementById('stopFormWindowStart').value, windowEnd:document.getElementById('stopFormWindowEnd').value }; if(!stopData.address.trim()){alert("Dirección obligatoria.");return;} if(stopId)dataStore.updateStop(routeId, stopId, stopData);else dataStore.addStopToRoute(routeId,stopData); ui.closeModal('stopFormModal');ui.renderRouteDetail(routeId); },
        deleteStop: function(routeId, stopId) { if(confirm(`¿Eliminar parada ${stopId}?`)){dataStore.deleteStopFromRoute(routeId,stopId); ui.renderRouteDetail(routeId);} },
        openUpdateStatusModal: function(routeId, stopId) { /* ... (igual que v3.1) ... */ const stop=dataStore.getStopById(routeId,stopId); document.getElementById('statusUpdateRouteId').value=routeId; document.getElementById('statusUpdateStopId').value=stopId; document.getElementById('statusStopIdDisplay').textContent=stopId; if(stop && stop.status) { const radioToSelect = document.querySelector(`#updateStatusModal input[name="statusOption"][value="${stop.status}"]`); if (radioToSelect) radioToSelect.checked=true; else document.querySelector(`#updateStatusModal input[name="statusOption"][value="Pendiente"]`).checked=true;} else {document.querySelector(`#updateStatusModal input[name="statusOption"][value="Pendiente"]`).checked=true;} document.getElementById('statusReason').value=stop?stop.statusComment||'':''; ui.openModal('updateStatusModal'); },
        submitStatusUpdate: function() { /* ... (igual que v3.1) ... */ const routeId=document.getElementById('statusUpdateRouteId').value, stopId=document.getElementById('statusUpdateStopId').value; const radio=document.querySelector('#updateStatusModal input[name="statusOption"]:checked'); const reason=document.getElementById('statusReason').value.trim(); if(radio){dataStore.updateStop(routeId,stopId,{status:radio.value, statusComment:reason});ui.closeModal('updateStatusModal');ui.renderRouteDetail(routeId);}else alert("Selecciona estado"); },
        openPodModal: function(routeId, stopId) { /* ... (llamar initSignatureCanvas DESPUÉS de ui.openModal) ... */
            pod.clearPODForm(); 
            document.getElementById('podRouteId').value=routeId; 
            document.getElementById('podStopId').value=stopId; 
            document.getElementById('podStopIdDisplay').textContent=stopId; 
            const stop=dataStore.getStopById(routeId,stopId); 
            document.getElementById('podSignedBy').value = (stop && stop.pod && stop.pod.signedBy) ? stop.pod.signedBy : (stop ? stop.receiverName || '' : '');
            ui.openModal('podModal');
            pod.initSignatureCanvas(); // Ahora se llama DESPUÉS de hacer visible el modal
        },
        submitPOD: function() { /* ... (igual que v3.1) ... */ const routeId=document.getElementById('podRouteId').value, stopId=document.getElementById('podStopId').value; const podData={signedBy:document.getElementById('podSignedBy').value.trim(), rut:document.getElementById('podRut').value.trim(), signature:pod.isSignatureCanvasEmpty()?null:pod.signatureCanvas.toDataURL('image/png'), fileDataURL:pod.currentFilePreviewDataURL,fileName:pod.currentFileName,fileType:pod.currentFileType, geolocation:pod.currentGeolocation }; if(!podData.signedBy && !podData.signature && !podData.fileDataURL){alert("Complete al menos un campo POD.");return;} dataStore.updateStop(routeId,stopId,{pod:podData,status:"Entregado (POD)"});ui.closeModal('podModal');pod.clearPODForm();ui.renderRouteDetail(routeId);},
        openViewPodModal: function(routeId, stopId) { /* ... (igual que v3.1) ... */ },
        openReportModal: function(routeId) { /* ... (igual que v3.1 con clonación de botones para listeners) ... */
            const route = dataStore.getRouteById(routeId); if (!route) return;
            document.getElementById('reportRouteIdDisplay').textContent = route.id;
            let reportText = `*** REPORTE RUTA ${route.id} ***\nConductor: ${route.driver}\nVehículo: ${route.vehicle}\nFecha: ${new Date().toLocaleString('es-CL')}\n\n--- DETALLE DE PARADAS ---\n`;
            route.stops.forEach((stop, index) => { reportText += `\n${index + 1}. ${stop.address}\n  Receptor: ${stop.receiverName||'N/A'}, Tel: ${stop.contactPhone||'N/A'}\n  Estado: ${stop.status||'N/A'}${stop.statusComment?' ('+stop.statusComment+')':''}\n`; if(stop.pod){ reportText += `  POD: Registrado\n`; if(stop.pod.signedBy) reportText+=`    Recibido por: ${stop.pod.signedBy}\n`; if(stop.pod.geolocation) reportText+=`    Ubic. POD: Lat ${stop.pod.geolocation.lat.toFixed(5)}, Lon ${stop.pod.geolocation.lng.toFixed(5)}\n`; if(stop.pod.signature) reportText+="    Firma: Sí\n"; if(stop.pod.fileDataURL) reportText+=`    Archivo: ${stop.pod.fileName||'Sí'}\n`;} else { reportText += `  POD: No Registrado\n`; }});
            reportText += `\n--- FIN REPORTE ---`;
            document.getElementById('reportTextPreview').textContent = reportText;
            const whatsappBtn = document.getElementById('sendWhatsAppReportBtn');
            const emailBtn = document.getElementById('sendEmailReportBtn');
            const newWhatsappBtn = whatsappBtn.cloneNode(true); whatsappBtn.parentNode.replaceChild(newWhatsappBtn, whatsappBtn);
            const newEmailBtn = emailBtn.cloneNode(true); emailBtn.parentNode.replaceChild(newEmailBtn, emailBtn);
            newWhatsappBtn.addEventListener('click', () => { window.open(`https://wa.me/?text=${encodeURIComponent(reportText)}`, '_blank'); });
            newEmailBtn.addEventListener('click', () => { window.location.href = `mailto:oficina@example.com?subject=${encodeURIComponent('Reporte Ruta '+route.id)}&body=${encodeURIComponent(reportText)}`; });
            ui.openModal('reportModal');
        }
    };

    // --- LÓGICA ESPECÍFICA DE PRUEBA DE ENTREGA (POD) ---
    const pod = {
        signatureCanvas:null, signatureCtx:null, drawing:false, lastPos:{x:0,y:0}, isDirty:false,
        currentFilePreviewDataURL:null,currentFileName:null,currentFileType:null, currentGeolocation:null,
        eventListenersAttached: false, 

        initSignatureCanvas:function(){ 
            this.signatureCanvas = document.getElementById('signature-canvas');
            if(!this.signatureCanvas) { console.error("Firma Canvas no encontrado!"); return; }
            
            this.signatureCtx = this.signatureCanvas.getContext('2d');
            if(!this.signatureCtx) { console.error("Contexto 2D de firma no obtenido!"); return; }
            
            this.isDirty = false;
            
            const dpr = window.devicePixelRatio || 1;
            const rect = this.signatureCanvas.getBoundingClientRect();
            // Asegurarse de que rect.width y rect.height no sean 0
            if (rect.width === 0 || rect.height === 0) {
                // Esto puede pasar si el modal no está completamente renderizado o visible aún.
                // Para el HTML estático, esto es menos probable, pero por si acaso:
                console.warn("Canvas de firma tiene dimensiones 0. Reintentando en breve.");
                setTimeout(() => this.initSignatureCanvas(), 100); // Reintentar
                return;
            }
            
            this.signatureCanvas.width = rect.width * dpr;
            this.signatureCanvas.height = rect.height * dpr;
            this.signatureCtx.scale(dpr, dpr);
            
            this.signatureCtx.lineWidth = 2.5; 
            this.signatureCtx.lineCap = 'round'; 
            this.signatureCtx.strokeStyle = '#333'; 
            this.clearSignature(true); // true para no marcar como dirty en init

            if (!this.eventListenersAttached) {
                const getCoordinates = (event) => {
                    const rect = this.signatureCanvas.getBoundingClientRect();
                    if (event.touches && event.touches[0]) { // Touch event
                        return { x: event.touches[0].clientX - rect.left, y: event.touches[0].clientY - rect.top };
                    } else { // Mouse event
                        return { x: event.offsetX, y: event.offsetY };
                    }
                };

                const startDrawingHandler=(e)=>{ this.drawing=true; this.isDirty=true; const coords=getCoordinates(e); this.lastPos={x:coords.x, y:coords.y}; this.signatureCtx.beginPath(); this.signatureCtx.moveTo(this.lastPos.x,this.lastPos.y); if(e.type === 'touchstart') e.preventDefault();};
                const drawHandler=(e)=>{ if(!this.drawing)return; const coords=getCoordinates(e); this.signatureCtx.lineTo(coords.x,coords.y); this.signatureCtx.stroke(); this.lastPos={x:coords.x, y:coords.y}; if(e.type === 'touchmove') e.preventDefault();};
                const stopDrawingHandler=(e)=>{ this.drawing=false; /*No beginPath aqui*/ if(e.type === 'touchend') e.preventDefault();};

                this.signatureCanvas.addEventListener('mousedown',startDrawingHandler);
                this.signatureCanvas.addEventListener('mousemove',drawHandler);
                this.signatureCanvas.addEventListener('mouseup',stopDrawingHandler);
                this.signatureCanvas.addEventListener('mouseout',stopDrawingHandler);
                this.signatureCanvas.addEventListener('touchstart',touchstartHandler,{passive:false});
                this.signatureCanvas.addEventListener('touchmove',drawHandler,{passive:false});
                this.signatureCanvas.addEventListener('touchend',stopDrawingHandler,{passive:false});
                this.eventListenersAttached = true;
            }

            // Manejador de archivo adjunto
            document.getElementById('podPhoto').onchange=evt=>{
                const [file] = evt.target.files;
                const preview = document.getElementById('podPhotoPreview');
                if (file) {
                    if (file.size > 1 * 1024 * 1024) { alert("Archivo máx. 1MB."); evt.target.value=""; preview.style.display='none'; this.currentFilePreviewDataURL=null; return; }
                    const reader = new FileReader();
                    reader.onload = e_reader => {
                        this.currentFilePreviewDataURL = e_reader.target.result;
                        this.currentFileName = file.name; this.currentFileType = file.type;
                        if(file.type.startsWith('image/')){ preview.src=this.currentFilePreviewDataURL; preview.style.display='block';}
                        else { preview.style.display='none'; preview.src="#"; alert(`Archivo "${file.name}" seleccionado.`);}
                    }
                    reader.readAsDataURL(file);
                } else { preview.style.display='none'; preview.src="#"; this.currentFilePreviewDataURL=null;}
            };
        },
        clearSignature:function(initializing=false){if(this.signatureCtx&&this.signatureCanvas){const dpr=window.devicePixelRatio||1;this.signatureCtx.clearRect(0,0,this.signatureCanvas.width/dpr,this.signatureCanvas.height/dpr);}if(!initializing)this.isDirty=false;},
        isSignatureCanvasEmpty:function(){return!this.isDirty;},
        clearPODForm:function(){document.getElementById('podSignedBy').value='';document.getElementById('podRut').value='';document.getElementById('podPhoto').value='';const preview=document.getElementById('podPhotoPreview');preview.style.display='none';preview.src='#';this.currentFilePreviewDataURL=null;this.currentFileName=null;this.currentFileType=null;if(this.signatureCanvas && this.signatureCtx)this.clearSignature(false);this.currentGeolocation=null;document.getElementById('podLocationStatus').textContent='Pulsa el botón para detectar.';document.getElementById('podLocationInfo').textContent='Lat: N/A, Lon: N/A';},
        requestLocation: function() { /* ... (igual que v3.1) ... */ const statusDiv=document.getElementById('podLocationStatus'),infoDiv=document.getElementById('podLocationInfo');statusDiv.textContent='Obteniendo ubicación...';infoDiv.textContent='Lat:...,Lon:...';this.currentGeolocation=null;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(pos=>{this.currentGeolocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy,timestamp:pos.timestamp};statusDiv.textContent='Ubicación obtenida.';infoDiv.textContent=`Lat: ${this.currentGeolocation.lat.toFixed(5)}, Lon: ${this.currentGeolocation.lng.toFixed(5)} (Precisión: ${this.currentGeolocation.accuracy.toFixed(0)}m)`;},err=>{let msg='';switch(err.code){case err.PERMISSION_DENIED:msg="Permiso denegado.";break;case err.POSITION_UNAVAILABLE:msg="Ubic. no disponible.";break;case err.TIMEOUT:msg="Timeout.";break;default:msg="Error desconocido.";}statusDiv.innerHTML=`Error: ${msg} <button class="btn btn-warning btn-xs" onclick="pod.requestLocation()">Reintentar</button>`;infoDiv.textContent='Lat: Error, Lon: Error';this.currentGeolocation={error:msg};},{enableHighAccuracy:true,timeout:15000,maximumAge:60000});}else{statusDiv.textContent='Geoloc. no soportada.';this.currentGeolocation={error:"Not supported"};}}
    };
    // --- INICIALIZACIÓN ---
    window.onload = () => {
         try { 
            dataStore.load(); 
            auth.checkSession(); 
            // Listener global para cerrar modales, más robusto.
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    const modalId = event.target.id;
                    if(modalId && typeof ui.closeModal === 'function') { 
                       ui.closeModal(modalId);
                       if (modalId === 'podModal' && typeof pod.clearPODForm === 'function') pod.clearPODForm();
                    }
                }
            });
        } catch (error) { 
            console.error("Error fatal durante la inicialización:", error); 
            document.body.innerHTML = `<div style="padding:20px; text-align:center; color:red;"><h1>Error Crítico</h1><p>Ha ocurrido un error al cargar la aplicación. Por favor, intente borrar los datos de navegación (caché y localStorage) para este sitio y recargue la página.</p><pre>${error.stack || error}</pre></div>`; 
        }
    };
    </script>
</body>
</html>
