<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Web - Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
            margin: 0; padding: 20px; box-sizing: border-box; transition: background-color 0.5s ease;
        }

        .container, .dashboard-container, .contacts-container, .new-shipment-container { /* Añadido .new-shipment-container */
            background-color: #fff; padding: 30px 40px; border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); width: 500px; /* Ancho ajustado */
            text-align: center; margin-top: 20px; margin-bottom: 20px;
        }

        .container h2, .dashboard-container h2, .contacts-container h2, .new-shipment-container h2 {
            margin-top: 0; margin-bottom: 25px; color: #333; font-weight: 600;
        }
        .new-shipment-container h3 { /* Títulos para pasos */
            margin-top: 20px; margin-bottom: 15px; color: #007bff; font-size: 1.3em;
            border-bottom: 1px solid #eee; padding-bottom: 10px;
        }


        label { /* Estilo general para labels */
            display: block; text-align: left; margin-bottom: 6px; color: #555;
            font-weight: 500; font-size: 14px;
        }

        input[type="text"], input[type="password"], input[type="email"],
        input[type="tel"], input[type="number"], select, textarea { /* Estilo general para inputs */
            width: calc(100% - 24px); padding: 12px; margin-bottom: 18px;
            border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 15px;
        }
        textarea { resize: vertical; min-height: 80px;}

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        button, .button { /* Clase .button para enlaces que parecen botones */
            width: auto; /* Ajuste para botones no full-width */
            padding: 10px 20px; background-color: #007bff; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
            font-weight: 500; transition: background-color 0.3s ease; margin-top: 10px;
            text-decoration: none; display: inline-block;
        }
        button:hover, .button:hover { background-color: #0056b3; }

        .form-full-width-btn { width: 100%; padding: 12px; } /* Para botones que sí deben ser anchos */

        .button-secondary { background-color: #6c757d; }
        .button-secondary:hover { background-color: #5a6268; }
        .button-success { background-color: #28a745; } /* Verde para guardar/finalizar */
        .button-success:hover { background-color: #218838; }


        .message { margin-top:18px; font-size:14px; padding:10px; border-radius:5px; display:none; }
        .message.success { color:#155724; background-color:#d4edda; border:1px solid #c3e6cb; display:block; }
        .message.error { color:#721c24; background-color:#f8d7da; border:1px solid #f5c6cb; display:block; }

        .form-switch-link { display:block; margin-top:20px; font-size:14px; color:#007bff; text-decoration:none; cursor:pointer; }
        .form-switch-link:hover { text-decoration:underline; }

        #loginContainer, #registerContainer, #dashboardContainer, #profileContainer, #contactsContainer, #newShipmentContainer {
            display: none; /* Ocultos por defecto */
        }

        .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; }
        .dashboard-header h2 { margin-bottom:0; margin-right:auto; }
        .dashboard-nav-links { display:flex; gap:15px; }
        .profile-link, .contacts-link { display:inline-flex; align-items:center; padding:8px 15px; background-color:#f8f9fa; border:1px solid #dee2e6; border-radius:20px; text-decoration:none; color:#333; font-size:14px; transition:all 0.2s ease-in-out; }
        .profile-link .icon, .contacts-link .icon { margin-right:5px; }
        .profile-link:hover, .contacts-link:hover { background-color:#e9ecef; border-color:#adb5bd; box-shadow:0 2px 4px rgba(0,0,0,0.05); }

        #welcomeMessage { font-size:18px; color:#333; margin-bottom:30px; line-height:1.6; }
        .dashboard-options { display:flex; justify-content:space-around; gap:20px; margin-top:20px; margin-bottom:30px; }
        .dashboard-card { background-color:#f8f9fa; border:1px solid #e3e6f0; border-radius:8px; padding:20px; text-align:center; width:45%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; transition:transform 0.2s ease,box-shadow 0.2s ease; }
        .dashboard-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
        .dashboard-card h3 { margin-top:0; margin-bottom:10px; font-size:1.1em; color:#007bff; }
        .dashboard-card p { font-size:0.9em; color:#6c757d; margin-bottom:0; }

        /* Contactos (resumido, sin cambios) */
        #addContactFormContainer { background-color:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:25px; border:1px dashed #ccc; }
        .contact-card { background-color:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05); }

        /* Estilos para Formulario de Nuevo Envío */
        .shipment-step { display: none; } /* Ocultar pasos por defecto */
        .shipment-step.active { display: block; } /* Mostrar paso activo */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group-checkbox { display: flex; align-items: center; text-align: left; margin-bottom: 15px; }
        .form-group-checkbox input[type="checkbox"] { width: auto; margin-right: 10px; margin-bottom: 0;}
        .form-group-radio { display: flex; align-items: center; margin-right: 20px;}
        .form-group-radio input[type="radio"] { width: auto; margin-right: 8px; margin-bottom: 0;}
        .radio-group-container { display: flex; flex-wrap: wrap; margin-bottom: 15px; }

        .map-placeholder {
            width: 100%; height: 200px; background-color: #e9ecef; border: 1px dashed #ccc;
            display: flex; justify-content: center; align-items: center;
            color: #6c757d; font-style: italic; margin-bottom: 15px; text-align: center;
        }
        .shipment-buttons { margin-top: 30px; display: flex; justify-content: space-between; }

    </style>
</head>
<body>

    <div id="loginContainer" class="container"><h2>Iniciar Sesión</h2><!-- ... (sin cambios) ... --></div>
    <div id="registerContainer" class="container"><h2>Crear Nueva Cuenta</h2><!-- ... (sin cambios) ... --></div>

    <div id="dashboardContainer" class="dashboard-container">
        <div class="dashboard-header">
            <h2>Panel de Control</h2>
            <div class="dashboard-nav-links">
                <a href="#" id="profileLink" class="profile-link"><span class="icon">👤</span>Mi Perfil</a>
                <a href="#" id="contactsLink" class="contacts-link"><span class="icon">📒</span>Contactos</a>
                <!-- Podríamos añadir "Mis Envíos" aquí en el futuro -->
            </div>
        </div>
        <div id="welcomeMessage"></div>
        <div class="dashboard-options">
            <div class="dashboard-card" id="newShipmentCard"><h3>🚚 NUEVO ENVÍO</h3><p>Gestiona tus nuevos envíos.</p></div>
            <div class="dashboard-card" id="newManagementCard"><h3>⚙️ NUEVA GESTIÓN</h3><p>Administra nuevas gestiones.</p></div>
        </div>
        <button type="button" onclick="handleLogout()" class="button-secondary form-full-width-btn">Cerrar Sesión</button>
    </div>

    <div id="profileContainer" class="container"><h2>Mi Perfil</h2><!-- ... (sin cambios) ... --></div>
    <div id="contactsContainer" class="contacts-container"><h2>Mis Contactos</h2><!-- ... (sin cambios) ... --></div>

    <!-- Contenedor para Nuevo Envío -->
    <div id="newShipmentContainer" class="new-shipment-container">
        <h2>🚚 Nuevo Envío</h2>
        <div id="shipmentMessageArea" class="message"></div>

        <form id="newShipmentForm">
            <!-- Paso 1: Datos del Remitente y Envío -->
            <div id="shipmentStep1" class="shipment-step active">
                <h3>Paso 1: Remitente y Detalles del Paquete</h3>
                <div class="form-group">
                    <label for="shipmentSenderName">Quién envía:</label>
                    <input type="text" id="shipmentSenderName" readonly>
                </div>
                <div class="form-group">
                    <label for="shipmentSenderAddress">Dirección de Recogida:</label>
                    <input type="text" id="shipmentSenderAddress" placeholder="Ej: Calle Falsa 123, Asunción" required>
                </div>
                <div class="form-group">
                    <label for="shipmentSenderPhone">Celular del Remitente:</label>
                    <input type="tel" id="shipmentSenderPhone" readonly>
                </div>
                <div class="form-group">
                    <label>Mapa de Recogida (Asunción por defecto):</label>
                    <div class="map-placeholder">Placeholder para Mapa de Recogida.<br>Coordenadas se ingresarán manualmente por ahora.</div>
                    <label for="pickupLat">Latitud Recogida (simulado):</label>
                    <input type="number" step="any" id="pickupLat" placeholder="Ej: -25.2821">
                    <label for="pickupLng">Longitud Recogida (simulado):</label>
                    <input type="number" step="any" id="pickupLng" placeholder="Ej: -57.6352">
                </div>
                <div class="form-group">
                    <label for="shipmentItemType">¿Qué enviamos?</label>
                    <select id="shipmentItemType">
                        <option value="paquete">Paquete</option>
                        <option value="caja">Caja</option>
                        <option value="sobre">Sobre</option>
                        <option value="bolsa">Bolsa</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shipmentDescription">Descripción del contenido:</label>
                    <textarea id="shipmentDescription" placeholder="Ej: Documentos importantes, Ropa, etc." required></textarea>
                </div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="shipmentIsFragile">
                    <label for="shipmentIsFragile">Marcar si es frágil</label>
                </div>
                <div class="shipment-buttons">
                    <button type="button" onclick="showDashboardView()" class="button-secondary">Cancelar</button>
                    <button type="button" onclick="nextShipmentStep(2)">Siguiente ❯</button>
                </div>
            </div>

            <!-- Paso 2: Datos del Destinatario y Servicio -->
            <div id="shipmentStep2" class="shipment-step">
                <h3>Paso 2: Destinatario y Detalles del Destino</h3>
                <div class="form-group">
                    <label for="shipmentRecipientContact">Destinatario (Seleccionar de contactos):</label>
                    <select id="shipmentRecipientContact">
                        <option value="">-- Seleccionar un contacto --</option>
                        <!-- Opciones de contacto se cargarán aquí -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="shipmentRecipientName">Nombre del Destinatario:</label>
                    <input type="text" id="shipmentRecipientName" placeholder="Nombre completo" required>
                </div>
                <div class="form-group">
                    <label for="shipmentRecipientAddress">Dirección de Entrega:</label>
                    <input type="text" id="shipmentRecipientAddress" placeholder="Ej: Av. Principal 456, Lambaré" required>
                </div>
                <div class="form-group">
                    <label for="shipmentRecipientPhone">Celular del Destinatario:</label>
                    <input type="tel" id="shipmentRecipientPhone" placeholder="09xxxxxxxx" required>
                </div>
                 <div class="form-group">
                    <label>Mapa de Destino:</label>
                    <div class="map-placeholder">Placeholder para Mapa de Destino.<br>Coordenadas se ingresarán manualmente por ahora.</div>
                    <label for="destLat">Latitud Destino (simulado):</label>
                    <input type="number" step="any" id="destLat" placeholder="Ej: -25.3325">
                    <label for="destLng">Longitud Destino (simulado):</label>
                    <input type="number" step="any" id="destLng" placeholder="Ej: -57.5230">
                </div>
                <div class="form-group-checkbox">
                    <input type="checkbox" id="shipmentRoundTrip">
                    <label for="shipmentRoundTrip">¿Servicio de Ida y Vuelta? (Regresar al punto de recogida)</label>
                </div>
                <div class="shipment-buttons">
                    <button type="button" onclick="prevShipmentStep(1)" class="button-secondary">❮ Atrás</button>
                    <button type="button" onclick="nextShipmentStep(3)">Siguiente ❯</button>
                </div>
            </div>

            <!-- Paso 3: Pago y Resumen -->
            <div id="shipmentStep3" class="shipment-step">
                <h3>Paso 3: Pago y Confirmación</h3>
                <div class="form-group">
                    <label>Forma de Pago:</label>
                    <div class="radio-group-container">
                        <div class="form-group-radio"><input type="radio" id="paymentQR" name="paymentMethod" value="QR" checked><label for="paymentQR">QR</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentTransfer" name="paymentMethod" value="Transferencia"><label for="paymentTransfer">Transferencia</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentCash" name="paymentMethod" value="Efectivo"><label for="paymentCash">Efectivo</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentAtDestination" name="paymentMethod" value="PagoEnDestino"><label for="paymentAtDestination">Pago en Destino</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="shipmentDistance">Distancia Estimada del Envío (km) - <span style="font-weight:bold; color:red;">INGRESO MANUAL POR AHORA:</span></label>
                    <input type="number" id="shipmentDistance" min="0" step="0.1" placeholder="Ej: 15.5" required>
                </div>
                <div class="form-group">
                    <label for="shipmentServiceCost">Monto del Servicio (Gs.):</label>
                    <input type="text" id="shipmentServiceCost" readonly style="font-weight:bold; font-size:1.1em; color: green;">
                </div>
                 <div class="form-group">
                    <label>Resumen del Envío:</label>
                    <div id="shipmentSummary" style="padding:10px; border:1px solid #eee; background-color:#f9f9f9; text-align:left; font-size:0.9em; min-height: 50px;">
                        Aquí se mostrará un breve resumen antes de guardar...
                    </div>
                </div>
                <div class="shipment-buttons">
                    <button type="button" onclick="prevShipmentStep(2)" class="button-secondary">❮ Atrás</button>
                    <button type="button" onclick="handleSaveShipment()" class="button-success">Guardar Envío ✔</button>
                </div>
            </div>
        </form>
        <a href="#" onclick="showDashboardView(); return false;" class="form-switch-link" style="margin-top: 30px;">Volver al Panel (sin guardar)</a>
    </div>

    <script>
        // --- Constantes y Globales ---
        const USERS_STORAGE_KEY = 'registeredUsers';
        let users = [];
        let currentUser = null;
        let currentShipmentStep = 1; // Para el formulario de envío

        // --- DOM Elements --- (Resumido para brevedad, son los mismos más los nuevos)
        // ... (Todos los selectores anteriores) ...
        const newShipmentContainer = document.getElementById('newShipmentContainer');
        const newShipmentForm = document.getElementById('newShipmentForm');
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        // Paso 1
        const shipmentSenderNameInput = document.getElementById('shipmentSenderName');
        const shipmentSenderAddressInput = document.getElementById('shipmentSenderAddress');
        const shipmentSenderPhoneInput = document.getElementById('shipmentSenderPhone');
        const shipmentItemTypeSelect = document.getElementById('shipmentItemType');
        const shipmentDescriptionTextarea = document.getElementById('shipmentDescription');
        const shipmentIsFragileCheckbox = document.getElementById('shipmentIsFragile');
        const pickupLatInput = document.getElementById('pickupLat'); // Simulado
        const pickupLngInput = document.getElementById('pickupLng'); // Simulado
        // Paso 2
        const shipmentRecipientContactSelect = document.getElementById('shipmentRecipientContact');
        const shipmentRecipientNameInput = document.getElementById('shipmentRecipientName');
        const shipmentRecipientAddressInput = document.getElementById('shipmentRecipientAddress');
        const shipmentRecipientPhoneInput = document.getElementById('shipmentRecipientPhone');
        const shipmentRoundTripCheckbox = document.getElementById('shipmentRoundTrip');
        const destLatInput = document.getElementById('destLat'); // Simulado
        const destLngInput = document.getElementById('destLng'); // Simulado
        // Paso 3
        const shipmentDistanceInput = document.getElementById('shipmentDistance');
        const shipmentServiceCostInput = document.getElementById('shipmentServiceCost');
        const shipmentSummaryDiv = document.getElementById('shipmentSummary');

        const newShipmentCard = document.getElementById('newShipmentCard'); // Del dashboard


        // --- Utility & View Management --- (Reutilizar de antes, con adiciones)
        function showView(viewToShow) {
            [loginContainer, registerContainer, dashboardContainer, profileContainer, contactsContainer, newShipmentContainer].forEach(c => c.style.display = 'none');
            if (viewToShow) viewToShow.style.display = 'block';
        }
        // ... (showLoginView, showRegisterView, showDashboardView, showProfileView, showContactsView - sin cambios directos)

        function showNewShipmentView() {
            if (!currentUser) { showLoginView(); return; }
            showView(newShipmentContainer);
            _resetShipmentForm(); // Limpiar y resetear el formulario a su estado inicial
            currentShipmentStep = 1;
            updateShipmentStepView();
            // Pre-rellenar datos del remitente
            shipmentSenderNameInput.value = currentUser.name || '';
            shipmentSenderPhoneInput.value = currentUser.phone || '';
            // Cargar contactos para el destinatario
            _loadContactsForShipment();
            clearMessage(shipmentMessageArea);
        }

        function _resetShipmentForm() {
            newShipmentForm.reset(); // Resetea valores de campos de formulario
            shipmentSenderNameInput.value = currentUser.name || ''; // Rellenar nuevamente
            shipmentSenderPhoneInput.value = currentUser.phone || '';
            shipmentServiceCostInput.value = '';
            shipmentSummaryDiv.innerHTML = 'Aquí se mostrará un breve resumen antes de guardar...';
            currentShipmentStep = 1;
            updateShipmentStepView();
            clearMessage(shipmentMessageArea);
        }

        // --- User, Data, Login, Register, Profile, Contacts Logic ---
        // ... (Mantener todas las funciones previas: loadUsers, saveUsers, updateUserInLocalStorage, etc.)
        // La estructura de 'users' y 'currentUser' debe incluir 'points' y 'shipments'
         function loadUsers() {
            const storedUsers = localStorage.getItem(USERS_STORAGE_KEY);
            if (storedUsers) {
                users = JSON.parse(storedUsers).map(user => ({
                    ...user,
                    contacts: user.contacts || [],
                    shipments: user.shipments || [], // Nuevo: array para envíos
                    points: user.points || 0         // Nuevo: puntos del usuario
                }));
            } else { // Usuario Demo con nuevos campos
                users = [{
                    name: "Usuario Demo", username: "demo", email: "demo@example.com",
                    phone: "0900000000", password: "demo", contacts: [], shipments: [], points: 0
                }];
                saveUsers();
            }
            // Resto de loadUsers como antes...
             const loggedInUsername = sessionStorage.getItem('loggedInUser');
            if (loggedInUsername) {
                currentUser = users.find(u => u.username === loggedInUsername);
                if (currentUser) {
                    currentUser.contacts = currentUser.contacts || [];
                    currentUser.shipments = currentUser.shipments || [];
                    currentUser.points = currentUser.points || 0;
                    showDashboardView();
                } else { sessionStorage.removeItem('loggedInUser'); showLoginView(); }
            } else { showLoginView(); }
        }
        // Asegurarse de que al registrar un nuevo usuario también se inicialicen 'shipments' y 'points'
        function handleRegister() {
            // ... (validaciones como antes) ...
            if (users.some(u => u.username === username)) { /* ... */ }
            if (users.some(u => u.email === email)) { /* ... */ }

            users.push({ name, username, email, phone, password, contacts: [], shipments: [], points: 0 }); // Añadir shipments y points
            saveUsers();
            // ... (resto como antes)
        }


        // --- New Shipment Form Logic ---
        function updateShipmentStepView() {
            document.querySelectorAll('.shipment-step').forEach(step => step.classList.remove('active'));
            const activeStep = document.getElementById(`shipmentStep${currentShipmentStep}`);
            if (activeStep) activeStep.classList.add('active');
        }

        function nextShipmentStep(nextStep) {
            // Validaciones para el paso actual antes de avanzar
            if (currentShipmentStep === 1) {
                if (!shipmentSenderAddressInput.value.trim() || !shipmentDescriptionTextarea.value.trim()) {
                    showMessage(shipmentMessageArea, "Por favor, completa la dirección de recogida y la descripción del paquete.", "error");
                    return;
                }
            }
            if (currentShipmentStep === 2) {
                 if (!shipmentRecipientNameInput.value.trim() || !shipmentRecipientAddressInput.value.trim() || !shipmentRecipientPhoneInput.value.trim()) {
                    showMessage(shipmentMessageArea, "Por favor, completa todos los datos del destinatario.", "error");
                    return;
                }
                // Si llegas al paso 3, calcula el costo inicial (asumiendo que hay distancia)
                 calculateServiceCost(); // Calcular y mostrar
                 updateShipmentSummary(); // Actualizar el resumen
            }
            clearMessage(shipmentMessageArea);
            currentShipmentStep = nextStep;
            updateShipmentStepView();
            window.scrollTo(0,0); // Scroll al inicio del form
        }

        function prevShipmentStep(prevStep) {
            clearMessage(shipmentMessageArea);
            currentShipmentStep = prevStep;
            updateShipmentStepView();
             window.scrollTo(0,0);
        }

        function _loadContactsForShipment() {
            shipmentRecipientContactSelect.innerHTML = '<option value="">-- Seleccionar un contacto --</option>';
            if (currentUser && currentUser.contacts && currentUser.contacts.length > 0) {
                currentUser.contacts.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.id;
                    option.textContent = contact.name;
                    shipmentRecipientContactSelect.appendChild(option);
                });
            }
        }

        shipmentRecipientContactSelect.addEventListener('change', function() {
            const selectedContactId = this.value;
            if (selectedContactId && currentUser && currentUser.contacts) {
                const contact = currentUser.contacts.find(c => c.id === selectedContactId);
                if (contact) {
                    shipmentRecipientNameInput.value = contact.name || '';
                    shipmentRecipientAddressInput.value = contact.address || '';
                    shipmentRecipientPhoneInput.value = contact.phone || '';
                }
            } else { // Si se deselecciona o no se encuentra
                shipmentRecipientNameInput.value = '';
                shipmentRecipientAddressInput.value = '';
                shipmentRecipientPhoneInput.value = '';
            }
        });

        shipmentDistanceInput.addEventListener('input', calculateServiceCost); // Calcular al cambiar distancia

        function calculateServiceCost() {
            const distanceStr = shipmentDistanceInput.value;
            if (distanceStr === "" || isNaN(parseFloat(distanceStr))) {
                shipmentServiceCostInput.value = "";
                return;
            }
            const distance = parseFloat(distanceStr);
            let cost = 0;

            if (distance <= 0) {
                cost = 0;
            } else if (distance <= 10) {
                cost = 25000;
            } else if (distance <= 20) {
                cost = 40000;
            } else { // Más de 20 km
                cost = 60000;
            }
            shipmentServiceCostInput.value = cost > 0 ? cost.toLocaleString('es-PY') : ""; // Formato Gs.
            updateShipmentSummary(); // También actualiza el resumen cuando cambia el costo
        }
        function updateShipmentSummary() {
            if (currentShipmentStep !== 3) return; // Solo actualiza en el paso 3

            let summaryHTML = "<h4>Resumen del Envío:</h4>";
            summaryHTML += `<p><strong>Remitente:</strong> ${shipmentSenderNameInput.value} (${shipmentSenderAddressInput.value})</p>`;
            summaryHTML += `<p><strong>Destinatario:</strong> ${shipmentRecipientNameInput.value} (${shipmentRecipientAddressInput.value})</p>`;
            summaryHTML += `<p><strong>Tipo:</strong> ${shipmentItemTypeSelect.options[shipmentItemTypeSelect.selectedIndex].text}, ${shipmentDescriptionTextarea.value.substring(0,30)}...</p>`;
            if (shipmentIsFragileCheckbox.checked) summaryHTML += `<p><strong style='color:red;'>¡FRÁGIL!</strong></p>`;
            if (shipmentRoundTripCheckbox.checked) summaryHTML += `<p><strong>Servicio:</strong> Ida y Vuelta</p>`;
            summaryHTML += `<p><strong>Distancia Aprox.:</strong> ${shipmentDistanceInput.value || 'N/A'} km</p>`;
            summaryHTML += `<p><strong>Costo del Servicio:</strong> Gs. ${shipmentServiceCostInput.value || 'N/A'}</p>`;
            summaryHTML += `<p><strong>Forma de Pago:</strong> ${document.querySelector('input[name="paymentMethod"]:checked')?.parentElement.textContent || 'N/A'}</p>`;

            shipmentSummaryDiv.innerHTML = summaryHTML;
        }


        function handleSaveShipment() {
            clearMessage(shipmentMessageArea);
            // Validaciones finales (aunque muchas se hicieron al pasar de paso)
            if (currentShipmentStep !== 3) {
                showMessage(shipmentMessageArea, "Completa todos los pasos primero.", "error");
                return;
            }
            const distance = parseFloat(shipmentDistanceInput.value);
            const cost = shipmentServiceCostInput.value; // Ya está formateado, pero mejor guardarlo numérico

            if (isNaN(distance) || distance <= 0 || !cost) {
                showMessage(shipmentMessageArea, "Ingresa una distancia válida para calcular el costo.", "error");
                shipmentDistanceInput.focus();
                return;
            }

            // Recopilar todos los datos
            const newShipmentData = {
                id: Date.now().toString(),
                status: "Pendiente", // Estado inicial
                createdAt: new Date().toISOString(),
                sender: {
                    name: shipmentSenderNameInput.value,
                    address: shipmentSenderAddressInput.value,
                    phone: shipmentSenderPhoneInput.value,
                    pickupLat: pickupLatInput.value || null, // Guardar coords simuladas
                    pickupLng: pickupLngInput.value || null
                },
                recipient: {
                    name: shipmentRecipientNameInput.value,
                    address: shipmentRecipientAddressInput.value,
                    phone: shipmentRecipientPhoneInput.value,
                    destLat: destLatInput.value || null,
                    destLng: destLngInput.value || null
                },
                item: {
                    type: shipmentItemTypeSelect.value,
                    description: shipmentDescriptionTextarea.value,
                    isFragile: shipmentIsFragileCheckbox.checked
                },
                service: {
                    roundTrip: shipmentRoundTripCheckbox.checked,
                    distanceKm: distance,
                    // Para el costo, es mejor parsear el valor formateado
                    costGs: parseFloat(shipmentServiceCostInput.value.replace(/\./g, '').replace(/,/g, '.')) || 0
                },
                payment: {
                    method: document.querySelector('input[name="paymentMethod"]:checked').value
                }
            };

            currentUser.shipments.push(newShipmentData);
            currentUser.points += 10; // Añadir puntos
            updateUserInLocalStorage(); // Guarda el usuario con el nuevo envío y puntos

            showMessage(shipmentMessageArea, `¡Envío guardado con éxito! ID: ${newShipmentData.id}. Has ganado 10 puntos. Total Puntos: ${currentUser.points}`, "success");
            _resetShipmentForm();

            // Opcional: Después de unos segundos, volver al dashboard
            setTimeout(() => {
                if (newShipmentContainer.style.display === 'block'){ // solo si aún está en la vista
                     showDashboardView();
                }
            }, 3000);
        }

        // --- Event Listeners (Globales) ---
        // ... (login, register, profile, contacts links como antes) ...
        newShipmentCard.addEventListener('click', (e) => { e.preventDefault(); showNewShipmentView(); });


        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
             // Definir Selectores del DOM globales aquí si no se definieron antes
            // para login, register, profile, contacts etc.
            // Para mantener la brevedad no los repito, pero deben estar presentes y definidos globalmente.
            const loginContainer = document.getElementById('loginContainer');
            const registerContainer = document.getElementById('registerContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            const profileContainer = document.getElementById('profileContainer');
            const contactsContainer = document.getElementById('contactsContainer');

            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const profileForm = document.getElementById('profileForm');
            const addContactForm = document.getElementById('addContactForm');

            const loginUsernameInput = document.getElementById('loginUsername');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginMessageArea = document.getElementById('loginMessageArea');

            const registerNameInput = document.getElementById('registerName');
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerEmailInput = document.getElementById('registerEmail');
            const registerPhoneInput = document.getElementById('registerPhone');
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
            const registerMessageArea = document.getElementById('registerMessageArea');

            const welcomeMessageElement = document.getElementById('welcomeMessage');
            const profileLink = document.getElementById('profileLink');
            const contactsLink = document.getElementById('contactsLink');

            const profileNameInput = document.getElementById('profileName');
            const profileUsernameInput = document.getElementById('profileUsername');
            const profileEmailInput = document.getElementById('profileEmail');
            const profilePhoneInput = document.getElementById('profilePhone');
            const profileNewPasswordInput = document.getElementById('profileNewPassword');
            const profileConfirmNewPasswordInput = document.getElementById('profileConfirmNewPassword');
            const profileMessageArea = document.getElementById('profileMessageArea');
            const backToDashboardFromProfile = document.getElementById('backToDashboardFromProfile');

            const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
            const addContactFormContainer = document.getElementById('addContactFormContainer');
            const contactNameInput = document.getElementById('contactName');
            const contactAddressInput = document.getElementById('contactAddress');
            const contactPhoneInput = document.getElementById('contactPhone');
            const contactFormMessageArea = document.getElementById('contactFormMessageArea');
            const contactListArea = document.getElementById('contactListArea');
            const backToDashboardFromContacts = document.getElementById('backToDashboardFromContacts');

            const showRegisterLink = document.getElementById('showRegisterLink');
            const showLoginLink = document.getElementById('showLoginLink');
            loadUsers();

             // Event Listeners específicos de cada sección
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterView(); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginView(); });
            profileLink.addEventListener('click', (e) => { e.preventDefault(); showProfileView(); });
            contactsLink.addEventListener('click', (e) => { e.preventDefault(); showContactsView(); });
            backToDashboardFromProfile.addEventListener('click', (e) => { e.preventDefault(); showDashboardView(); });
            backToDashboardFromContacts.addEventListener('click', (e) => { e.preventDefault(); showDashboardView(); });
            if (toggleAddContactFormBtn) toggleAddContactFormBtn.addEventListener('click', toggleAddContactForm); //toggleAddContactForm

             // Enter keys...
            loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }});
            // Añadir resto de listeners para Enter si son necesarios y no están
        });
        // --- Pegar aquí las funciones JS previas que faltan (showMessage, _resetContactFormToDefault, handleRegister, etc. para Contacts y Profile si no están completas arriba) ---
        // Solo para estar seguro de que tienes todas las funciones necesarias:
        // Asegúrate de incluir aquí las definiciones completas de:
        // showMessage, clearMessage
        // _resetContactFormToDefault, toggleAddContactForm, handleAddContact, renderContacts, handleEditContact, handleUpdateExistingContact, handleDeleteContact
        // handleUpdateProfile
        // ... Y cualquier otra función helper o de manejo de eventos que se haya definido en pasos anteriores.

        // Esta versión del script está autocontenida con todo lo del nuevo envío
        // + placeholders para funciones previas, si quieres unificar el script, tendrías que pegar el resto.
        // Dado el mensaje, parece que preferías mantener las funciones que no cambiaron, pero
        // el código anterior SÍ depende de ellas. Por seguridad, las incluyo (reducidas) o las referencia.
        // A continuación, las funciones de Profile y Contacts que son necesarias (pueden ser placeholders si ya las tienes definidas):

        function _resetContactFormToDefault() {
             if (!addContactForm) return; // Chequeo por si el elemento no existe en esta vista
             addContactForm.reset();
             const saveButton = addContactFormContainer.querySelector('form#addContactForm button');
             if(saveButton){
                saveButton.textContent = 'Guardar Contacto';
                saveButton.onclick = handleAddContact;
             }
             delete addContactFormContainer.dataset.editingId;
             clearMessage(contactFormMessageArea);
        }
        function toggleAddContactForm() { if(addContactFormContainer){ /*...Lógica de toggle...*/ } }
        function handleAddContact() { /*...Lógica...*/ }
        function renderContacts() { /*...Lógica...*/ }
        function handleEditContact(id) { /*...Lógica...*/ }
        function handleUpdateExistingContact(id) { /*...Lógica...*/ }
        function handleDeleteContact(id) { /*...Lógica...*/ }
        function handleUpdateProfile() { /*...Lógica...*/ }


    </script>
</body>
</html>
