<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Web - Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
            margin: 0; padding: 20px; box-sizing: border-box; transition: background-color 0.5s ease;
        }

        .container, .dashboard-container, .contacts-container, .new-shipment-container {
            background-color: #fff; padding: 30px 40px; border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); width: 500px;
            text-align: center; margin-top: 20px; margin-bottom: 20px;
        }

        .container h2, .dashboard-container h2, .contacts-container h2, .new-shipment-container h2 {
            margin-top: 0; margin-bottom: 25px; color: #333; font-weight: 600;
        }
        .new-shipment-container h3 {
            margin-top: 20px; margin-bottom: 15px; color: #007bff; font-size: 1.3em;
            border-bottom: 1px solid #eee; padding-bottom: 10px;
        }

        label {
            display: block; text-align: left; margin-bottom: 6px; color: #555;
            font-weight: 500; font-size: 14px;
        }

        input[type="text"], input[type="password"], input[type="email"],
        input[type="tel"], input[type="number"], select, textarea {
            width: calc(100% - 24px); padding: 12px; margin-bottom: 18px;
            border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 15px;
        }
        textarea { resize: vertical; min-height: 80px;}

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        button, .button {
            width: auto; padding: 10px 20px; background-color: #007bff; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
            font-weight: 500; transition: background-color 0.3s ease; margin-top: 10px;
            text-decoration: none; display: inline-block;
        }
        button:hover, .button:hover { background-color: #0056b3; }

        .form-full-width-btn { width: 100%; padding: 12px; }

        .button-secondary { background-color: #6c757d; }
        .button-secondary:hover { background-color: #5a6268; }
        .button-success { background-color: #28a745; }
        .button-success:hover { background-color: #218838; }


        .message { margin-top:18px; font-size:14px; padding:10px; border-radius:5px; display:none; }
        .message.success { color:#155724; background-color:#d4edda; border:1px solid #c3e6cb; display:block; }
        .message.error { color:#721c24; background-color:#f8d7da; border:1px solid #f5c6cb; display:block; }

        .form-switch-link { display:block; margin-top:20px; font-size:14px; color:#007bff; text-decoration:none; cursor:pointer; }
        .form-switch-link:hover { text-decoration:underline; }

        #loginContainer, #registerContainer, #dashboardContainer, #profileContainer, #contactsContainer, #newShipmentContainer {
            display: none;
        }

        .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; }
        .dashboard-header h2 { margin-bottom:0; margin-right:auto; }
        .dashboard-nav-links { display:flex; gap:15px; }
        .profile-link, .contacts-link { display:inline-flex; align-items:center; padding:8px 15px; background-color:#f8f9fa; border:1px solid #dee2e6; border-radius:20px; text-decoration:none; color:#333; font-size:14px; transition:all 0.2s ease-in-out; }
        .profile-link .icon, .contacts-link .icon { margin-right:5px; }
        .profile-link:hover, .contacts-link:hover { background-color:#e9ecef; border-color:#adb5bd; box-shadow:0 2px 4px rgba(0,0,0,0.05); }

        #welcomeMessage { font-size:18px; color:#333; margin-bottom:30px; line-height:1.6; }
        .dashboard-options { display:flex; justify-content:space-around; gap:20px; margin-top:20px; margin-bottom:30px; }
        .dashboard-card { background-color:#f8f9fa; border:1px solid #e3e6f0; border-radius:8px; padding:20px; text-align:center; width:45%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; transition:transform 0.2s ease,box-shadow 0.2s ease; }
        .dashboard-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
        .dashboard-card h3 { margin-top:0; margin-bottom:10px; font-size:1.1em; color:#007bff; }
        .dashboard-card p { font-size:0.9em; color:#6c757d; margin-bottom:0; }

        /* Contactos */
        #addContactFormContainer { background-color:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:25px; border:1px dashed #ccc; }
        #contactListArea { margin-top: 20px; text-align: left; }
        .contact-card {
            background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .contact-card-info strong { color: #007bff; }
        .contact-card-info p { margin: 5px 0; font-size: 0.95em; color: #555; }
        .contact-card-actions {
            margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px;
            display: flex; justify-content: flex-end; gap: 10px;
        }
        .contact-card-actions button { padding: 6px 12px; font-size: 0.85em; width: auto; margin-top: 0;}
        .contact-card-actions .edit-btn { background-color: #ffc107; color: #333; }
        .contact-card-actions .edit-btn:hover { background-color: #e0a800; }
        .contact-card-actions .delete-btn { background-color: #dc3545; }
        .contact-card-actions .delete-btn:hover { background-color: #c82333; }
        .no-contacts { text-align:center; color:#777; padding:20px; border:1px dashed #ddd; border-radius:5px; background-color:#f9f9f9; }

        /* Estilos para Formulario de Nuevo Env√≠o */
        .shipment-step { display: none; }
        .shipment-step.active { display: block; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group-checkbox { display: flex; align-items: center; text-align: left; margin-bottom: 15px; }
        .form-group-checkbox input[type="checkbox"] { width: auto; margin-right: 10px; margin-bottom: 0;}
        .form-group-radio { display: flex; align-items: center; margin-right: 20px;}
        .form-group-radio input[type="radio"] { width: auto; margin-right: 8px; margin-bottom: 0;}
        .radio-group-container { display: flex; flex-wrap: wrap; margin-bottom: 15px; }

        .map-placeholder {
            width: 100%; height: 200px; background-color: #e9ecef; border: 1px dashed #ccc;
            display: flex; justify-content: center; align-items: center;
            color: #6c757d; font-style: italic; margin-bottom: 15px; text-align: center;
        }
        .shipment-buttons { margin-top: 30px; display: flex; justify-content: space-between; }

    </style>
</head>
<body>

    <div id="loginContainer" class="container">
        <h2>Iniciar Sesi√≥n</h2>
        <form id="loginForm">
            <div><label for="loginUsername">Usuario:</label><input type="text" id="loginUsername" required></div>
            <div><label for="loginPassword">Contrase√±a:</label><input type="password" id="loginPassword" required></div>
            <button type="button" onclick="handleLogin()" class="form-full-width-btn">Entrar</button>
        </form>
        <div id="loginMessageArea" class="message"></div>
        <a href="#" id="showRegisterLink" class="form-switch-link">¬øNo tienes cuenta? Reg√≠strate aqu√≠</a>
    </div>

    <div id="registerContainer" class="container">
        <h2>Crear Nueva Cuenta</h2>
        <form id="registerForm">
            <div><label for="registerName">Nombre y Apellido:</label><input type="text" id="registerName" required></div>
            <div><label for="registerUsername">Usuario:</label><input type="text" id="registerUsername" required></div>
            <div><label for="registerEmail">Correo Electr√≥nico:</label><input type="email" id="registerEmail" required></div>
            <div><label for="registerPhone">Celular (Ej: 0981xxxxxx):</label><input type="tel" id="registerPhone" placeholder="09xxxxxxxx" required></div>
            <div><label for="registerPassword">Contrase√±a (m√≠n. 8 caracteres):</label><input type="password" id="registerPassword" required></div>
            <div><label for="registerConfirmPassword">Confirmar Contrase√±a:</label><input type="password" id="registerConfirmPassword" required></div>
            <button type="button" onclick="handleRegister()" class="form-full-width-btn">Registrar</button>
        </form>
        <div id="registerMessageArea" class="message"></div>
        <a href="#" id="showLoginLink" class="form-switch-link">¬øYa tienes cuenta? Inicia Sesi√≥n</a>
    </div>

    <div id="dashboardContainer" class="dashboard-container">
        <div class="dashboard-header">
            <h2>Panel de Control</h2>
            <div class="dashboard-nav-links">
                <a href="#" id="profileLink" class="profile-link"><span class="icon">üë§</span>Mi Perfil</a>
                <a href="#" id="contactsLink" class="contacts-link"><span class="icon">üìí</span>Contactos</a>
            </div>
        </div>
        <div id="welcomeMessage"></div>
        <div class="dashboard-options">
            <div class="dashboard-card" id="newShipmentCard"><h3>üöö NUEVO ENV√çO</h3><p>Gestiona tus nuevos env√≠os.</p></div>
            <div class="dashboard-card" id="newManagementCard"><h3>‚öôÔ∏è NUEVA GESTI√ìN</h3><p>Administra nuevas gestiones.</p></div>
        </div>
        <button type="button" onclick="handleLogout()" class="button-secondary form-full-width-btn">Cerrar Sesi√≥n</button>
    </div>

    <div id="profileContainer" class="container">
        <h2>Mi Perfil</h2>
        <form id="profileForm">
            <div><label for="profileName">Nombre y Apellido:</label><input type="text" id="profileName" required></div>
            <div><label for="profileUsername">Usuario (no editable):</label><input type="text" id="profileUsername" readonly disabled></div>
            <div><label for="profileEmail">Correo Electr√≥nico:</label><input type="email" id="profileEmail" required></div>
            <div><label for="profilePhone">Celular:</label><input type="tel" id="profilePhone" placeholder="09xxxxxxxx" required></div>
            <div><label for="profileNewPassword">Nueva Contrase√±a (vac√≠o = no cambiar):</label><input type="password" id="profileNewPassword"></div>
            <div><label for="profileConfirmNewPassword">Confirmar Nueva Contrase√±a:</label><input type="password" id="profileConfirmNewPassword"></div>
            <button type="button" onclick="handleUpdateProfile()" class="form-full-width-btn button-success">Guardar Cambios</button>
        </form>
        <div id="profileMessageArea" class="message"></div>
        <a href="#" id="backToDashboardFromProfile" class="form-switch-link">Volver al Panel</a>
    </div>

    <div id="contactsContainer" class="contacts-container">
        <h2>Mis Contactos</h2>
        <button type="button" id="toggleAddContactFormBtn" class="form-full-width-btn button-success" style="margin-bottom: 20px;">‚úö Agregar Nuevo Contacto</button>
        <div id="addContactFormContainer" style="display: none;">
            <h3>Nuevo Contacto</h3>
            <form id="addContactForm">
                <div><label for="contactName">Nombre y Apellido:</label><input type="text" id="contactName" required></div>
                <div><label for="contactAddress">Direcci√≥n:</label><input type="text" id="contactAddress" required></div>
                <div><label for="contactPhone">Celular:</label><input type="tel" id="contactPhone" placeholder="09xxxxxxxx" required></div>
                <button type="button" onclick="handleAddContact()" class="form-full-width-btn">Guardar Contacto</button>
            </form>
            <div id="contactFormMessageArea" class="message"></div>
        </div>
        <div id="contactListArea"></div>
        <a href="#" id="backToDashboardFromContacts" class="form-switch-link" style="margin-top: 30px;">Volver al Panel</a>
    </div>

    <div id="newShipmentContainer" class="new-shipment-container">
        <h2>üöö Nuevo Env√≠o</h2>
        <div id="shipmentMessageArea" class="message"></div>
        <form id="newShipmentForm">
            <div id="shipmentStep1" class="shipment-step active">
                <h3>Paso 1: Remitente y Detalles del Paquete</h3>
                <div class="form-group"><label for="shipmentSenderName">Qui√©n env√≠a:</label><input type="text" id="shipmentSenderName" readonly></div>
                <div class="form-group"><label for="shipmentSenderAddress">Direcci√≥n de Recogida:</label><input type="text" id="shipmentSenderAddress" placeholder="Ej: Calle Falsa 123, Asunci√≥n" required></div>
                <div class="form-group"><label for="shipmentSenderPhone">Celular del Remitente:</label><input type="tel" id="shipmentSenderPhone" readonly></div>
                <div class="form-group">
                    <label>Mapa de Recogida (Asunci√≥n por defecto):</label>
                    <div class="map-placeholder">Placeholder para Mapa de Recogida.<br>Coordenadas (simulado).</div>
                    <label for="pickupLat">Latitud Recogida:</label><input type="number" step="any" id="pickupLat" placeholder="Ej: -25.2821">
                    <label for="pickupLng">Longitud Recogida:</label><input type="number" step="any" id="pickupLng" placeholder="Ej: -57.6352">
                </div>
                <div class="form-group">
                    <label for="shipmentItemType">¬øQu√© enviamos?</label>
                    <select id="shipmentItemType">
                        <option value="paquete">Paquete</option><option value="caja">Caja</option><option value="sobre">Sobre</option>
                        <option value="bolsa">Bolsa</option><option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group"><label for="shipmentDescription">Descripci√≥n del contenido:</label><textarea id="shipmentDescription" placeholder="Ej: Documentos importantes, Ropa, etc." required></textarea></div>
                <div class="form-group-checkbox"><input type="checkbox" id="shipmentIsFragile"><label for="shipmentIsFragile">Marcar si es fr√°gil</label></div>
                <div class="shipment-buttons">
                    <button type="button" onclick="showDashboardView()" class="button-secondary">Cancelar</button>
                    <button type="button" onclick="nextShipmentStep(2)">Siguiente ‚ùØ</button>
                </div>
            </div>
            <div id="shipmentStep2" class="shipment-step">
                <h3>Paso 2: Destinatario y Detalles del Destino</h3>
                <div class="form-group">
                    <label for="shipmentRecipientContactSelect">Destinatario (Seleccionar de contactos):</label>
                    <select id="shipmentRecipientContactSelect"><option value="">-- Seleccionar un contacto --</option></select>
                </div>
                <div class="form-group"><label for="shipmentRecipientName">Nombre del Destinatario:</label><input type="text" id="shipmentRecipientName" placeholder="Nombre completo" required></div>
                <div class="form-group"><label for="shipmentRecipientAddress">Direcci√≥n de Entrega:</label><input type="text" id="shipmentRecipientAddress" placeholder="Ej: Av. Principal 456, Lambar√©" required></div>
                <div class="form-group"><label for="shipmentRecipientPhone">Celular del Destinatario:</label><input type="tel" id="shipmentRecipientPhone" placeholder="09xxxxxxxx" required></div>
                 <div class="form-group">
                    <label>Mapa de Destino:</label>
                    <div class="map-placeholder">Placeholder para Mapa de Destino.<br>Coordenadas (simulado).</div>
                    <label for="destLat">Latitud Destino:</label><input type="number" step="any" id="destLat" placeholder="Ej: -25.3325">
                    <label for="destLng">Longitud Destino:</label><input type="number" step="any" id="destLng" placeholder="Ej: -57.5230">
                </div>
                <div class="form-group-checkbox"><input type="checkbox" id="shipmentRoundTrip"><label for="shipmentRoundTrip">¬øServicio de Ida y Vuelta?</label></div>
                <div class="shipment-buttons">
                    <button type="button" onclick="prevShipmentStep(1)" class="button-secondary">‚ùÆ Atr√°s</button>
                    <button type="button" onclick="nextShipmentStep(3)">Siguiente ‚ùØ</button>
                </div>
            </div>
            <div id="shipmentStep3" class="shipment-step">
                <h3>Paso 3: Pago y Confirmaci√≥n</h3>
                <div class="form-group">
                    <label>Forma de Pago:</label>
                    <div class="radio-group-container">
                        <div class="form-group-radio"><input type="radio" id="paymentQR" name="paymentMethod" value="QR" checked><label for="paymentQR">QR</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentTransfer" name="paymentMethod" value="Transferencia"><label for="paymentTransfer">Transferencia</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentCash" name="paymentMethod" value="Efectivo"><label for="paymentCash">Efectivo</label></div>
                        <div class="form-group-radio"><input type="radio" id="paymentAtDestination" name="paymentMethod" value="PagoEnDestino"><label for="paymentAtDestination">Pago en Destino</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="shipmentDistance">Distancia Estimada (km) - <span style="font-weight:bold; color:red;">INGRESO MANUAL:</span></label>
                    <input type="number" id="shipmentDistance" min="0" step="0.1" placeholder="Ej: 15.5" required>
                </div>
                <div class="form-group">
                    <label for="shipmentServiceCost">Monto del Servicio (Gs.):</label>
                    <input type="text" id="shipmentServiceCost" readonly style="font-weight:bold; font-size:1.1em; color: green;">
                </div>
                 <div class="form-group">
                    <label>Resumen del Env√≠o:</label>
                    <div id="shipmentSummary" style="padding:10px; border:1px solid #eee; background-color:#f9f9f9; text-align:left; font-size:0.9em; min-height: 50px;">
                        Aqu√≠ se mostrar√° un breve resumen antes de guardar...
                    </div>
                </div>
                <div class="shipment-buttons">
                    <button type="button" onclick="prevShipmentStep(2)" class="button-secondary">‚ùÆ Atr√°s</button>
                    <button type="button" onclick="handleSaveShipment()" class="button-success">Guardar Env√≠o ‚úî</button>
                </div>
            </div>
        </form>
        <a href="#" onclick="showDashboardView(); return false;" class="form-switch-link" style="margin-top: 30px;">Volver al Panel (sin guardar)</a>
    </div>

    <script>
    // --- Constantes y Variables Globales ---
    const USERS_STORAGE_KEY = 'registeredUsers';
    let users = [];
    let currentUser = null;
    let currentShipmentStep = 1;

    // --- Selectores del DOM (Contenedores Principales de Vista - definidos temprano) ---
    let loginContainer, registerContainer, dashboardContainer, profileContainer, contactsContainer, newShipmentContainer;

    // --- Utility Functions ---
    function showMessage(area, text, type) {
        if (area) {
            area.textContent = text;
            area.className = `message ${type}`;
            area.style.display = 'block';
        } else {
            console.warn("showMessage: el √°rea de mensaje es null para el texto:", text);
        }
    }
    function clearMessage(area) {
        if (area) {
            area.textContent = '';
            area.className = 'message';
            area.style.display = 'none';
        }
    }

    // --- View Management ---
    function showView(viewToShow) {
        const allViews = [loginContainer, registerContainer, dashboardContainer, profileContainer, contactsContainer, newShipmentContainer];
        allViews.forEach(container => {
            if (container) {
                container.style.display = 'none';
            }
        });
        if (viewToShow && allViews.includes(viewToShow)) {
            viewToShow.style.display = 'block';
        } else if (viewToShow) {
            console.error("showView: 'viewToShow' no es un contenedor de vista reconocido:", viewToShow);
        }
    }
    function showLoginView() {
        currentUser = null;
        sessionStorage.removeItem('loggedInUser');
        const loginForm = document.getElementById('loginForm');
        const loginMessageArea = document.getElementById('loginMessageArea');
        showView(loginContainer);
        if (loginMessageArea) clearMessage(loginMessageArea);
        if (loginForm) loginForm.reset();
        console.log("Mostrando vista de Login.");
    }
    function showRegisterView() {
        const registerForm = document.getElementById('registerForm');
        const registerMessageArea = document.getElementById('registerMessageArea');
        showView(registerContainer);
        if (registerMessageArea) clearMessage(registerMessageArea);
        if (registerForm) registerForm.reset();
    }
    function showDashboardView() {
        if (!currentUser) { showLoginView(); return; }
        showView(dashboardContainer);
        updateWelcomeMessage();
    }
    function showProfileView() {
        if (!currentUser) { showLoginView(); return; }
        const profileForm = document.getElementById('profileForm');
        const profileMessageArea = document.getElementById('profileMessageArea');
        const profileNameInput = document.getElementById('profileName');
        const profileUsernameInput = document.getElementById('profileUsername');
        const profileEmailInput = document.getElementById('profileEmail');
        const profilePhoneInput = document.getElementById('profilePhone');
        showView(profileContainer);
        if (profileMessageArea) clearMessage(profileMessageArea);
        if (profileForm) profileForm.reset();
        if(profileNameInput && currentUser) profileNameInput.value = currentUser.name;
        if(profileUsernameInput && currentUser) profileUsernameInput.value = currentUser.username;
        if(profileEmailInput && currentUser) profileEmailInput.value = currentUser.email;
        if(profilePhoneInput && currentUser) profilePhoneInput.value = currentUser.phone;
    }
    function showContactsView() {
        if (!currentUser) { showLoginView(); return; }
        const addContactForm = document.getElementById('addContactForm');
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        showView(contactsContainer);
        if (contactFormMessageArea) clearMessage(contactFormMessageArea);
        if (addContactForm) addContactForm.reset();
        if (addContactFormContainer) {
             if (addContactFormContainer.dataset.editingId) _resetContactFormToDefault();
            addContactFormContainer.style.display = 'none';
        }
        if (toggleAddContactFormBtn) toggleAddContactFormBtn.textContent = '‚úö Agregar Nuevo Contacto';
        renderContacts();
    }
     function showNewShipmentView() {
        if (!currentUser) { showLoginView(); return; }
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        const shipmentSenderNameInput = document.getElementById('shipmentSenderName');
        const shipmentSenderPhoneInput = document.getElementById('shipmentSenderPhone');
        showView(newShipmentContainer);
        _resetShipmentForm();
        currentShipmentStep = 1;
        updateShipmentStepView();
        if(shipmentSenderNameInput && currentUser) shipmentSenderNameInput.value = currentUser.name || '';
        if(shipmentSenderPhoneInput && currentUser) shipmentSenderPhoneInput.value = currentUser.phone || '';
        _loadContactsForShipment();
        if(shipmentMessageArea) clearMessage(shipmentMessageArea);
    }

    // --- User & Data Management ---
    function loadUsers() {
        console.log("loadUsers: Iniciando carga de usuarios.");
        const storedUsers = localStorage.getItem(USERS_STORAGE_KEY);
        if (storedUsers) {
            try {
                users = JSON.parse(storedUsers).map(user => ({
                    ...user, contacts: user.contacts || [],
                    shipments: user.shipments || [], points: user.points || 0
                }));
            } catch (e) {
                console.error("loadUsers: Error al parsear usuarios de localStorage", e);
                users = []; localStorage.removeItem(USERS_STORAGE_KEY);
            }
        } else {
            users = [{ name: "Usuario Demo", username: "demo", email: "demo@example.com",
                       phone: "0900000000", password: "demo", contacts: [], shipments: [], points: 0 }];
            saveUsers();
        }
        const loggedInUsername = sessionStorage.getItem('loggedInUser');
        if (loggedInUsername) {
            currentUser = users.find(u => u.username === loggedInUsername);
            if (currentUser) {
                currentUser.contacts = currentUser.contacts || [];
                currentUser.shipments = currentUser.shipments || [];
                currentUser.points = currentUser.points || 0;
                showDashboardView();
            } else {
                sessionStorage.removeItem('loggedInUser'); showLoginView();
            }
        } else {
            showLoginView();
        }
    }
    function saveUsers() {
        try { localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users)); }
        catch (e) { console.error("saveUsers: Error al guardar usuarios en localStorage", e); }
    }
    function updateUserInLocalStorage() {
        if (!currentUser) return;
        const userIndex = users.findIndex(u => u.username === currentUser.username);
        if (userIndex > -1) { users[userIndex] = { ...users[userIndex], ...currentUser }; saveUsers(); }
    }

    // --- Registration Logic ---
    function handleRegister() {
        const registerMessageArea = document.getElementById('registerMessageArea');
        const registerNameInput = document.getElementById('registerName');
        const registerUsernameInput = document.getElementById('registerUsername');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPhoneInput = document.getElementById('registerPhone');
        const registerPasswordInput = document.getElementById('registerPassword');
        const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
        const registerForm = document.getElementById('registerForm');
        if(registerMessageArea) clearMessage(registerMessageArea);
        const name = registerNameInput.value.trim(), username = registerUsernameInput.value.trim(),
              email = registerEmailInput.value.trim(), phone = registerPhoneInput.value.trim(),
              password = registerPasswordInput.value, confirmPassword = registerConfirmPasswordInput.value;
        if (!name || !username || !email || !phone || !password || !confirmPassword) { showMessage(registerMessageArea, "Todos obligatorios.", "error"); return; }
        if (/\s/.test(username)) { showMessage(registerMessageArea, "Usuario sin espacios.", "error"); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showMessage(registerMessageArea, "Email inv√°lido.", "error"); return; }
        if (!/^09[6-9]\d{7}$/.test(phone)) { showMessage(registerMessageArea, "Celular PY: 09XXXXXXXX.", "error"); return; }
        if (password.length < 8) { showMessage(registerMessageArea, "Clave: m√≠n. 8 caracteres.", "error"); return; }
        if (password !== confirmPassword) { showMessage(registerMessageArea, "Claves no coinciden.", "error"); return; }
        if (users.some(u => u.username === username)) { showMessage(registerMessageArea, "Usuario ya existe.", "error"); return; }
        if (users.some(u => u.email === email)) { showMessage(registerMessageArea, "Email ya registrado.", "error"); return; }
        users.push({ name, username, email, phone, password, contacts: [], shipments: [], points: 0 });
        saveUsers(); showMessage(registerMessageArea, "¬°Registrado! Inicia sesi√≥n.", "success");
        if (registerForm) registerForm.reset(); setTimeout(showLoginView, 1500);
    }

    // --- Login Logic ---
    function handleLogin() {
        const loginMessageArea = document.getElementById('loginMessageArea');
        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        if(loginMessageArea) clearMessage(loginMessageArea);
        const username = loginUsernameInput.value.trim(), password = loginPasswordInput.value;
        if (!username || !password) { showMessage(loginMessageArea, "Ingresa usuario y clave.", "error"); return; }
        const foundUser = users.find(u => u.username === username && u.password === password);
        if (foundUser) {
            currentUser = foundUser; currentUser.contacts = currentUser.contacts || [];
            currentUser.shipments = currentUser.shipments || []; currentUser.points = currentUser.points || 0;
            sessionStorage.setItem('loggedInUser', currentUser.username); showDashboardView();
        } else { showMessage(loginMessageArea, "Usuario o clave incorrectos.", "error"); }
    }

    // --- Dashboard ---
    function updateWelcomeMessage() {
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        if (!currentUser || !welcomeMessageElement) return;
        const hours = new Date().getHours();
        let greeting = hours < 12 ? "Buenos d√≠as" : hours < 18 ? "Buenas tardes" : "Buenas noches";
        welcomeMessageElement.innerHTML = `${greeting}, <strong>${currentUser.name}</strong>. ¬°Bienvenido/a!`;
    }

    // --- Logout ---
    function handleLogout() { currentUser = null; sessionStorage.removeItem('loggedInUser'); showLoginView(); }

    // --- Profile Update ---
    function handleUpdateProfile() {
        const profileMessageArea = document.getElementById('profileMessageArea');
        const profileNameInput = document.getElementById('profileName');
        const profileEmailInput = document.getElementById('profileEmail');
        const profilePhoneInput = document.getElementById('profilePhone');
        const profileNewPasswordInput = document.getElementById('profileNewPassword');
        const profileConfirmNewPasswordInput = document.getElementById('profileConfirmNewPassword');
        if(profileMessageArea) clearMessage(profileMessageArea);
        const name=profileNameInput.value.trim(), email=profileEmailInput.value.trim(), phone=profilePhoneInput.value.trim(),
              newPassword=profileNewPasswordInput.value, confirmNewPassword=profileConfirmNewPasswordInput.value;
        if (!name || !email || !phone) { showMessage(profileMessageArea, "Nombre, Email y Celular obligatorios.", "error"); return; }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showMessage(profileMessageArea, "Email inv√°lido.", "error"); return; }
        if (!/^09[6-9]\d{7}$/.test(phone)) { showMessage(profileMessageArea, "Celular PY: 09XXXXXXXX.", "error"); return; }
        if (email !== currentUser.email && users.some(u=>u.email===email && u.username!==currentUser.username)) {
            showMessage(profileMessageArea, "Ese correo ya est√° en uso.", "error"); return;
        }
        if (newPassword) {
            if (newPassword.length < 8) { showMessage(profileMessageArea, "Nueva clave: m√≠n. 8 chars.", "error"); return; }
            if (newPassword !== confirmNewPassword) { showMessage(profileMessageArea, "Nuevas claves no coinciden.", "error"); return; }
            currentUser.password = newPassword;
        }
        currentUser.name=name; currentUser.email=email; currentUser.phone=phone;
        updateUserInLocalStorage(); showMessage(profileMessageArea, "Perfil actualizado.", "success");
        if(profileNewPasswordInput) profileNewPasswordInput.value='';
        if(profileConfirmNewPasswordInput) profileConfirmNewPasswordInput.value='';
        updateWelcomeMessage();
    }

    // --- Contacts Logic ---
    function _resetContactFormToDefault() {
        const addContactForm = document.getElementById('addContactForm');
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        if (!addContactForm || !addContactFormContainer) return;
        addContactForm.reset();
        const saveButton = addContactFormContainer.querySelector('form#addContactForm button');
        if (saveButton) { saveButton.textContent = 'Guardar Contacto'; saveButton.onclick = handleAddContact; }
        delete addContactFormContainer.dataset.editingId;
        if(contactFormMessageArea) clearMessage(contactFormMessageArea);
    }
    function toggleAddContactForm() {
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        const contactNameInput = document.getElementById('contactName');
        if (!addContactFormContainer || !toggleAddContactFormBtn) return;
        const isVisible = addContactFormContainer.style.display === 'block';
        const editingId = addContactFormContainer.dataset.editingId;
        if (isVisible) {
            addContactFormContainer.style.display = 'none';
            toggleAddContactFormBtn.textContent = '‚úö Agregar Nuevo Contacto';
            if (editingId) _resetContactFormToDefault();
        } else {
            _resetContactFormToDefault(); addContactFormContainer.style.display = 'block';
            toggleAddContactFormBtn.textContent = '‚ûñ Cancelar Nuevo Contacto';
            if(contactNameInput) contactNameInput.focus();
        }
    }
    function handleAddContact() {
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        const contactNameInput = document.getElementById('contactName');
        const contactAddressInput = document.getElementById('contactAddress');
        const contactPhoneInput = document.getElementById('contactPhone');
        if(contactFormMessageArea) clearMessage(contactFormMessageArea);
        const name = contactNameInput.value.trim(), address = contactAddressInput.value.trim(), phone = contactPhoneInput.value.trim();
        if (!name || !address || !phone) { showMessage(contactFormMessageArea, "Todos los campos del contacto obligatorios.", "error"); return; }
        if (!/^\d{6,}$/.test(phone.replace(/\s/g, ''))) { showMessage(contactFormMessageArea, "Celular inv√°lido (m√≠n. 6 d√≠gitos).", "error"); return; }
        currentUser.contacts.push({ id: Date.now().toString(), name, address, phone });
        updateUserInLocalStorage(); showMessage(contactFormMessageArea, "Contacto guardado.", "success");
        _resetContactFormToDefault(); renderContacts();
        setTimeout(() => { if(contactFormMessageArea) clearMessage(contactFormMessageArea); }, 2000);
    }
    function renderContacts() {
        const contactListArea = document.getElementById('contactListArea');
        if(!contactListArea) return; contactListArea.innerHTML = '';
        if (!currentUser || !currentUser.contacts || currentUser.contacts.length === 0) {
            contactListArea.innerHTML = '<p class="no-contacts">A√∫n no tienes contactos.</p>'; return;
        }
        currentUser.contacts.forEach(contact => {
            const card = document.createElement('div');
            card.className = 'contact-card'; card.dataset.contactId = contact.id;
            card.innerHTML = `<div class="contact-card-info"><p><strong>Nombre:</strong> ${contact.name}</p><p><strong>Direcci√≥n:</strong> ${contact.address}</p><p><strong>Celular:</strong> ${contact.phone}</p></div><div class="contact-card-actions"><button class="edit-btn" onclick="handleEditContact('${contact.id}')">Editar</button><button class="delete-btn" onclick="handleDeleteContact('${contact.id}')">Eliminar</button></div>`;
            contactListArea.appendChild(card);
        });
    }
    function handleEditContact(contactId) {
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        const contactNameInput = document.getElementById('contactName');
        const contactAddressInput = document.getElementById('contactAddress');
        const contactPhoneInput = document.getElementById('contactPhone');
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        const contact = currentUser.contacts.find(c => c.id === contactId);
        if (contact && addContactFormContainer) {
            _resetContactFormToDefault(); addContactFormContainer.style.display = 'block';
            if (toggleAddContactFormBtn) toggleAddContactFormBtn.textContent = 'üìù Editando (Cancelar/Nuevo)';
            if (contactNameInput) contactNameInput.value = contact.name;
            if (contactAddressInput) contactAddressInput.value = contact.address;
            if (contactPhoneInput) contactPhoneInput.value = contact.phone;
            const saveButton = addContactFormContainer.querySelector('form#addContactForm button');
            if (saveButton) { saveButton.textContent = 'Actualizar Contacto'; saveButton.onclick = () => handleUpdateExistingContact(contactId); }
            addContactFormContainer.dataset.editingId = contactId;
            if(contactFormMessageArea) clearMessage(contactFormMessageArea);
            if(contactNameInput) contactNameInput.focus();
        }
    }
    function handleUpdateExistingContact(contactIdToUpdate) {
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        const contactNameInput = document.getElementById('contactName');
        const contactAddressInput = document.getElementById('contactAddress');
        const contactPhoneInput = document.getElementById('contactPhone');
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        if(contactFormMessageArea) clearMessage(contactFormMessageArea);
        const name=contactNameInput.value.trim(), address=contactAddressInput.value.trim(), phone=contactPhoneInput.value.trim();
        if (!name || !address || !phone) { showMessage(contactFormMessageArea, "Campos obligatorios.", "error"); return; }
        if (!/^\d{6,}$/.test(phone.replace(/\s/g,''))) { showMessage(contactFormMessageArea, "Celular inv√°lido.", "error"); return; }
        const contactIndex = currentUser.contacts.findIndex(c => c.id === contactIdToUpdate);
        if (contactIndex > -1) {
            currentUser.contacts[contactIndex].name = name;
            currentUser.contacts[contactIndex].address = address;
            currentUser.contacts[contactIndex].phone = phone;
            updateUserInLocalStorage(); showMessage(contactFormMessageArea, "Contacto actualizado.", "success");
            _resetContactFormToDefault();
            if (addContactFormContainer) addContactFormContainer.style.display = 'none';
            if (toggleAddContactFormBtn) toggleAddContactFormBtn.textContent = '‚úö Agregar Nuevo Contacto';
            renderContacts();
            setTimeout(() => { if(contactFormMessageArea) clearMessage(contactFormMessageArea); }, 2000);
        } else { showMessage(contactFormMessageArea, "Error al actualizar.", "error"); }
    }
    function handleDeleteContact(contactId) {
        const contactFormMessageArea = document.getElementById('contactFormMessageArea');
        const addContactFormContainer = document.getElementById('addContactFormContainer');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        if (confirm("¬øEliminar este contacto?")) {
            currentUser.contacts = currentUser.contacts.filter(contact => contact.id !== contactId);
            updateUserInLocalStorage(); renderContacts();
            if (contactFormMessageArea) showMessage(contactFormMessageArea, "Contacto eliminado.", "success");
            setTimeout(() => { if (contactFormMessageArea) clearMessage(contactFormMessageArea); }, 2000);
            if (addContactFormContainer && addContactFormContainer.dataset.editingId === contactId) {
                _resetContactFormToDefault(); addContactFormContainer.style.display = 'none';
                if (toggleAddContactFormBtn) toggleAddContactFormBtn.textContent = '‚úö Agregar Nuevo Contacto';
            }
        }
    }

    // --- New Shipment Form Logic ---
    function _resetShipmentForm() {
        const newShipmentForm = document.getElementById('newShipmentForm');
        const shipmentSenderNameInput = document.getElementById('shipmentSenderName');
        const shipmentSenderPhoneInput = document.getElementById('shipmentSenderPhone');
        const shipmentServiceCostInput = document.getElementById('shipmentServiceCost');
        const shipmentSummaryDiv = document.getElementById('shipmentSummary');
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        if(newShipmentForm) newShipmentForm.reset();
        if(shipmentSenderNameInput && currentUser) shipmentSenderNameInput.value = currentUser.name || '';
        if(shipmentSenderPhoneInput && currentUser) shipmentSenderPhoneInput.value = currentUser.phone || '';
        if(shipmentServiceCostInput) shipmentServiceCostInput.value = '';
        if(shipmentSummaryDiv) shipmentSummaryDiv.innerHTML = 'Resumen aparecer√° aqu√≠...';
        currentShipmentStep = 1; updateShipmentStepView();
        if(shipmentMessageArea) clearMessage(shipmentMessageArea);
    }
    function updateShipmentStepView() {
        document.querySelectorAll('.shipment-step').forEach(step => step.classList.remove('active'));
        const activeStep = document.getElementById(`shipmentStep${currentShipmentStep}`);
        if (activeStep) activeStep.classList.add('active');
    }
    function nextShipmentStep(nextStep) {
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        const shipmentSenderAddressInput = document.getElementById('shipmentSenderAddress');
        const shipmentDescriptionTextarea = document.getElementById('shipmentDescription');
        const shipmentRecipientNameInput = document.getElementById('shipmentRecipientName');
        const shipmentRecipientAddressInput = document.getElementById('shipmentRecipientAddress');
        const shipmentRecipientPhoneInput = document.getElementById('shipmentRecipientPhone');
        if (currentShipmentStep === 1) {
            if (!shipmentSenderAddressInput.value.trim() || !shipmentDescriptionTextarea.value.trim()) {
                showMessage(shipmentMessageArea, "Completa direcci√≥n de recogida y descripci√≥n.", "error"); return;
            }
        }
        if (currentShipmentStep === 2) {
            if (!shipmentRecipientNameInput.value.trim() || !shipmentRecipientAddressInput.value.trim() || !shipmentRecipientPhoneInput.value.trim()) {
                showMessage(shipmentMessageArea, "Completa datos del destinatario.", "error"); return;
            }
            calculateServiceCost(); updateShipmentSummary();
        }
        if(shipmentMessageArea) clearMessage(shipmentMessageArea);
        currentShipmentStep = nextStep; updateShipmentStepView(); window.scrollTo(0,0);
    }
    function prevShipmentStep(prevStep) {
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        if(shipmentMessageArea) clearMessage(shipmentMessageArea);
        currentShipmentStep = prevStep; updateShipmentStepView(); window.scrollTo(0,0);
    }
    function _loadContactsForShipment() {
        const shipmentRecipientContactSelect = document.getElementById('shipmentRecipientContactSelect');
        if(!shipmentRecipientContactSelect) return;
        shipmentRecipientContactSelect.innerHTML = '<option value="">-- Seleccionar contacto --</option>';
        if (currentUser && currentUser.contacts && currentUser.contacts.length > 0) {
            currentUser.contacts.forEach(contact => {
                const option = document.createElement('option');
                option.value = contact.id; option.textContent = contact.name;
                shipmentRecipientContactSelect.appendChild(option);
            });
        }
    }
    function calculateServiceCost() {
        const shipmentDistanceInput = document.getElementById('shipmentDistance');
        const shipmentServiceCostInput = document.getElementById('shipmentServiceCost');
        if(!shipmentDistanceInput || !shipmentServiceCostInput) return;
        const distanceStr = shipmentDistanceInput.value;
        if (distanceStr === "" || isNaN(parseFloat(distanceStr))) { shipmentServiceCostInput.value = ""; return; }
        const distance = parseFloat(distanceStr);
        let cost = distance <= 0 ? 0 : distance <= 10 ? 25000 : distance <= 20 ? 40000 : 60000;
        shipmentServiceCostInput.value = cost > 0 ? cost.toLocaleString('es-PY') : "";
        updateShipmentSummary();
    }
    function updateShipmentSummary() {
        const shipmentSummaryDiv = document.getElementById('shipmentSummary');
        if (currentShipmentStep !== 3 || !shipmentSummaryDiv) return;
        const s = { // Short references for convenience
            senderName: document.getElementById('shipmentSenderName').value,
            senderAddr: document.getElementById('shipmentSenderAddress').value,
            recName: document.getElementById('shipmentRecipientName').value,
            recAddr: document.getElementById('shipmentRecipientAddress').value,
            itemType: document.getElementById('shipmentItemType').options[document.getElementById('shipmentItemType').selectedIndex].text,
            itemDesc: document.getElementById('shipmentDescription').value,
            isFragile: document.getElementById('shipmentIsFragile').checked,
            roundTrip: document.getElementById('shipmentRoundTrip').checked,
            distance: document.getElementById('shipmentDistance').value,
            cost: document.getElementById('shipmentServiceCost').value,
            payment: document.querySelector('input[name="paymentMethod"]:checked') ? document.querySelector('input[name="paymentMethod"]:checked').parentElement.textContent.trim() : 'N/A'
        };
        shipmentSummaryDiv.innerHTML = `<h4>Resumen del Env√≠o:</h4>
            <p><strong>Remite:</strong> ${s.senderName} (${s.senderAddr})</p>
            <p><strong>Recibe:</strong> ${s.recName} (${s.recAddr})</p>
            <p><strong>Tipo:</strong> ${s.itemType}, ${s.itemDesc.substring(0,30)}...</p>
            ${s.isFragile ? "<p><strong style='color:red;'>¬°FR√ÅGIL!</strong></p>" : ""}
            ${s.roundTrip ? "<p><strong>Servicio:</strong> Ida y Vuelta</p>" : ""}
            <p><strong>Dist Aprox:</strong> ${s.distance || 'N/A'} km</p>
            <p><strong>Costo:</strong> Gs. ${s.cost || 'N/A'}</p>
            <p><strong>Pago:</strong> ${s.payment}</p>`;
    }
    function handleSaveShipment() {
        const shipmentMessageArea = document.getElementById('shipmentMessageArea');
        const shipmentDistanceInput = document.getElementById('shipmentDistance');
        const shipmentServiceCostInput = document.getElementById('shipmentServiceCost');
        if (currentShipmentStep !== 3) { showMessage(shipmentMessageArea, "Completa todos los pasos.", "error"); return; }
        const distance = parseFloat(shipmentDistanceInput.value);
        const costVal = shipmentServiceCostInput.value;
        if (isNaN(distance) || distance <= 0 || !costVal) {
            showMessage(shipmentMessageArea, "Distancia y costo inv√°lidos.", "error"); shipmentDistanceInput.focus(); return;
        }
        const newShipmentData = {
            id: Date.now().toString(), status: "Pendiente", createdAt: new Date().toISOString(),
            sender: { name: document.getElementById('shipmentSenderName').value, address: document.getElementById('shipmentSenderAddress').value,
                      phone: document.getElementById('shipmentSenderPhone').value, pickupLat: document.getElementById('pickupLat').value || null,
                      pickupLng: document.getElementById('pickupLng').value || null },
            recipient: { name: document.getElementById('shipmentRecipientName').value, address: document.getElementById('shipmentRecipientAddress').value,
                         phone: document.getElementById('shipmentRecipientPhone').value, destLat: document.getElementById('destLat').value || null,
                         destLng: document.getElementById('destLng').value || null },
            item: { type: document.getElementById('shipmentItemType').value, description: document.getElementById('shipmentDescription').value,
                    isFragile: document.getElementById('shipmentIsFragile').checked },
            service: { roundTrip: document.getElementById('shipmentRoundTrip').checked, distanceKm: distance,
                       costGs: parseFloat(costVal.replace(/\./g, '').replace(/,/g, '.')) || 0 },
            payment: { method: document.querySelector('input[name="paymentMethod"]:checked').value }
        };
        currentUser.shipments.push(newShipmentData);
        currentUser.points = (currentUser.points || 0) + 10;
        updateUserInLocalStorage();
        showMessage(shipmentMessageArea, `Env√≠o guardado! ID: ${newShipmentData.id}. Puntos: ${currentUser.points}`, "success");
        _resetShipmentForm();
        setTimeout(() => { if (newShipmentContainer && newShipmentContainer.style.display === 'block') { showDashboardView(); }}, 3000);
    }

    // --- DOMContentLoaded: Inicializaci√≥n y Event Listeners ---
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded: P√°gina cargada, inicializando aplicaci√≥n.");
        loginContainer = document.getElementById('loginContainer');
        registerContainer = document.getElementById('registerContainer');
        dashboardContainer = document.getElementById('dashboardContainer');
        profileContainer = document.getElementById('profileContainer');
        contactsContainer = document.getElementById('contactsContainer');
        newShipmentContainer = document.getElementById('newShipmentContainer');

        if (!loginContainer || !registerContainer || !dashboardContainer || !profileContainer || !contactsContainer || !newShipmentContainer) {
            console.error("ERROR CR√çTICO: Faltan contenedores principales. Revisa IDs HTML.");
            document.body.innerHTML = "<h1 style='color:red; text-align:center;'>Error cr√≠tico. Faltan contenedores.</h1>"; return;
        }
        loadUsers();

        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const profileLink = document.getElementById('profileLink');
        const contactsLink = document.getElementById('contactsLink');
        const newShipmentCardFromDashboard = document.getElementById('newShipmentCard');
        const backToDashboardFromProfile = document.getElementById('backToDashboardFromProfile');
        const backToDashboardFromContacts = document.getElementById('backToDashboardFromContacts');
        const toggleAddContactFormBtn = document.getElementById('toggleAddContactFormBtn');
        const loginPasswordInput = document.getElementById('loginPassword');
        const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
        const profileConfirmNewPasswordInput = document.getElementById('profileConfirmNewPassword');
        const contactPhoneInput = document.getElementById('contactPhone');
        const shipmentDistanceInput = document.getElementById('shipmentDistance');
        const shipmentRecipientContactSelect = document.getElementById('shipmentRecipientContactSelect');

        if(showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterView(); });
        if(showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginView(); });
        if(profileLink) profileLink.addEventListener('click', (e) => { e.preventDefault(); showProfileView(); });
        if(contactsLink) contactsLink.addEventListener('click', (e) => { e.preventDefault(); showContactsView(); });
        if(newShipmentCardFromDashboard) newShipmentCardFromDashboard.addEventListener('click', (e) => { e.preventDefault(); showNewShipmentView(); });
        if(backToDashboardFromProfile) backToDashboardFromProfile.addEventListener('click', (e) => { e.preventDefault(); showDashboardView(); });
        if(backToDashboardFromContacts) backToDashboardFromContacts.addEventListener('click', (e) => { e.preventDefault(); showDashboardView(); });
        if(toggleAddContactFormBtn) toggleAddContactFormBtn.addEventListener('click', toggleAddContactForm);
        if(loginPasswordInput) loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }});
        if(registerConfirmPasswordInput) registerConfirmPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleRegister(); }});
        if(profileConfirmNewPasswordInput) profileConfirmNewPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleUpdateProfile(); }});
        if(contactPhoneInput) contactPhoneInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') { e.preventDefault();
                const addContactFormContainer = document.getElementById('addContactFormContainer'); // Necesario aqu√≠
                const editingId = addContactFormContainer ? addContactFormContainer.dataset.editingId : null;
                if (editingId) { handleUpdateExistingContact(editingId); } else { handleAddContact(); }
            }
        });
        if(shipmentDistanceInput) shipmentDistanceInput.addEventListener('input', calculateServiceCost);
        if (shipmentRecipientContactSelect) {
            shipmentRecipientContactSelect.addEventListener('change', function() {
                const selectedContactId = this.value;
                const shipmentRecipientNameInput = document.getElementById('shipmentRecipientName');
                const shipmentRecipientAddressInput = document.getElementById('shipmentRecipientAddress');
                const shipmentRecipientPhoneInput = document.getElementById('shipmentRecipientPhone');
                if (selectedContactId && currentUser && currentUser.contacts) {
                    const contact = currentUser.contacts.find(c => c.id === selectedContactId);
                    if (contact) {
                        if(shipmentRecipientNameInput) shipmentRecipientNameInput.value = contact.name || '';
                        if(shipmentRecipientAddressInput) shipmentRecipientAddressInput.value = contact.address || '';
                        if(shipmentRecipientPhoneInput) shipmentRecipientPhoneInput.value = contact.phone || '';
                    }
                } else {
                    if(shipmentRecipientNameInput) shipmentRecipientNameInput.value = '';
                    if(shipmentRecipientAddressInput) shipmentRecipientAddressInput.value = '';
                    if(shipmentRecipientPhoneInput) shipmentRecipientPhoneInput.value = '';
                }
            });
        }
        console.log("DOMContentLoaded: Inicializaci√≥n y listeners completados.");
    });
    </script>
</body>
</html>
