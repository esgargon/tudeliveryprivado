<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Web - Paso 1 Reintegración</title>
    <!-- SIN Leaflet CSS por ahora -->
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container, .dashboard-container, .contacts-container, .new-shipment-container { background-color: #fff; padding: 30px 40px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 550px; text-align: center; margin: 20px auto; }
        h2 { margin-top: 0; margin-bottom: 25px; color: #333; font-weight: 600; }
        .new-shipment-container h3 { margin: 20px 0 15px; color: #007bff; font-size: 1.3em; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; text-align: left; margin-bottom: 6px; color: #555; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="email"], input[type="tel"], input[type="number"], select, textarea { width: calc(100% - 24px); padding: 12px; margin-bottom: 18px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 15px; }
        textarea { resize: vertical; min-height: 80px;}
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        button, .button { width: auto; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.3s ease; margin-top: 10px; text-decoration: none; display: inline-block; }
        button:hover, .button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .form-full-width-btn { width: 100%; padding: 12px; }
        .button-secondary { background-color: #6c757d; } .button-secondary:hover { background-color: #5a6268; }
        .button-success { background-color: #28a745; } .button-success:hover { background-color: #218838; }
        .message { margin-top:18px; font-size:14px; padding:10px; border-radius:5px; display:none; }
        .message.success { color:#155724; background-color:#d4edda; border:1px solid #c3e6cb; display:block; }
        .message.error { color:#721c24; background-color:#f8d7da; border:1px solid #f5c6cb; display:block; }
        .form-switch-link { display:block; margin-top:20px; font-size:14px; color:#007bff; text-decoration:none; cursor:pointer; } .form-switch-link:hover { text-decoration:underline; }
        #loginContainer, #registerContainer, #dashboardContainer, #profileContainer, #contactsContainer, #newShipmentContainer { display: none; } /* CLAVE: Todas ocultas por defecto */
        .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; } .dashboard-header h2 { margin-bottom:0; margin-right:auto; } .dashboard-nav-links { display:flex; gap:15px; }
        .profile-link, .contacts-link { display:inline-flex; align-items:center; padding:8px 15px; background-color:#f8f9fa; border:1px solid #dee2e6; border-radius:20px; text-decoration:none; color:#333; font-size:14px; transition:all 0.2s ease-in-out; } .profile-link .icon, .contacts-link .icon { margin-right:5px; } .profile-link:hover, .contacts-link:hover { background-color:#e9ecef; border-color:#adb5bd; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
        #welcomeMessage { font-size:18px; color:#333; margin-bottom:30px; line-height:1.6; }
        .dashboard-options { display:flex; justify-content:space-around; gap:20px; margin:20px 0 30px; } .dashboard-card { background-color:#f8f9fa; border:1px solid #e3e6f0; border-radius:8px; padding:20px; text-align:center; width:45%; box-shadow:0 2px 5px rgba(0,0,0,0.05); cursor:pointer; transition:transform 0.2s ease,box-shadow 0.2s ease; } .dashboard-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.1); } .dashboard-card h3 { margin:0 0 10px; font-size:1.1em; color:#007bff; } .dashboard-card p { font-size:0.9em; color:#6c757d; margin-bottom:0; }
        #addContactFormContainer { background-color:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:25px; border:1px dashed #ccc; } #contactListArea { margin-top:20px; text-align:left; } .contact-card { background-color:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05); display:flex; flex-direction:column; } .contact-card-info strong { color:#007bff; } .contact-card-info p { margin:5px 0; font-size:0.95em; color:#555; } .contact-card-actions { margin-top:10px; border-top:1px solid #f0f0f0; padding-top:10px; display:flex; justify-content:flex-end; gap:10px; } .contact-card-actions button { padding:6px 12px; font-size:0.85em; width:auto; margin-top:0;} .contact-card-actions .edit-btn { background-color:#ffc107; color:#333; } .contact-card-actions .edit-btn:hover { background-color:#e0a800; } .contact-card-actions .delete-btn { background-color:#dc3545; } .contact-card-actions .delete-btn:hover { background-color:#c82333; } .no-contacts { text-align:center; color:#777; padding:20px; border:1px dashed #ddd; border-radius:5px; background-color:#f9f9f9; }
        .shipment-step { display:none; } .shipment-step.active { display:block; } .form-group { margin-bottom:15px; text-align:left; } .form-group-checkbox { display:flex; align-items:center; text-align:left; margin-bottom:15px; } .form-group-checkbox input[type="checkbox"] { width:auto; margin-right:10px; margin-bottom:0; } .form-group-radio { display:flex; align-items:center; margin-right:20px; } .form-group-radio input[type="radio"] { width:auto; margin-right:8px; margin-bottom:0; } .radio-group-container { display:flex; flex-wrap:wrap; margin-bottom:15px; } .shipment-buttons { margin-top:30px; display:flex; justify-content:space-between; }
        /* Map placeholder, ya no usaremos el real todavía */
        .map-placeholder { width:100%; height:150px; background-color:#e9ecef; border:1px dashed #ccc; display:flex; justify-content:center; align-items:center; color:#6c757d; font-style:italic; margin-bottom:15px; text-align:center;}
    </style>
</head>
<body>
    <!-- HTML Estructura Principal COMPLETA -->
    <div id="loginContainer" class="container"><h2>Iniciar Sesión</h2><form id="loginForm"><div><label for="loginUsername">Usuario:</label><input type="text" id="loginUsername" value="demo" required></div><div><label for="loginPassword">Contraseña:</label><input type="password" id="loginPassword" value="demo" required></div><button type="button" id="loginButton" class="form-full-width-btn">Entrar</button></form><div id="loginMessageArea" class="message"></div><a href="#" id="showRegisterLink" class="form-switch-link">¿No tienes cuenta? Regístrate aquí</a></div>
    <div id="registerContainer" class="container"><h2>Crear Nueva Cuenta</h2><form id="registerForm"><div><label for="registerName">Nombre y Apellido:</label><input type="text" id="registerName" required></div><div><label for="registerUsername">Usuario:</label><input type="text" id="registerUsername" required></div><div><label for="registerEmail">Correo:</label><input type="email" id="registerEmail" required></div><div><label for="registerPhone">Celular:</label><input type="tel" id="registerPhone" placeholder="09xxxxxxxx" required></div><div><label for="registerPassword">Clave (mín. 8):</label><input type="password" id="registerPassword" required></div><div><label for="registerConfirmPassword">Confirmar Clave:</label><input type="password" id="registerConfirmPassword" required></div><button type="button" id="registerButton" class="form-full-width-btn">Registrar</button></form><div id="registerMessageArea" class="message"></div><a href="#" id="showLoginLink" class="form-switch-link">¿Ya tienes cuenta? Inicia Sesión</a></div>
    <div id="dashboardContainer" class="dashboard-container"><div class="dashboard-header"><h2>Panel</h2><div class="dashboard-nav-links"><a href="#" id="profileLink" class="profile-link">👤Mi Perfil</a><a href="#" id="contactsLink" class="contacts-link">📒Contactos</a></div></div><div id="welcomeMessage"></div><div class="dashboard-options"><div class="dashboard-card" id="newShipmentCardDashboard"><h3>🚚 NUEVO ENVÍO</h3><p>Gestionar envíos.</p></div><div class="dashboard-card" id="newManagementCardDashboard"><h3>⚙️ NUEVA GESTIÓN</h3><p>Administrar gestiones.</p></div></div><button type="button" id="logoutButton" class="button-secondary form-full-width-btn">Cerrar Sesión</button></div>
    <div id="profileContainer" class="container"><h2>Mi Perfil</h2><form id="profileForm"><div><label for="profileName">Nombre y Apellido:</label><input type="text" id="profileName" required></div><div><label for="profileUsername">Usuario:</label><input type="text" id="profileUsername" readonly disabled></div><div><label for="profileEmail">Correo:</label><input type="email" id="profileEmail" required></div><div><label for="profilePhone">Celular:</label><input type="tel" id="profilePhone" required></div><div><label for="profileNewPassword">Nueva Clave (vacío=no cambiar):</label><input type="password" id="profileNewPassword"></div><div><label for="profileConfirmNewPassword">Confirmar Nueva Clave:</label><input type="password" id="profileConfirmNewPassword"></div><button type="button" id="updateProfileButton" class="form-full-width-btn button-success">Guardar Cambios</button></form><div id="profileMessageArea" class="message"></div><a href="#" id="backToDashboardFromProfile" class="form-switch-link">Volver al Panel</a></div>
    <div id="contactsContainer" class="contacts-container"><h2>Contactos</h2><button type="button" id="toggleAddContactFormBtn" class="form-full-width-btn button-success" style="margin-bottom:20px;">✚ Agregar Contacto</button><div id="addContactFormContainer" style="display:none;"><h3>Nuevo Contacto</h3><form id="addContactForm"><div><label for="contactName">Nombre:</label><input type="text" id="contactName" required></div><div><label for="contactAddress">Dirección:</label><input type="text" id="contactAddress" required></div><div><label for="contactPhone">Celular:</label><input type="tel" id="contactPhone" required></div><button type="button" id="addContactButton" class="form-full-width-btn">Guardar</button></form><div id="contactFormMessageArea" class="message"></div></div><div id="contactListArea"></div><a href="#" id="backToDashboardFromContacts" class="form-switch-link" style="margin-top:30px;">Volver al Panel</a></div>
    <div id="newShipmentContainer" class="new-shipment-container"><h2>🚚 Nuevo Envío</h2><div id="shipmentMessageArea" class="message"></div><form id="newShipmentForm">
        <div id="shipmentStep1" class="shipment-step active"><h3>Paso 1: Remitente y Paquete</h3><div class="form-group"><label for="shipmentSenderName">Quién envía:</label><input type="text" id="shipmentSenderName" readonly></div><div class="form-group"><label for="shipmentSenderAddress">Dirección Recogida:</label><input type="text" id="shipmentSenderAddress" required></div><div class="form-group"><label for="shipmentSenderPhone">Celular Remitente:</label><input type="tel" id="shipmentSenderPhone" readonly></div>
        <div class="form-group"><label>Punto Recogida:</label><div class="map-placeholder">(Mapa de Recogida - Placeholder)</div><input type="hidden" id="pickupLat"><input type="hidden" id="pickupLng"></div>
        <div class="form-group"><label for="shipmentItemType">Qué enviamos?:</label><select id="shipmentItemType"><option value="paquete">Paquete</option><option value="caja">Caja</option><option value="sobre">Sobre</option><option value="bolsa">Bolsa</option><option value="otros">Otros</option></select></div><div class="form-group"><label for="shipmentDescription">Descripción:</label><textarea id="shipmentDescription" required></textarea></div><div class="form-group-checkbox"><input type="checkbox" id="shipmentIsFragile"><label for="shipmentIsFragile">Frágil</label></div><div class="shipment-buttons"><button type="button" id="cancelShipmentStep1" class="button-secondary">Cancelar</button><button type="button" id="nextShipmentStep1Button">Siguiente ❯</button></div></div>
        <div id="shipmentStep2" class="shipment-step"><h3>Paso 2: Destinatario y Destino</h3><div class="form-group"><label for="shipmentRecipientContactSelect">Destinatario (Contactos):</label><select id="shipmentRecipientContactSelect"><option value="">-- Seleccionar --</option></select></div><div class="form-group"><label for="shipmentRecipientName">Nombre Destinatario:</label><input type="text" id="shipmentRecipientName" required></div><div class="form-group"><label for="shipmentRecipientAddress">Dirección Entrega:</label><input type="text" id="shipmentRecipientAddress" required></div><div class="form-group"><label for="shipmentRecipientPhone">Celular Destinatario:</label><input type="tel" id="shipmentRecipientPhone" required></div>
        <div class="form-group"><label>Punto Destino:</label><div class="map-placeholder">(Mapa de Destino - Placeholder)</div><input type="hidden" id="destLat"><input type="hidden" id="destLng"></div>
        <div class="form-group-checkbox"><input type="checkbox" id="shipmentRoundTrip"><label for="shipmentRoundTrip">Ida y Vuelta?</label></div><div class="shipment-buttons"><button type="button" id="prevShipmentStep2Button" class="button-secondary">❮ Atrás</button><button type="button" id="nextShipmentStep2Button">Siguiente ❯</button></div></div>
        <div id="shipmentStep3" class="shipment-step"><h3>Paso 3: Pago y Confirmación</h3><div class="form-group"><label>Forma de Pago:</label><div class="radio-group-container"><div class="form-group-radio"><input type="radio" id="paymentQR" name="paymentMethod" value="QR" checked><label for="paymentQR">QR</label></div><div class="form-group-radio"><input type="radio" id="paymentTransfer" name="paymentMethod" value="Transferencia"><label for="paymentTransfer">Transfer</label></div><div class="form-group-radio"><input type="radio" id="paymentCash" name="paymentMethod" value="Efectivo"><label for="paymentCash">Efectivo</label></div><div class="form-group-radio"><input type="radio" id="paymentAtDestination" name="paymentMethod" value="PagoEnDestino"><label for="paymentAtDestination">Pago Destino</label></div></div></div>
        <div class="form-group"><label for="shipmentDistance">Distancia (km) - <span style="font-weight:bold;color:red;">INGRESO MANUAL</span>:</label><input type="number" id="shipmentDistance" min="0" step="0.1" required></div>
        <div class="form-group"><label for="shipmentServiceCost">Monto (Gs.):</label><input type="text" id="shipmentServiceCost" readonly></div><div class="form-group"><label>Resumen:</label><div id="shipmentSummary" style="padding:10px;border:1px solid #eee;background-color:#f9f9f9;text-align:left;font-size:0.9em;min-height:50px;">Resumen...</div></div><div class="shipment-buttons"><button type="button" id="prevShipmentStep3Button" class="button-secondary">❮ Atrás</button><button type="button" id="saveShipmentButton" class="button-success">Guardar Envío ✔</button></div></div>
    </form><a href="#" id="backToDashboardFromShipment" class="form-switch-link" style="margin-top:30px;">Volver (sin guardar)</a></div>

    <!-- SIN Leaflet JS por ahora -->

    <script>
    // --- Variables Globales ---
    const USERS_STORAGE_KEY = 'test_users_phase1'; // Nueva key para no interferir con datos viejos
    let users = [];
    let currentUser = null;
    let currentShipmentStep = 1;

    // --- Contenedores de Vistas (declarados, se asignarán en DOMContentLoaded) ---
    let loginContainer, registerContainer, dashboardContainer, profileContainer, contactsContainer, newShipmentContainer;

    // --- Funciones de Utilidad ---
    function showMessage(area, text, type) { if(area){area.textContent=text; area.className=`message ${type}`; area.style.display='block';} }
    function clearMessage(area) { if(area){area.textContent=''; area.className='message'; area.style.display='none';} }

    // --- Manejo de Vistas (SIMPLIFICADO PARA ESTA PRUEBA) ---
    function showView(viewToShow) {
        console.log("showView: Intentando mostrar", viewToShow ? viewToShow.id : "NADA");
        const allViews = [loginContainer, registerContainer, dashboardContainer, profileContainer, contactsContainer, newShipmentContainer];
        allViews.forEach(c => { if (c) c.style.display = 'none'; });

        if (viewToShow && allViews.includes(viewToShow)) {
            viewToShow.style.display = 'block';
            console.log("showView: Mostrado:", viewToShow.id);
        } else if (viewToShow) {
            console.error("showView: viewToShow NO es válido:", viewToShow);
        }
    }

    // SIMPLIFICADO: Siempre muestra el login al inicio, no usa sessionStorage ni `loadUsers` complejo aún.
    function initializeAppView() {
        console.log("initializeAppView: Mostrando LOGIN directamente.");
        if (loginContainer) { // loginContainer debe estar definido
            showView(loginContainer);
            const loginForm = document.getElementById('loginForm');
            if(loginForm) loginForm.reset();
            const loginMessageArea = document.getElementById('loginMessageArea');
            if(loginMessageArea) clearMessage(loginMessageArea);
        } else {
            console.error("initializeAppView: ¡loginContainer es NULO! No se puede mostrar el login.");
            document.body.innerHTML = "Error fatal: No se pudo encontrar el contenedor del login.";
        }
    }


    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded: Iniciado.");

        loginContainer = document.getElementById('loginContainer');
        registerContainer = document.getElementById('registerContainer');
        dashboardContainer = document.getElementById('dashboardContainer');
        profileContainer = document.getElementById('profileContainer');
        contactsContainer = document.getElementById('contactsContainer');
        newShipmentContainer = document.getElementById('newShipmentContainer');

        if (!loginContainer || !registerContainer || !dashboardContainer || !profileContainer || !contactsContainer || !newShipmentContainer) {
            console.error("FATAL: Uno o más DIVS de vista principal no encontrado. Verifica IDs en HTML.");
            document.body.innerHTML = `<p style="color:red;font-weight:bold;padding:20px;">Error crítico de carga: Faltan elementos base del HTML.</p>`;
            return; // Detener todo
        }
        console.log("DOMContentLoaded: Todos los contenedores de vista principales fueron encontrados.");

        // SIMPLIFICADO: Siempre intentamos mostrar el login.
        initializeAppView();

        // Funciones (se definen aquí para estar disponibles, pero el flujo es simple)
        // Por ahora, solo necesitamos que handleLogin y showRegisterView funcionen mínimamente para probar la navegación.

        window.handleLogin = function() {
            // Lógica de login completa será reintroducida después.
            // Por ahora, solo simula un login exitoso y muestra el dashboard.
            console.log("handleLogin (simulado) llamado.");
            const msgArea = document.getElementById('loginMessageArea');
            // Simular un usuario demo
            currentUser = { name: "Usuario Prueba", username: "prueba", email: "p@p.com", phone: "09", contacts: [], shipments: [], points: 0 };
            users = [currentUser]; // Asegurar que 'users' tenga algo

            if (msgArea) showMessage(msgArea, "Login simulado exitoso. Mostrando dashboard...", "success");
            showDashboardView(); // Necesita estar definida
        };

        window.showRegisterView = function() { showView(registerContainer); }; // Mínimo para el link
        window.showLoginLinkAction = function() { showView(loginContainer); }; // Para el link "ya tienes cuenta"

        window.showDashboardView = function() {
            if (!currentUser) { // Aunque aquí currentUser se simula en handleLogin
                console.warn("showDashboardView: currentUser es nulo. Redirigiendo a login.");
                showView(loginContainer); // Volver al login si no hay usuario
                return;
            }
            showView(dashboardContainer);
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) welcomeMsg.innerHTML = `Bienvenido/a (simulado), <strong>${currentUser.name}</strong>!`;
            console.log("Mostrando Dashboard (simulado).");
        };

        // Asignar listeners básicos
        document.getElementById('loginButton').addEventListener('click', handleLogin);
        document.getElementById('showRegisterLink').addEventListener('click', (e) => { e.preventDefault(); showRegisterView(); });
        document.getElementById('showLoginLink').addEventListener('click', (e) => { e.preventDefault(); showLoginLinkAction(); }); // Link en registro

        // Añadir aquí listeners para otros botones principales si se van a probar (ej. logoutButton)
        const logoutBtn = document.getElementById('logoutButton');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                currentUser = null;
                showView(loginContainer);
                console.log("Logout (simulado).");
            });
        }

        console.log("DOMContentLoaded: Finalizado.");
    });
    </script>
</body>
</html>
